---
title: "Plotting global models' inputs"
author: "Camilla Novaglio & Derek Tittensor"
date: "02/02/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script analysis Earth System Models' outputs used as inputs for Marine Ecosystem Models. It is structured in two steps:
Step 1 extracts environmental variables (temperature, PP, phytoplankton and zooplankton) from ESMs netcdfs and collapses them into a time-averaged (1990s for the historical period and 2090s for future scenarios) spatial dataset (1 grid cell resolution).    
Step 2 averages the data across ESMs and scenarios and produces Figure 2 along with supplementary figures.  

# STEP 1 extract data

## Load libraries for netcdf and define variables

```{r load CMIP5}

rm(list=ls())

install_load <- function (this_package)  {   

   package <- c(this_package)
   if(package %in% rownames(installed.packages()))
        do.call('library', list(package))

    # if package is not installed locally, download, then load
    else {
        install.packages(package)
         do.call("library", list(package))
    }
}

### load/install libraries ###
install_load("grid")
install_load("zoo")
install_load("viridis")
install_load("tidyr")
install_load("dplyr")
install_load("ncdf4")
install_load("ggplot2")
install_load("patchwork")

### load helper scripts with functions to extract data from netcdfs ###
source("R/HelperScripts.r")
source("R/Funcs_maps.r")

### create folders where temporary data can be stored ###
mainDir = "../CMIP5vsCMIP6_data/"
DirStep1 = "temp_data"
ifelse(!dir.exists(file.path(mainDir, DirStep1)), dir.create(file.path(mainDir, DirStep1)), FALSE)

### define variables to extract ###
cmip<-c("CMIP5", "CMIP6")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")

### create folders where figures can be saved ###
mainDir = "../CMIP5vsCMIP6_data/"
DirStep2 = "figures"
ifelse(!dir.exists(file.path(mainDir, DirStep2)), dir.create(file.path(mainDir, DirStep2)), FALSE)
save_loc<-"../CMIP5vsCMIP6_data/figures/"

```

## Load libraries for plotting and define criteria 

```{r}

### Define color/legend limits ###
main_plot_colour_values_tos = c(0,30) # C   
main_plot_colour_values_pp = c(0,1) # g C m-2 d-1 
main_plot_colour_values_phyto = c(0, 4) # g C m-2 
main_plot_colour_values_zoo = c(0, 4) # g C m-2 
delta_plot_colour_values = c(-50,50)

#### define color schemes ###
colour_scheme1 <- c(low = 'white', mid = "skyblue1",  high = 'royalblue1') # for statistics - e.g model mean
colour_scheme2 <- c(low = 'red', mid = "white",  high = 'royalBlue1') # for % changes
colour_scheme3 <- c("#fdb863", "#f7f7f7","#b2abd2") # for delta plots
colour_scheme4 <- c(low = 'white', mid = "#9ebcda",  high = '#8856a7') # for inputs values 

### Download and process world outline ###
install_load("sf")
install_load("rnaturalearth")
install_load("rgeos")
world <- ne_countries(scale = "medium", returnclass = "sf")
robCRS <- CRS("+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
world_sf <- st_transform(world, crs = st_crs(robCRS)) 

### other mapping libraries ####
install_load("raster")
install_load("maptools")
install_load("RColorBrewer")
install_load("scales")

```

## Load ISIMIP2b inputs 

```{r}

# extract data IPSL ---- 

directory = "../CMIP5vsCMIP6_data/fishmip_inputs/marine-fishery_global_ISIMIP2b/IPSL_CM5A_LR/"

variable_to_extract <-c("to", "pp", "phy", "zoo")

yearmonth1<- as.yearmon("1990-01")
yearmonth2<- as.yearmon("1999-01") 

yearmonth1_fut<- as.yearmon("2090-01")
yearmonth2_fut<- as.yearmon("2099-01")

data_ipsl_CMIP5<-list()

for (i in 1:length(variable_to_extract)){

  # extract temperature and convert from K to C
  if(variable_to_extract[[i]] == "to"){
    
    filename<-paste0(variable_to_extract[i], ".nc4.zs.rgrd.v3.historical1_19500101_20051231_1Y.nc4")
    hist<- averageEnvironmentalCDF(directory, filename, variable_to_extract[i], yearmonth1, yearmonth2, average_whole_period = TRUE, ipsl = TRUE, hist = TRUE)
    
    # from k to C
    hist$fishvar<-hist$fishvar - 273.15 
    hist$data_units<-"C"
  
    filename<-paste0(variable_to_extract[i],".nc4.zs.rgrd.v3.rcp261_20060101_21001231_1Y.nc4")
    fut126<-averageEnvironmentalCDF(directory, filename , variable_to_extract[i], yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = TRUE, hist = FALSE)
    fut126$fishvar<-fut126$fishvar - 273.15
    fut126$data_units<-"C"
  
    filename<-paste0(variable_to_extract[i],".nc4.zs.rgrd.v3.rcp851_20060101_21001231_1Y.nc4")
    fut585<- averageEnvironmentalCDF(directory, filename , variable_to_extract[i], yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = TRUE, hist = FALSE)
    fut585$fishvar<-fut585$fishvar - 273.15
    fut126$data_units<-"C"

    # do celsius change 
    diff_2p6 = fut126$fishvar - hist$fishvar # 20C - 15C = 5C (celsius increase)
    diff_8p5 = fut585$fishvar - hist$fishvar
  
  }else{ # extract small and large PP, phy or zoo and sum the size classes
    
      filename<-paste0("s",variable_to_extract[i], ".nc4.zint.rgrd.v3.historical1_19500101_20051231_1Y.nc4")
      histS<- averageEnvironmentalCDF(directory, filename , paste0("s", variable_to_extract[i]), yearmonth1, yearmonth2, average_whole_period = TRUE, ipsl = TRUE, hist = TRUE)
      
      filename<-paste0("l",variable_to_extract[i], ".nc4.zint.rgrd.v3.historical1_19500101_20051231_1Y.nc4")
      histL<- averageEnvironmentalCDF(directory, filename , paste0("l", variable_to_extract[i]), yearmonth1, yearmonth2, average_whole_period = TRUE, ipsl = TRUE, hist = TRUE)
      hist<-histS
      hist$fishvar<-hist$fishvar+histL$fishvar 
      
      hist$fishvar<-hist$fishvar * 12 
      hist$data_units<-paste0(hist$data_units, " CN converted in g C")
 
      filename<-paste0("s",variable_to_extract[i],".nc4.zint.rgrd.v3.rcp26.1_20060101_21001231_1Y.nc4")
      fut126S<-averageEnvironmentalCDF(directory, filename , paste0("s", variable_to_extract[i]), yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = TRUE, hist = FALSE)
      
      filename<-paste0("l",variable_to_extract[i],".nc4.zint.rgrd.v3.rcp26.1_20060101_21001231_1Y.nc4")
      fut126L<-averageEnvironmentalCDF(directory, filename , paste0("l", variable_to_extract[i]), yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = TRUE, hist = FALSE)
      fut126<-fut126S
      fut126$fishvar<-fut126$fishvar+fut126L$fishvar 
      
      fut126$fishvar<-fut126$fishvar * 12 
      fut126$data_units<-paste0(fut126$data_units, " CN converted in g C")
      
      filename<-paste0("s",variable_to_extract[i],".nc4.zint.rgrd.v3.rcp85.1_20060101_21001231_1Y.nc4")
      fut585S<-averageEnvironmentalCDF(directory, filename , paste0("s", variable_to_extract[i]), yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = TRUE, hist = FALSE)
      
      filename<-paste0("l",variable_to_extract[i],".nc4.zint.rgrd.v3.rcp85.1_20060101_21001231_1Y.nc4")
      fut585L<-averageEnvironmentalCDF(directory, filename , paste0("l", variable_to_extract[i]), yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = TRUE, hist = FALSE)
      
      fut585<-fut585S
      fut585$fishvar<-fut585$fishvar+fut585L$fishvar 
      
      fut585$fishvar<-fut585$fishvar * 12 
      fut585$data_units<-paste0(fut585$data_units, " CN converted in g C")
      
      if(variable_to_extract[i] == "pp"){
        hist$fishvar<-hist$fishvar / 0.0000115741
        hist$data_units<-paste0(hist$data_units, " CN converted in d-1") 
        fut126$fishvar<-fut126$fishvar / 0.0000115741
        fut126$data_units<-paste0(fut126$data_units, " CN converted in d-1") 
        fut585$fishvar<-fut585$fishvar / 0.0000115741
        fut585$data_units<-paste0(fut585$data_units, " CN converted in d-1") 
      }
      
      # (mean(hist$fishvar, na.rm = TRUE)/0.0000115741)*1000 # mg / day  
      # (mean(hist$fishvar, na.rm = TRUE)/3.1709791983765e-8) # g / year 
      # (mean(hist$fishvar, na.rm = TRUE)/0.0000115741) # g / days 
      
      diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
      diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100
    
  }
  
  data_ipsl_CMIP5[[i]]<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)
  names(data_ipsl_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  rm(hist, fut126, fut585, diff_2p6, diff_8p5)
  
}

# extract data GFDL ---- 

directory = "../CMIP5vsCMIP6_data/fishmip_inputs/marine-fishery_global_ISIMIP2b/GFDL_ESM2M/"

variable_to_extract <-c("to", "pp", "phy", "zoo")

# consider names withing netcdf  
variable_to_extract2 <-c("TO_ZS", "PP_ZINT", "PHY_ZINT", "ZOO_ZINT")

data_gfdl_CMIP5<-list()

for (i in 1:length(variable_to_extract)){

  if(variable_to_extract[[i]] == "to"){
    
    filename<-paste0(variable_to_extract[i], "_gfdl-esm2m_historical_zs_annual_195001-200512.nc4")
    hist<- averageEnvironmentalCDF(directory, filename , variable_to_extract2[i], yearmonth1, yearmonth2, average_whole_period = TRUE, ipsl = FALSE, hist = TRUE)
    # from k to C
    hist$fishvar<-hist$fishvar - 273.15 
    hist$data_units<-"C"
  
    filename<-paste0(variable_to_extract[i],"_gfdl-esm2m_rcp26_zs_annual_200601-210012.nc4")
    fut126<-averageEnvironmentalCDF(directory, filename , variable_to_extract2[i], yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = FALSE, hist = FALSE)
    fut126$fishvar<-fut126$fishvar - 273.15
    fut126$data_units<-"C"
  
    filename<-paste0(variable_to_extract[i],"_gfdl-esm2m_rcp85_zs_annual_200601-210012.nc4")
    fut585<- averageEnvironmentalCDF(directory, filename , variable_to_extract2[i], yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = FALSE, hist = FALSE)
    fut585$fishvar<-fut585$fishvar - 273.15
    fut126$data_units<-"C"
    
    # do celsius change 
    diff_2p6 = fut126$fishvar - hist$fishvar # 20C - 15C = 5C (celsius increase)
    diff_8p5 = fut585$fishvar - hist$fishvar
  
  }else{ 
    
      filename<-paste0("s",variable_to_extract[i], "_gfdl-esm2m_historical_zint_annual_195001-200512.nc4")
      histS<- averageEnvironmentalCDF(directory, filename , paste0("S", variable_to_extract2[i]), yearmonth1, yearmonth2, average_whole_period = TRUE, ipsl = FALSE, hist = TRUE)
      filename<-paste0("l",variable_to_extract[i], "_gfdl-esm2m_historical_zint_annual_195001-200512.nc4")
      histL<- averageEnvironmentalCDF(directory, filename , paste0("L", variable_to_extract2[i]), yearmonth1, yearmonth2, average_whole_period = TRUE, ipsl = FALSE, hist = TRUE)
      hist<-histS
      hist$fishvar<-hist$fishvar+histL$fishvar 
      
      hist$fishvar<-hist$fishvar * 12 
      hist$data_units<-paste0(hist$data_units, " CN converted in g C")
 
      filename<-paste0("s",variable_to_extract[i],"_gfdl-esm2m_rcp26_zint_annual_200601-210012.nc4")
      fut126S<-averageEnvironmentalCDF(directory, filename , paste0("S", variable_to_extract2[i]), yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = FALSE, hist = FALSE)
      filename<-paste0("l",variable_to_extract[i],"_gfdl-esm2m_rcp26_zint_annual_200601-210012.nc4")
      fut126L<-averageEnvironmentalCDF(directory, filename , paste0("L", variable_to_extract2[i]), yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = FALSE, hist = FALSE)
      fut126<-fut126S
      fut126$fishvar<-fut126$fishvar+fut126L$fishvar 
      
      fut126$fishvar<-fut126$fishvar * 12 
      fut126$data_units<-paste0(fut126$data_units, " CN converted in g C")
      
      filename<-paste0("s",variable_to_extract[i],"_gfdl-esm2m_rcp85_zint_annual_200601-210012.nc4")
      fut585S<-averageEnvironmentalCDF(directory, filename , paste0("S", variable_to_extract2[i]), yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = FALSE, hist = FALSE)
      filename<-paste0("l",variable_to_extract[i],"_gfdl-esm2m_rcp85_zint_annual_200601-210012.nc4")
      fut585L<-averageEnvironmentalCDF(directory, filename , paste0("L", variable_to_extract2[i]), yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, ipsl = FALSE, hist = FALSE)
  
      fut585<-fut585S
      fut585$fishvar<-fut585$fishvar+fut585L$fishvar 
      fut585$fishvar<-fut585$fishvar * 12 
      fut585$data_units<-paste0(fut585$data_units, " CN converted in g C")
      
      if(variable_to_extract[i] == "pp"){
        hist$fishvar<-hist$fishvar / 0.0000115741
        hist$data_units<-paste0(hist$data_units, " CN converted in d-1") 
        fut126$fishvar<-fut126$fishvar / 0.0000115741
        fut126$data_units<-paste0(fut126$data_units, " CN converted in d-1") 
        fut585$fishvar<-fut585$fishvar / 0.0000115741
        fut585$data_units<-paste0(fut585$data_units, " CN converted in d-1") 
      }
      
      diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
      diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100
    
  }
  
  data_gfdl_CMIP5[[i]]<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)
  names(data_gfdl_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  rm(hist, fut126, fut585, diff_2p6, diff_8p5)
  
}

```

## Plot ISIMIP2b inputs

```{r map CMIP6}

# function to flip matrix if needed

fliplr_matrix<- function(data_to_flip){
  temp= data_to_flip
  for (ii in 1:dim(data_to_flip)[2])
    data_to_flip[,ii] = temp[,dim(data_to_flip)[2] - ii + 1]
  
  data_to_flip
}


# function to move hemisphere if needed 

move_hemispheres<- function(data_to_flip){
  temp= data_to_flip
  data_to_flip[1:180,] = temp[181:360,]
  data_to_flip[181:360,] = temp[1:180,]
  data_to_flip
}
  
## plot IPSL ----

data_ipsl_CMIP5$to$diff_8p5<- fliplr_matrix(data_ipsl_CMIP5$to$diff_8p5)
data_ipsl_CMIP5$to$diff_8p5<- move_hemispheres(data_ipsl_CMIP5$to$diff_8p5)

data_ipsl_CMIP5$to$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP5$to$fut585$fishvar)
data_ipsl_CMIP5$to$fut585$fishvar<- move_hemispheres(data_ipsl_CMIP5$to$fut585$fishvar)
data_ipsl_CMIP5$to$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP5$to$hist$fishvar)
data_ipsl_CMIP5$to$hist$fishvar<- move_hemispheres(data_ipsl_CMIP5$to$hist$fishvar)

data_ipsl_CMIP5$pp$diff_8p5<- fliplr_matrix(data_ipsl_CMIP5$pp$diff_8p5)
data_ipsl_CMIP5$pp$diff_8p5<- move_hemispheres(data_ipsl_CMIP5$pp$diff_8p5)
data_ipsl_CMIP5$pp$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP5$pp$fut585$fishvar)
data_ipsl_CMIP5$pp$fut585$fishvar<- move_hemispheres(data_ipsl_CMIP5$pp$fut585$fishvar)
data_ipsl_CMIP5$pp$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP5$pp$hist$fishvar)
data_ipsl_CMIP5$pp$hist$fishvar<- move_hemispheres(data_ipsl_CMIP5$pp$hist$fishvar)

data_ipsl_CMIP5$phy$diff_8p5<- fliplr_matrix(data_ipsl_CMIP5$phy$diff_8p5)
data_ipsl_CMIP5$phy$diff_8p5<- move_hemispheres(data_ipsl_CMIP5$phy$diff_8p5)
data_ipsl_CMIP5$phy$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP5$phy$fut585$fishvar)
data_ipsl_CMIP5$phy$fut585$fishvar<- move_hemispheres(data_ipsl_CMIP5$phy$fut585$fishvar)
data_ipsl_CMIP5$phy$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP5$phy$hist$fishvar)
data_ipsl_CMIP5$phy$hist$fishvar<- move_hemispheres(data_ipsl_CMIP5$phy$hist$fishvar)

data_ipsl_CMIP5$zoo$diff_8p5<- fliplr_matrix(data_ipsl_CMIP5$zoo$diff_8p5)
data_ipsl_CMIP5$zoo$diff_8p5<- move_hemispheres(data_ipsl_CMIP5$zoo$diff_8p5)
data_ipsl_CMIP5$zoo$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP5$zoo$fut585$fishvar)
data_ipsl_CMIP5$zoo$fut585$fishvar<- move_hemispheres(data_ipsl_CMIP5$zoo$fut585$fishvar)
data_ipsl_CMIP5$zoo$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP5$zoo$hist$fishvar)
data_ipsl_CMIP5$zoo$hist$fishvar<- move_hemispheres(data_ipsl_CMIP5$zoo$hist$fishvar)

titles<-c("Sea surface temperature", "Net primary production","Phytoplankton carbon","Zooplankton carbon")
coltitles<-c("C", "g C m-2 d-1","g C m-2","g C m-2") 
data_ipsl_CMIP5$to$hist$data_units
data_ipsl_CMIP5$pp$hist$data_units
data_ipsl_CMIP5$phy$hist$data_units
data_ipsl_CMIP5$zoo$hist$data_units

color<-list(main_plot_colour_values_tos, main_plot_colour_values_pp, main_plot_colour_values_phyto, main_plot_colour_values_zoo) 
num_dp_variables<-c(0,1,0,0)

## plot GFDL ----

data_gfdl_CMIP5$to$diff_8p5<- fliplr_matrix(data_gfdl_CMIP5$to$diff_8p5)
data_gfdl_CMIP5$to$diff_8p5<- move_hemispheres(data_gfdl_CMIP5$to$diff_8p5)

data_gfdl_CMIP5$to$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP5$to$fut585$fishvar)
data_gfdl_CMIP5$to$fut585$fishvar<- move_hemispheres(data_gfdl_CMIP5$to$fut585$fishvar)
data_gfdl_CMIP5$to$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP5$to$hist$fishvar)
data_gfdl_CMIP5$to$hist$fishvar<- move_hemispheres(data_gfdl_CMIP5$to$hist$fishvar)

data_gfdl_CMIP5$pp$diff_8p5<- fliplr_matrix(data_gfdl_CMIP5$pp$diff_8p5)
data_gfdl_CMIP5$pp$diff_8p5<- move_hemispheres(data_gfdl_CMIP5$pp$diff_8p5)
data_gfdl_CMIP5$pp$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP5$pp$fut585$fishvar)
data_gfdl_CMIP5$pp$fut585$fishvar<- move_hemispheres(data_gfdl_CMIP5$pp$fut585$fishvar)
data_gfdl_CMIP5$pp$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP5$pp$hist$fishvar)
data_gfdl_CMIP5$pp$hist$fishvar<- move_hemispheres(data_gfdl_CMIP5$pp$hist$fishvar)

data_gfdl_CMIP5$phy$diff_8p5<- fliplr_matrix(data_gfdl_CMIP5$phy$diff_8p5)
data_gfdl_CMIP5$phy$diff_8p5<- move_hemispheres(data_gfdl_CMIP5$phy$diff_8p5)
data_gfdl_CMIP5$phy$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP5$phy$fut585$fishvar)
data_gfdl_CMIP5$phy$fut585$fishvar<- move_hemispheres(data_gfdl_CMIP5$phy$fut585$fishvar)
data_gfdl_CMIP5$phy$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP5$phy$hist$fishvar)
data_gfdl_CMIP5$phy$hist$fishvar<- move_hemispheres(data_gfdl_CMIP5$phy$hist$fishvar)

data_gfdl_CMIP5$zoo$diff_8p5<- fliplr_matrix(data_gfdl_CMIP5$zoo$diff_8p5)
data_gfdl_CMIP5$zoo$diff_8p5<- move_hemispheres(data_gfdl_CMIP5$zoo$diff_8p5)
data_gfdl_CMIP5$zoo$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP5$zoo$fut585$fishvar)
data_gfdl_CMIP5$zoo$fut585$fishvar<- move_hemispheres(data_gfdl_CMIP5$zoo$fut585$fishvar)
data_gfdl_CMIP5$zoo$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP5$zoo$hist$fishvar)
data_gfdl_CMIP5$zoo$hist$fishvar<- move_hemispheres(data_gfdl_CMIP5$zoo$hist$fishvar)

```

## Model average for CMIP5 and plots

```{r}

# function to calculate mean across ESMs 

model_stat<-function(data, variable){

  X <- lapply(data, `[[`, variable)
  
  if (variable != "diff_8p5"){
    X <- lapply(X, `[[`, 'fishvar')
  }
  
  X <- lapply(X, function(x) replace(x, !is.finite(x), NA))
  Y <- do.call(cbind, X)
  Y <- array(Y, dim=c(dim(X[[1]]), length(X)))
  model_average_new<-apply(Y, c(1, 2), mean, na.rm = TRUE)

  return(list(model_average = model_average_new))
}

data_average_change_CMIP5<-list()
data_average_value_2000_CMIP5<-list()
data_average_value_2100_CMIP5<-list()

for(i in 1:length(data_ipsl_CMIP5)){
  
  data_average_change_CMIP5[[i]]<-model_stat(list(data_ipsl_CMIP5[[i]], data_gfdl_CMIP5[[i]]), variable = 'diff_8p5')$model_average
  names(data_average_change_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  data_average_value_2000_CMIP5[[i]]<-model_stat(list(data_ipsl_CMIP5[[i]], data_gfdl_CMIP5[[i]]), variable = 'hist')$model_average
  names(data_average_value_2000_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  data_average_value_2100_CMIP5[[i]]<-model_stat(list(data_ipsl_CMIP5[[i]], data_gfdl_CMIP5[[i]]), variable = 'fut585')$model_average
  names(data_average_value_2100_CMIP5)[[i]]<-variable_to_extract[[i]]
  
}

# plot earth models average for all input variables

delta_plot_colour_values_new<-list(c(0,4), delta_plot_colour_values, delta_plot_colour_values, delta_plot_colour_values)
coltitles1<-list("Change \n(°C)", "Change \n(%)", "Change \n(%)", "Change \n(%)")
colour_scheme_vary<-list(c(low = "white", mid = '#fee5d9', high = "#de2d26"),colour_scheme2,colour_scheme2,colour_scheme2) 

map_average_change_CMIP5<-list()
map_average_value_2000_CMIP5<-list()
map_average_value_2100_CMIP5<-list()

for (i in 1:length(data_average_change_CMIP5)){ 
  
  tit <- paste("Mean change in", titles[[i]], "RCP 8.5, 1990s to 2090s",cmip[1], sep =" ")
  map_average_change_CMIP5[[i]]<-plot_FISH_MIP(data_average_change_CMIP5[[i]], tit, delta_plot_colour_values_new[[i]], colour_scheme = colour_scheme_vary[[i]], coltitle = coltitles1[[i]], model_type = NA)
  names(map_average_change_CMIP5)[[i]]<-variable_to_extract[[i]]

  tit <- paste("Mean", titles[[i]], "across IPSL and GFDL RCP 8.5, 1990s", cmip[1], sep =" ")
  map_average_value_2000_CMIP5[[i]]<-plot_FISH_MIP(data_average_value_2000_CMIP5[[i]], tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_average_value_2000_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  tit <- paste("Mean", titles[[i]], "across IPSL and GFDL RCP 8.5, 2090s", cmip[1], sep =" ")
  map_average_value_2100_CMIP5[[i]]<-plot_FISH_MIP(data_average_value_2100_CMIP5[[i]], tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_average_value_2100_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  rm(tit)
  
}

```

## Save temporary outputs ISIMIP2b 

```{r}

data_summaries_CMIP5<-list(data_average_change_CMIP5 = data_average_change_CMIP5, data_average_value_2000_CMIP5 = data_average_value_2000_CMIP5, data_average_value_2100_CMIP5 = data_average_value_2100_CMIP5)

map_summaries_CMIP5<-list(map_average_change_CMIP5 = map_average_change_CMIP5, map_average_value_2000_CMIP5 = map_average_value_2000_CMIP5, map_average_value_2000_CMIP5 = map_average_value_2000_CMIP5) 

# save(data_ipsl_CMIP5, data_gfdl_CMIP5, data_summaries_CMIP5, map_summaries_CMIP5, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_inputs_CMIP5.RData")

save(data_ipsl_CMIP5, data_gfdl_CMIP5, data_summaries_CMIP5, map_summaries_CMIP5, file = "../CMIP5vsCMIP6_data/temp_data/data_inputs_CMIP5.RData")

```

## Load ISIMIP3b inputs 

```{r}

# CMIP6 data location

directory = "../CMIP5vsCMIP6_data/fishmip_inputs/marine-fishery_global_ISIMIP3b/"

# extract data IPSL ---- 

variable_to_extract <-c("to", "pp", "phy", "zoo") 
variable_to_extract3 <-c("tos", "intpp", "phyc-vint", "zooc-vint")

yearmonth1<- as.yearmon("1990-01")
yearmonth2<- as.yearmon("1999-12") 

yearmonth1_fut<- as.yearmon("2090-01")
yearmonth2_fut<- as.yearmon("2099-12")

data_ipsl_CMIP6<-list()

for (i in 1:length(variable_to_extract3)){

  filename<-paste0("ipsl-cm6a-lr_r1i1p1f1_historical_", variable_to_extract3[i],"_onedeg_global_monthly_1850_2014.nc")
  
  hist<- averageEnvironmentalCDF(directory, filename , variable_to_extract3[i], yearmonth1, yearmonth2, average_whole_period = TRUE, hist = TRUE, cmip = 6)
  
  filename<-paste0("ipsl-cm6a-lr_r1i1p1f1_ssp126_", variable_to_extract3[i],"_onedeg_global_monthly_2015_2100.nc")
  
  fut126<-averageEnvironmentalCDF(directory, filename , variable_to_extract3[i], yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, hist = FALSE, cmip = 6)
  
  filename<-paste0("ipsl-cm6a-lr_r1i1p1f1_ssp585_", variable_to_extract3[i],"_onedeg_global_monthly_2015_2100.nc")
  
  fut585<- averageEnvironmentalCDF(directory, filename , variable_to_extract3[i], yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, hist = FALSE, cmip = 6)
  
  if (variable_to_extract3[[i]] == "tos"){
    # do celsius change 
    diff_2p6 = fut126$fishvar - hist$fishvar # 20C - 15C = 5C (celsius increase)
    diff_8p5 = fut585$fishvar - hist$fishvar
  }else {
    
    hist$fishvar<-hist$fishvar * 12 
    hist$data_units<-paste0(hist$data_units, " CN converted in g C")
    fut126$fishvar<-fut126$fishvar * 12 
    fut126$data_units<-paste0(fut126$data_units, " CN converted in g C")
    fut585$fishvar<-fut585$fishvar * 12 
    fut585$data_units<-paste0(fut585$data_units, " CN converted in g C")
      
    if(variable_to_extract3[[i]] == "intpp"){
      hist$fishvar<-hist$fishvar / 0.0000115741
      hist$data_units<-paste0(hist$data_units, " CN converted in d-1") 
      fut126$fishvar<-fut126$fishvar / 0.0000115741
      fut126$data_units<-paste0(fut126$data_units, " CN converted in d-1") 
      fut585$fishvar<-fut585$fishvar / 0.0000115741
      fut585$data_units<-paste0(fut585$data_units, " CN converted in d-1") 
    }

    diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
    diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100
  }
  
  data_ipsl_CMIP6[[i]]<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)
  names(data_ipsl_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  rm(hist, fut126, fut585, diff_2p6, diff_8p5)
 
}

# extract data GFDL ---- 

data_gfdl_CMIP6<-list()

for (i in 1:length(variable_to_extract3)){

  filename<-paste0("gfdl-esm4_r1i1p1f1_historical_", variable_to_extract3[i],"_onedeg_global_monthly_1850_2014.nc")
  
  hist<- averageEnvironmentalCDF(directory, filename , variable_to_extract3[i], yearmonth1, yearmonth2, average_whole_period = TRUE, hist = TRUE, cmip = 6)
  
  filename<-paste0("gfdl-esm4_r1i1p1f1_ssp126_", variable_to_extract3[i],"_onedeg_global_monthly_2015_2100.nc")
  
  fut126<- averageEnvironmentalCDF(directory, filename , variable_to_extract3[i], yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, hist = FALSE, cmip = 6)
  
  filename<-paste0("gfdl-esm4_r1i1p1f1_ssp585_", variable_to_extract3[i],"_onedeg_global_monthly_2015_2100.nc")
  
  fut585<- averageEnvironmentalCDF(directory, filename , variable_to_extract3[i], yearmonth1_fut, yearmonth2_fut, average_whole_period = TRUE, hist = FALSE, cmip = 6)
  
  if (variable_to_extract3[[i]] == "tos"){
    # do celsius change 
    diff_2p6 = fut126$fishvar - hist$fishvar # 20C - 15C = 5C (celsius increase)
    diff_8p5 = fut585$fishvar - hist$fishvar
  }else {
    
    hist$fishvar<-hist$fishvar * 12 
    hist$data_units<-paste0(hist$data_units, " CN converted in g C")
    fut126$fishvar<-fut126$fishvar * 12 
    fut126$data_units<-paste0(fut126$data_units, " CN converted in g C")
    fut585$fishvar<-fut585$fishvar * 12 
    fut585$data_units<-paste0(fut585$data_units, " CN converted in g C")
      
    if(variable_to_extract3[[i]] == "intpp"){
      hist$fishvar<-hist$fishvar / 0.0000115741
      hist$data_units<-paste0(hist$data_units, " CN converted in d-1") 
      fut126$fishvar<-fut126$fishvar / 0.0000115741
      fut126$data_units<-paste0(fut126$data_units, " CN converted in d-1") 
      fut585$fishvar<-fut585$fishvar / 0.0000115741
      fut585$data_units<-paste0(fut585$data_units, " CN converted in d-1") 
    }

    diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
    diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100
  }
  
  data_gfdl_CMIP6[[i]]<-list(hist = hist, fut126 = fut126,  fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)
  names(data_gfdl_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  rm(hist, fut126, fut585, diff_2p6, diff_8p5)
 
}

```

## Plot ISIMIP3b inputs

```{r map CMIP6}

## plot GFDL ----

# checked: different data layout do not effect the calculation of model mean, SD and agreements because these are calculated after flipping the matrix and/or changing the hemisphere. It does not effect the calculation of trends because first biomass is weighted by grid cell according to explicit lat values and then it is averadged by lat and long anyway.

data_gfdl_CMIP6$to$diff_8p5<- fliplr_matrix(data_gfdl_CMIP6$to$diff_8p5)
data_gfdl_CMIP6$to$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP6$to$fut585$fishvar)
data_gfdl_CMIP6$to$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP6$to$hist$fishvar)

data_gfdl_CMIP6$pp$diff_8p5<- fliplr_matrix(data_gfdl_CMIP6$pp$diff_8p5)
data_gfdl_CMIP6$pp$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP6$pp$fut585$fishvar)
data_gfdl_CMIP6$pp$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP6$pp$hist$fishvar)

data_gfdl_CMIP6$phy$diff_8p5<- fliplr_matrix(data_gfdl_CMIP6$phy$diff_8p5)
data_gfdl_CMIP6$phy$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP6$phy$fut585$fishvar)
data_gfdl_CMIP6$phy$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP6$phy$hist$fishvar)

data_gfdl_CMIP6$zoo$diff_8p5<- fliplr_matrix(data_gfdl_CMIP6$zoo$diff_8p5)
data_gfdl_CMIP6$zoo$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP6$zoo$fut585$fishvar)
data_gfdl_CMIP6$zoo$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP6$zoo$hist$fishvar)

```

## Model average for CMIP6 and plots

```{r}

data_average_change_CMIP6<-list()
data_average_value_2000_CMIP6<-list()
data_average_value_2100_CMIP6<-list()

for(i in 1:length(data_ipsl_CMIP6)){
  
  data_average_change_CMIP6[[i]]<-model_stat(list(data_ipsl_CMIP6[[i]], data_gfdl_CMIP6[[i]]), variable = 'diff_8p5')$model_average
  names(data_average_change_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  data_average_value_2000_CMIP6[[i]]<-model_stat(list(data_ipsl_CMIP6[[i]], data_gfdl_CMIP6[[i]]), variable = 'hist')$model_average
  names(data_average_value_2000_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  data_average_value_2100_CMIP6[[i]]<-model_stat(list(data_ipsl_CMIP6[[i]], data_gfdl_CMIP6[[i]]), variable = 'fut585')$model_average
  names(data_average_value_2100_CMIP6)[[i]]<-variable_to_extract[[i]]
  
}

# plot ESMs average for all input variables

map_average_change_CMIP6<-list()
map_average_value_2000_CMIP6<-list()
map_average_value_2100_CMIP6<-list()

for (i in 1:length(data_average_change_CMIP6)){ 
  
  tit <- paste("Mean change in", titles[[i]], "RCP 8.5, 1990s to 2090s",cmip[2], sep =" ")
  map_average_change_CMIP6[[i]]<-plot_FISH_MIP(data_average_change_CMIP6[[i]], tit, delta_plot_colour_values_new[[i]], colour_scheme = colour_scheme_vary[[i]], coltitle = coltitles1[[i]], model_type = NA)
  names(map_average_change_CMIP6)[[i]]<-variable_to_extract[[i]]

  tit <- paste("Mean", titles[[i]], "across IPSL and GFDL RCP 8.5, 1990s", cmip[2], sep =" ")
  map_average_value_2000_CMIP6[[i]]<-plot_FISH_MIP(data_average_value_2000_CMIP6[[i]], tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_average_value_2000_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  tit <- paste("Mean", titles[[i]], "across IPSL and GFDL RCP 8.5, 2090s", cmip[2], sep =" ")
  map_average_value_2100_CMIP6[[i]]<-plot_FISH_MIP(data_average_value_2100_CMIP6[[i]], tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_average_value_2100_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  rm(tit)
  
}

```

## Save temporary outputs ISIMIP3b 

```{r}

data_summaries_CMIP6<-list(data_average_change_CMIP6 = data_average_change_CMIP6, data_average_value_2000_CMIP6 = data_average_value_2000_CMIP6, data_average_value_2100_CMIP6 = data_average_value_2100_CMIP6)

map_summaries_CMIP6<-list(map_average_change_CMIP6 = map_average_change_CMIP6, map_average_value_2000_CMIP6 = map_average_value_2000_CMIP6, map_average_value_2000_CMIP6 = map_average_value_2000_CMIP6)

# save(data_ipsl_CMIP6, data_gfdl_CMIP6, data_summaries_CMIP6, map_summaries_CMIP6, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_inputs_CMIP6.RData")

save(data_ipsl_CMIP6, data_gfdl_CMIP6, data_summaries_CMIP6, map_summaries_CMIP6, file = "../CMIP5vsCMIP6_data/temp_data/data_inputs_CMIP6.RData")

```


# STEP 2 averadge and plot data

## Load data 

```{r}

rm(list=ls())

load("../CMIP5vsCMIP6_data/temp_data/data_inputs_CMIP5.RData")
load("../CMIP5vsCMIP6_data/temp_data/data_inputs_CMIP6.RData")

# getwd()
```

## Load libraries for netcdf and define variables

```{r load CMIP5}

install_load <- function (this_package)  {   

   package <- c(this_package)
   if(package %in% rownames(installed.packages()))
        do.call('library', list(package))

    # if package is not installed locally, download, then load
    else {
        install.packages(package)
         do.call("library", list(package))
    }
}

### load/install libraries ###
install_load("grid")
install_load("zoo")
install_load("viridis")
install_load("tidyr")
install_load("dplyr")
install_load("ncdf4")
install_load("patchwork")
install_load("ggplot2")

### load helper scripts with functions to extract data from netcdfs ###
source("R/HelperScripts.r")
source("R/Funcs_maps.r")

### define variables to extract ###
variable_to_extract <-c("to", "pp", "phy", "zoo")
titles<-c("Sea surface temperature", "Net primary production","Phytoplankton carbon","Zooplankton carbon")
coltitles<-c("°C", "g C m-2 d-1","g C m-2","g C m-2")

### create folders where figures can be saved ###
mainDir = "../CMIP5vsCMIP6_data/"
DirStep2 = "figures"
ifelse(!dir.exists(file.path(mainDir, DirStep2)), dir.create(file.path(mainDir, DirStep2)), FALSE)
save_loc<-"../CMIP5vsCMIP6_data/figures/"

# variables
cmip<-c("CMIP5", "CMIP6")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")

```

## Load libraries for plotting and define criteria 

```{r}

### see STEP 1 above ### 

### Define color/legend limits ###
main_plot_colour_values_tos = c(0,30) # C   
main_plot_colour_values_pp = c(0,1) # g C m-2 d-1 
main_plot_colour_values_phyto = c(0, 4) # g C m-2 
main_plot_colour_values_zoo = c(0, 4) # g C m-2 
delta_plot_colour_values = c(-50,50)

#### define color schemes ###
colour_scheme1 <- c(low = 'white', mid = "skyblue1",  high = 'royalblue1') # for statistics - e.g model mean
colour_scheme2 <- c(low = 'red', mid = "white",  high = 'royalBlue1') # for % changes
colour_scheme3 <- c("#fdb863", "#f7f7f7","#b2abd2") # for delta plots
colour_scheme4 <- c(low = '#e0ecf4', mid = "#9ebcda",  high = '#8856a7') # for inputs values 
colour_scheme4 <- c(low = 'white', mid = "#9ebcda",  high = '#8856a7') # for inputs values 

### Download and process world outline ###
install_load("sf")
install_load("rnaturalearth")
install_load("rgeos")
world <- ne_countries(scale = "medium", returnclass = "sf")
robCRS <- CRS("+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
world_sf <- st_transform(world, crs = st_crs(robCRS)) 

### other mapping libraries ####
install_load("raster")
install_load("maptools")
install_load("RColorBrewer")
install_load("scales")

```

## Delta plot 

```{r}

# Delta maps
delta_plot_colour_values_new2<-list(c(-2, 2), c(-30, 30), c(-30, 30), c(-30, 30)) 

delta_data<-list()
delta_map<-list()

coltitleDelta<-c("Difference \nin \nchange \n(°C)","Difference \nin \nchange \n(%)","Difference \nin \nchange \n(%)","Difference \nin \nchange \n(%)")

for(i in 1:length(data_summaries_CMIP6$data_average_change_CMIP6)){
  
  delta_data[[i]]<-data_summaries_CMIP6$data_average_change_CMIP6[[i]] - data_summaries_CMIP5$data_average_change_CMIP5[[i]]
  names(delta_data)[[i]]<-variable_to_extract[[i]]
  
  tit<-paste("Delta (CMIP6 change - CMIP5 change)", titles[[i]], sep =" ")
  delta_map[[i]]<-plot_FISH_MIP(delta_data[[i]], tit, delta_plot_colour_values_new2[[i]], colour_scheme = colour_scheme3, coltitle = coltitleDelta[[i]])  
  names(delta_map)[[i]]<-variable_to_extract[[i]]
  
}

```

## Fig 2 - maps of environmental variables 

```{r multipanel plot}

layout <- "
ABC
DEF
GHK
LMN
"

# a1<-map_summaries_CMIP5$map_average_change_CMIP5$to +  ggtitle("a) SST CMIP5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# a<-map_summaries_CMIP6$map_average_change_CMIP6$to +  ggtitle("b) SST CMIP6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# b<-delta_map$to +  ggtitle("c) SST change between CMIPs") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# 
# c1<-map_summaries_CMIP5$map_average_change_CMIP5$pp + ggtitle("d) NPP CMIP5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# c<-map_summaries_CMIP6$map_average_change_CMIP6$pp + ggtitle("e) NPP CMIP6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# d<-delta_map$pp + ggtitle("f) NPP change between CMIPs") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# 
# e<-map_summaries_CMIP5$map_average_change_CMIP5$phy +  ggtitle("g) Phytoplankton carbon CMIP5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# f<-map_summaries_CMIP6$map_average_change_CMIP6$phy + ggtitle("h) Phytoplankton carbon CMIP6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# g<-delta_map$phy + ggtitle("i) Phytoplankton carbon change between CMIPs") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# 
# h<-map_summaries_CMIP5$map_average_change_CMIP5$zoo +  ggtitle("j) Zooplankton carbon CMIP5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# i<-map_summaries_CMIP6$map_average_change_CMIP6$zoo + ggtitle("k) Zooplankton carbon CMIP6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# l<-delta_map$zoo+ ggtitle("l) Zooplankton carbon change between CMIPs") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

# resize Main Fig according to NCC guidelines 
theme_opts_new <- list(theme(plot.title = element_text(size=7, face = "bold", hjust = 0),
                             legend.title=element_text(size=7), 
                             legend.text=element_text(size=6), 
                             axis.text=element_text(size=5)
                             ))

# titles get overwritten 
tit = c("Change \n (°C)", "Difference \nin (°C) \nchange", "Change \n (%)", "Difference \nin (%) \nchange")

a1_res<-map_summaries_CMIP5$map_average_change_CMIP5$to +  ggtitle("a) SST CMIP5") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[1])) + theme_opts_new
a_res<-map_summaries_CMIP6$map_average_change_CMIP6$to +  ggtitle("b) SST CMIP6") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[1])) + theme_opts_new
b_res<-delta_map$to +  ggtitle("c) SST change between CMIPs") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new

c1_res<-map_summaries_CMIP5$map_average_change_CMIP5$pp + ggtitle("d) NPP CMIP5") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[3])) + theme_opts_new
c_res<-map_summaries_CMIP6$map_average_change_CMIP6$pp + ggtitle("e) NPP CMIP6") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[3])) + theme_opts_new
d_res<-delta_map$pp + ggtitle("f) NPP change between CMIPs") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[4])) + theme_opts_new

e_res<-map_summaries_CMIP5$map_average_change_CMIP5$phy +  ggtitle("g) Phytoplankton carbon CMIP5") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[3])) + theme_opts_new
f_res<-map_summaries_CMIP6$map_average_change_CMIP6$phy + ggtitle("h) Phytoplankton carbon CMIP6") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[3])) + theme_opts_new
g_res<-delta_map$phy + ggtitle("i) Phytoplankton carbon change between CMIPs") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[4])) + theme_opts_new

h_res<-map_summaries_CMIP5$map_average_change_CMIP5$zoo +  ggtitle("j) Zooplankton carbon CMIP5") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[3])) + theme_opts_new
i_res<-map_summaries_CMIP6$map_average_change_CMIP6$zoo + ggtitle("k) Zooplankton carbon CMIP6") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[3])) + theme_opts_new
l_res<-delta_map$zoo+ ggtitle("l) Zooplankton carbon change between CMIPs") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[4])) + theme_opts_new

pt<-a1_res + a_res + b_res +
  c1_res + c_res + d_res +
  e_res + f_res + g_res +
  h_res + i_res + l_res +
  plot_layout(design = layout)

# # pdf(paste0(save_loc,"Fig2.pdf"), height=5.5, width=7.086) # width can only be 180 mm if the fig is a 2 column one (7,086 inch)
# pdf(paste0(save_loc,"Fig2_flipped.pdf"), height=6.7, width=10.5) 
# pt
# dev.off()

# delete surplus legends 

a1_res_noLeg = a1_res + theme(legend.position = "none")
c1_res_noLeg = c1_res + theme(legend.position = "none")
e_res_noLeg = e_res + theme(legend.position = "none")
h_res_noLeg = h_res + theme(legend.position = "none")

pt<-a1_res_noLeg + a_res + b_res +
  c1_res_noLeg + c_res + d_res +
  e_res_noLeg + f_res + g_res +
  h_res_noLeg + i_res + l_res +
  plot_layout(design = layout)

# pdf(paste0(save_loc,"Fig2_flipped_lessLegends.pdf"), height=7, width=10.5) 
# pt
# dev.off()

# different layout 

layout <- "
AB
CD
EF
GH
KL
MN
"

theme_opts_new <- list(theme(plot.title = element_text(size=7, face = "bold", hjust = 0),
                             legend.title=element_text(size=7), 
                             legend.text=element_text(size=6), 
                             axis.text=element_text(size=5)
                             ))

# change titles 
tit = c("Change \n (°C)", "Change \n (%)", "Difference \nin (°C) \nchange", "Difference \nin (%) \nchange")

a1_res<-map_summaries_CMIP5$map_average_change_CMIP5$to +  ggtitle("a) SST CMIP5") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[1])) + theme_opts_new
a_res<-map_summaries_CMIP6$map_average_change_CMIP6$to +  ggtitle("b) SST CMIP6") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[1])) + theme_opts_new
c1_res = c1_res + ggtitle("c) NPP CMIP5")+ guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[2])) + theme_opts_new
c_res = c_res + ggtitle("d) NPP CMIP6")+ guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[2])) + theme_opts_new
e_res = e_res + ggtitle("e) Phytoplankton carbon CMIP5")+ guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[2])) + theme_opts_new
f_res = f_res + ggtitle("f) Phytoplankton carbon CMIP6")+ guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[2])) + theme_opts_new
h_res = h_res +  ggtitle("g) Zooplankton carbon CMIP5")+ guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[2])) + theme_opts_new
i_res = i_res + ggtitle("h) Zooplankton carbon CMIP6")+ guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[2])) + theme_opts_new
b_res = b_res + ggtitle("i) SST change between CMIPs") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[3])) + theme_opts_new
d_res = d_res + ggtitle("j) NPP change between CMIPs")+ guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[4])) + theme_opts_new 
g_res = g_res + ggtitle("k) Phytoplankton carbon change between CMIPs") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[4])) + theme_opts_new
l_res = l_res + ggtitle("l) Zooplankton carbon change between CMIPs") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 2, title = tit[4])) + theme_opts_new

pt2<-a1_res + a_res +
  c1_res + c_res + 
  e_res + f_res +
  h_res + i_res  +
  b_res + d_res +
  g_res + l_res +
  plot_layout(design = layout)

# pdf(paste0(save_loc,"Fig2_newLayout.pdf"), height=8.858, width=7.086) # max size possible 
# pt2
# dev.off()

# delete surplus legends 

a1_res_noLeg = a1_res + theme(legend.position = "none")
c1_res_noLeg = c1_res + theme(legend.position = "none")
e_res_noLeg = e_res + theme(legend.position = "none")
h_res_noLeg = h_res + theme(legend.position = "none")
b_res_noLeg = b_res + theme(legend.position = "none")
g_res_noLeg = g_res + theme(legend.position = "none")

pt2<-a1_res_noLeg + a_res +
  c1_res_noLeg + c_res + 
  e_res_noLeg + f_res +
  h_res_noLeg + i_res  +
  b_res_noLeg + d_res +
  g_res_noLeg + l_res +
  plot_layout(design = layout)

pdf(paste0(save_loc,"Fig2_newLayout_lessLegends.pdf"), height=8.858, width=6) # max size possible 
pt2
dev.off()

```

## Fig S1 and S2 - maps of environmental variables by ESM 

```{r}

delta_plot_colour_values_new<-list(c(0,4), delta_plot_colour_values, delta_plot_colour_values, delta_plot_colour_values)
coltitles1<-list("Change \n(°C)", "Change \n(%)", "Change \n(%)", "Change \n(%)")
colour_scheme_vary<-list(c(low = "white", mid = '#fee5d9', high = "#de2d26"),colour_scheme2,colour_scheme2,colour_scheme2) 
color<-list(main_plot_colour_values_tos, main_plot_colour_values_pp, main_plot_colour_values_phyto, main_plot_colour_values_zoo) 
num_dp_variables<-c(0,1,0,0)

map_ipsl_change_CMIP5<-list()
map_ipsl_value_2000_CMIP5<-list()
map_ipsl_value_2100_CMIP5<-list()

map_ipsl_change_CMIP5$to

for (i in 1:length(data_ipsl_CMIP5)){
    
  tit <- paste("Change in", titles[[i]], "IPSL RCP 8.5, 1990s to 2090s",cmip[1], sep =" ")
  map_ipsl_change_CMIP5[[i]]<-plot_FISH_MIP(data_ipsl_CMIP5[[i]]$diff_8p5, tit, delta_plot_colour_values_new[[i]], colour_scheme = colour_scheme_vary[[i]], coltitle = coltitles1[[i]], model_type = NA)
  names(map_ipsl_change_CMIP5)[[i]]<-variable_to_extract[[i]]

  tit <- paste(titles[[i]], "IPSL RCP 8.5, 1990s", cmip[1], sep =" ")
  map_ipsl_value_2000_CMIP5[[i]]<-plot_FISH_MIP(data_ipsl_CMIP5[[i]]$hist$fishvar, tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_ipsl_value_2000_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  tit <- paste(titles[[i]], "IPSL RCP 8.5, 2090s", cmip[1], sep =" ")
  map_ipsl_value_2100_CMIP5[[i]]<-plot_FISH_MIP(data_ipsl_CMIP5[[i]]$fut585$fishvar, tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_ipsl_value_2100_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  rm(tit)
  
}

map_gfdl_change_CMIP5<-list()
map_gfdl_value_2000_CMIP5<-list()
map_gfdl_value_2100_CMIP5<-list()

for (i in 1:length(data_gfdl_CMIP5)){
    
  tit <- paste("Change in", titles[[i]], "GFDL RCP 8.5, 1990s to 2090s",cmip[1], sep =" ")
  map_gfdl_change_CMIP5[[i]]<-plot_FISH_MIP(data_gfdl_CMIP5[[i]]$diff_8p5, tit, delta_plot_colour_values_new[[i]], colour_scheme = colour_scheme_vary[[i]], coltitle = coltitles1[[i]], model_type = NA)
  names(map_gfdl_change_CMIP5)[[i]]<-variable_to_extract[[i]]

  tit <- paste(titles[[i]], "GFDL RCP 8.5, 1990s", cmip[1], sep =" ")
  map_gfdl_value_2000_CMIP5[[i]]<-plot_FISH_MIP(data_gfdl_CMIP5[[i]]$hist$fishvar, tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_gfdl_value_2000_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  tit <- paste(titles[[i]], "GFDL RCP 8.5, 2090s", cmip[1], sep =" ")
  map_gfdl_value_2100_CMIP5[[i]]<-plot_FISH_MIP(data_gfdl_CMIP5[[i]]$fut585$fishvar, tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_gfdl_value_2100_CMIP5)[[i]]<-variable_to_extract[[i]]
  
  rm(tit)
  
}

map_ipsl_change_CMIP6<-list()
map_ipsl_value_2000_CMIP6<-list()
map_ipsl_value_2100_CMIP6<-list()

for (i in 1:length(data_ipsl_CMIP6)){
    
  tit <- paste("Change in", titles[[i]], "IPSL RCP 8.5, 1990s to 2090s",cmip[2], sep =" ")
  map_ipsl_change_CMIP6[[i]]<-plot_FISH_MIP(data_ipsl_CMIP6[[i]]$diff_8p5, tit, delta_plot_colour_values_new[[i]], colour_scheme = colour_scheme_vary[[i]], coltitle = coltitles1[[i]], model_type = NA)
  names(map_ipsl_change_CMIP6)[[i]]<-variable_to_extract[[i]]

  tit <- paste(titles[[i]], "IPSL RCP 8.5, 1990s", cmip[2], sep =" ")
  map_ipsl_value_2000_CMIP6[[i]]<-plot_FISH_MIP(data_ipsl_CMIP6[[i]]$hist$fishvar, tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_ipsl_value_2000_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  tit <- paste(titles[[i]], "IPSL RCP 8.5, 2090s", cmip[2], sep =" ")
  map_ipsl_value_2100_CMIP6[[i]]<-plot_FISH_MIP(data_ipsl_CMIP6[[i]]$fut585$fishvar, tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_ipsl_value_2100_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  rm(tit)
  
}

map_gfdl_change_CMIP6<-list()
map_gfdl_value_2000_CMIP6<-list()
map_gfdl_value_2100_CMIP6<-list()

for (i in 1:length(data_gfdl_CMIP6)){
    
  tit <- paste("Change in", titles[[i]], "GFDL RCP 8.5, 1990s to 2090s",cmip[2], sep =" ")
  map_gfdl_change_CMIP6[[i]]<-plot_FISH_MIP(data_gfdl_CMIP6[[i]]$diff_8p5, tit, delta_plot_colour_values_new[[i]], colour_scheme = colour_scheme_vary[[i]], coltitle = coltitles1[[i]], model_type = NA)
  names(map_gfdl_change_CMIP6)[[i]]<-variable_to_extract[[i]]

  tit <- paste(titles[[i]], "GFDL RCP 8.5, 1990s", cmip[2], sep =" ")
  map_gfdl_value_2000_CMIP6[[i]]<-plot_FISH_MIP(data_gfdl_CMIP6[[i]]$hist$fishvar, tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_gfdl_value_2000_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  tit <- paste(titles[[i]], "GFDL RCP 8.5, 2090s", cmip[2], sep =" ")
  map_gfdl_value_2100_CMIP6[[i]]<-plot_FISH_MIP(data_gfdl_CMIP6[[i]]$fut585$fishvar, tit, color[[i]], colour_scheme = colour_scheme4, coltitle = coltitles[[i]], model_type = NA, num_dp = num_dp_variables[[i]])
  names(map_gfdl_value_2100_CMIP6)[[i]]<-variable_to_extract[[i]]
  
  rm(tit)
  
}

### Fig S1 ####

layout <- "
ABC
DEF
GHK
LMN
"

# a1<-map_summaries_CMIP5$map_average_change_CMIP5$to +  ggtitle("c) SST CMIP5 ESMs average") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# a<-map_ipsl_change_CMIP5$to +  ggtitle("a) SST CMIP5 IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# b<-map_gfdl_change_CMIP5$to +  ggtitle("b) SST CMIP5 GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# 
# c1<-map_summaries_CMIP5$map_average_change_CMIP5$pp + ggtitle("f) NPP CMIP5 ESMs average") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# c<-map_ipsl_change_CMIP5$pp + ggtitle("d) NPP CMIP5 IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# d<-map_gfdl_change_CMIP5$pp + ggtitle("e) NPP CMIP5 GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# 
# e<-map_summaries_CMIP5$map_average_change_CMIP5$phy +  ggtitle("i) Phytoplankton carbon CMIP5 ESMs average") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# f<-map_ipsl_change_CMIP5$phy + ggtitle("g) Phytoplankton carbon CMIP5 IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# g<-map_gfdl_change_CMIP5$phy + ggtitle("h) Phytoplankton carbon CMIP5 GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# 
# h<-map_summaries_CMIP5$map_average_change_CMIP5$zoo +  ggtitle("l) Zooplankton carbon CMIP5 ESMs average") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# i<- map_ipsl_change_CMIP5$zoo + ggtitle("j) Zooplankton carbon CMIP5 IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# l<-map_gfdl_change_CMIP5$zoo+ ggtitle("k) Zooplankton carbon CMIP5 GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

# resize Fig according to NCC guidelines 
theme_opts_new <- list(theme(plot.title = element_text(size=7, face = "bold", hjust = 0),
                             legend.title=element_text(size=7), 
                             legend.text=element_text(size=6), 
                             axis.text=element_text(size=5)
                             ))

# titles get overwritten 
tit = c("Change \n (°C)", "Change \n (%)")

a1<-map_summaries_CMIP5$map_average_change_CMIP5$to + ggtitle("c) SST CMIP5 ESMs average") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[1])) + theme_opts_new
a<-map_ipsl_change_CMIP5$to +  ggtitle("a) SST CMIP5 IPSL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[1])) + theme_opts_new
b<-map_gfdl_change_CMIP5$to +  ggtitle("b) SST CMIP5 GFDL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[1])) + theme_opts_new

c1<-map_summaries_CMIP5$map_average_change_CMIP5$pp + ggtitle("f) NPP CMIP5 ESMs average") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
c<-map_ipsl_change_CMIP5$pp + ggtitle("d) NPP CMIP5 IPSL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
d<-map_gfdl_change_CMIP5$pp + ggtitle("e) NPP CMIP5 GFDL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new

e<-map_summaries_CMIP5$map_average_change_CMIP5$phy + ggtitle("i) Phytoplankton carbon CMIP5 ESMs average") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
f<-map_ipsl_change_CMIP5$phy + ggtitle("g) Phytoplankton carbon CMIP5 IPSL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
g<-map_gfdl_change_CMIP5$phy + ggtitle("h) Phytoplankton carbon CMIP5 GFDL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new

h<-map_summaries_CMIP5$map_average_change_CMIP5$zoo +  ggtitle("l) Zooplankton carbon CMIP5 ESMs average") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
i<- map_ipsl_change_CMIP5$zoo + ggtitle("j) Zooplankton carbon CMIP5 IPSL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
l<-map_gfdl_change_CMIP5$zoo+ ggtitle("k) Zooplankton carbon CMIP5 GFDL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new

pt<-a + b + a1 +
  c + d + c1 +
  f + g + e +
  i + l + h +
  plot_layout(design = layout)

pdf(paste0(save_loc,"FigS1_flipped.pdf"), height=6.7, width=10.5)
pt
dev.off()

# delete surplus legends 

a_noleg = a + theme(legend.position = "none")
c_noleg = c + theme(legend.position = "none")
f_noleg = f + theme(legend.position = "none")
i_noleg = i + theme(legend.position = "none")

b_noleg = b + theme(legend.position = "none")
d_noleg = d + theme(legend.position = "none")
g_noleg = g + theme(legend.position = "none")
l_noleg = l + theme(legend.position = "none")

pt<-a_noleg + b_noleg + a1 +
  c_noleg + d_noleg + c1 +
  f_noleg + g_noleg + e +
  i_noleg + l_noleg + h +
  plot_layout(design = layout)

pdf(paste0(save_loc,"FigS1_flipped_lessLegends.pdf"), height=7, width=10.5) 
pt
dev.off()

### Fig S2 ####

# a1<-map_summaries_CMIP6$map_average_change_CMIP6$to +  ggtitle("c) SST CMIP6 ESMs average") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# a<-map_ipsl_change_CMIP6$to +  ggtitle("a) SST CMIP6 IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# b<-map_gfdl_change_CMIP6$to +  ggtitle("b) SST CMIP6 GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# 
# c1<-map_summaries_CMIP6$map_average_change_CMIP6$pp + ggtitle("f) NPP CMIP6 ESMs average") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# c<-map_ipsl_change_CMIP6$pp + ggtitle("d) NPP CMIP6 IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# d<-map_gfdl_change_CMIP6$pp + ggtitle("e) NPP CMIP6 GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# 
# e<-map_summaries_CMIP6$map_average_change_CMIP6$phy +  ggtitle("i) Phytoplankton carbon CMIP6 ESMs average") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# f<-map_ipsl_change_CMIP6$phy + ggtitle("g) Phytoplankton carbon CMIP6 IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# g<-map_gfdl_change_CMIP6$phy + ggtitle("h) Phytoplankton carbon CMIP6 GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# 
# h<-map_summaries_CMIP6$map_average_change_CMIP6$zoo +  ggtitle("l) Zooplankton carbon CMIP6 ESMs average") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# i<- map_ipsl_change_CMIP6$zoo + ggtitle("j) Zooplankton carbon CMIP6 IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# l<-map_gfdl_change_CMIP6$zoo+ ggtitle("k) Zooplankton carbon CMIP6 GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

a1<-map_summaries_CMIP6$map_average_change_CMIP6$to +  ggtitle("c) SST CMIP6 ESMs average") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[1])) + theme_opts_new
a<-map_ipsl_change_CMIP6$to +  ggtitle("a) SST CMIP6 IPSL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[1])) + theme_opts_new
b<-map_gfdl_change_CMIP6$to +  ggtitle("b) SST CMIP6 GFDL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[1])) + theme_opts_new

c1<-map_summaries_CMIP6$map_average_change_CMIP6$pp + ggtitle("f) NPP CMIP6 ESMs average") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
c<-map_ipsl_change_CMIP6$pp + ggtitle("d) NPP CMIP6 IPSL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
d<-map_gfdl_change_CMIP6$pp + ggtitle("e) NPP CMIP6 GFDL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new

e<-map_summaries_CMIP6$map_average_change_CMIP6$phy +  ggtitle("i) Phytoplankton carbon CMIP6 ESMs average") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
f<-map_ipsl_change_CMIP6$phy + ggtitle("g) Phytoplankton carbon CMIP6 IPSL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
g<-map_gfdl_change_CMIP6$phy + ggtitle("h) Phytoplankton carbon CMIP6 GFDL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new

h<-map_summaries_CMIP6$map_average_change_CMIP6$zoo +  ggtitle("l) Zooplankton carbon CMIP6 ESMs average") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
i<- map_ipsl_change_CMIP6$zoo + ggtitle("j) Zooplankton carbon CMIP6 IPSL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new
l<-map_gfdl_change_CMIP6$zoo+ ggtitle("k) Zooplankton carbon CMIP6 GFDL") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 3, title = tit[2])) + theme_opts_new

pt<-a + b + a1 +
  c + d + c1 +
  f + g + e +
  i + l + h +
  plot_layout(design = layout)

pdf(paste0(save_loc,"FigS2_flipped.pdf"), height=6.7, width=10.5)
pt
dev.off()

# pdf(paste0(save_loc,"FigS2.pdf"), height=15, width=20)
# pt 
# dev.off()

# delete surplus legends 

a_noleg = a + theme(legend.position = "none")
c_noleg = c + theme(legend.position = "none")
f_noleg = f + theme(legend.position = "none")
i_noleg = i + theme(legend.position = "none")

b_noleg = b + theme(legend.position = "none")
d_noleg = d + theme(legend.position = "none")
g_noleg = g + theme(legend.position = "none")
l_noleg = l + theme(legend.position = "none")

pt<-a_noleg + b_noleg  + a1 +
  c_noleg + d_noleg  + c1 +
  f_noleg + g_noleg  + e +
  i_noleg + l_noleg  + h +
  plot_layout(design = layout)

pdf(paste0(save_loc,"FigS2_flipped_lessLegends.pdf"), height=7, width=10.5)
pt 
dev.off()


```

