---
title: "Plotting global models' time series outputs"
author: "Camilla Novaglio & Derek Tittensor"
date: "04/11/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script analysis Marine Ecosystem Models' outputs. It is structured in two steps:  
Step 1 extracts ocean biomass from MEMs' netcdfs and collapses the output into a grid-averaged time-series (1970 to 2100)  
Step 2 averages the data across MEMs and scenarios and produces Figure 

# STEP 1 extract data

## Load libraries for netcdf and define variables

```{r load CMIP5}


rm(list=ls())

install_load <- function (this_package)  {   

   package <- c(this_package)
   if(package %in% rownames(installed.packages()))
        do.call('library', list(package))

    # if package is not installed locally, download, then load
    else {
        install.packages(package)
         do.call("library", list(package))
    }
}

### load/install libraries ###
install_load("grid")
install_load("zoo")
install_load("viridis")
install_load("tidyr")
install_load("dplyr")
install_load("ncdf4")
install_load("ggplot2")
install_load("patchwork")
install_load("reshape2")

### load helper scripts with functions to extract data from netcdfs ###
source("R/HelperScripts.r")

### create folders where temporary data can be stored ###
mainDir = "../CMIP5vsCMIP6_data/"
DirStep1 = "temp_data"
ifelse(!dir.exists(file.path(mainDir, DirStep1)), dir.create(file.path(mainDir, DirStep1)), FALSE)

### create folders where figures can be saved ###
mainDir = "../CMIP5vsCMIP6_data/"
DirStep2 = "figures"
ifelse(!dir.exists(file.path(mainDir, DirStep2)), dir.create(file.path(mainDir, DirStep2)), FALSE)
save_loc<-"../CMIP5vsCMIP6_data/figures/"

### define variables ###
cmip<-c("CMIP5", "CMIP6")
mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL")
mod_gfdl <- c("BOATS", "DBEM", "EcoOcean", "MACROECOLOGICAL")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")
variable_to_extract <-c("tcb","tpb", "bp30cm", "bp30to90cm", "bp90cm")

```

## Extract data and calcaulte % change in time CMIP5 

```{r}

# CMIP5 data location

directory = "../CMIP5vsCMIP6_data/fishmip_outputs/marine-fishery_global_ISIMIP2b/"

# APECOSM ----
h_yearsA <- "1950_2005"
f_yearsA<- "2006_2100"
outputA<-"monthly"
oaA<-"no-oa"

# BOATS ----
h_yearsB <- "1971_2005"
f_yearsB<- "2006_2099"
outputB<-"monthly"
oaB<-"no-oa"

# DBEM ----
h_yearsD <- "1951_2005"
f_yearsD<- "2006_2099"
outputD<-"annual"
oaD<-"oa"

# DBPM ----
h_yearsDB <- "1950_2005"
f_yearsDB<- "2006_2100"
outputDB<-"monthly"
oaDB<-"no-oa"

# EcoOcean ----  
h_yearsE <- "1971_2005"
f_yearsE<- "2006_2100"
outputE<-"monthly"
oaE<-"no-oa"

# macroecological ----  
h_yearsM <- "1950_2005"
f_yearsM<- "2006_2100"
outputM<-"annual"
oaM<-"no-oa"

# extract data IPSL ---- 
h_years <-c(h_yearsA, h_yearsB, h_yearsD, h_yearsDB, h_yearsE, h_yearsM)
f_years <-c(f_yearsA, f_yearsB, f_yearsD, f_yearsDB, f_yearsE, f_yearsM)
output <-c(outputA, outputB, outputD, outputDB, outputE, outputM)
oa <-c(oaA, oaB, oaD, oaDB, oaE, oaM)

# extract all years 
yearmonth1<-rep(NA, length(mod_ipsl))
yearmonth2<-rep(NA, length(mod_ipsl))
yearmonth1_fut<-rep(NA, length(mod_ipsl))
yearmonth2_fut<-rep(NA, length(mod_ipsl))
cmip = 5

data_ipsl_CMIP5<-list()

for (i in 1:length(mod_ipsl)){

  filename<-paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[2],"/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_hist_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], ".nc4")
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE)

  filename <- paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_rcp2p6_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  filename <- paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_rcp8p5_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
   
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  # NOTE: the lat/long layout of the matrices does not matter as this function averages tcb by year
  # NOTE: check the years considered as we are using the same function to provide data for the IPCC to Laurent Bopp
  
  all<-get_timeSeries(hist, fut126, fut585, output = output[i]) 

  data_ipsl_CMIP5[[i]]<-list(all = all)
  names(data_ipsl_CMIP5)[[i]]<-mod_ipsl[[i]]

  rm(hist, fut126, fut585, all)

}

# add ZOOM IPSL ----

directory_zoom<-paste0(directory, "ZooMSS/_tmp/historical/")

# hist
filename<-"zoomss_ipsl-cm5a-lr_nobc_historical_nosoc_co2_tcb_global_annual_1950_2005.nc4"
yearmonth1 = NA
yearmonth2 = NA
hist<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

# 126
directory_zoom<-paste0(directory, "ZooMSS/_tmp/future/")
filename<-"zoomss_ipsl-cm5a-lr_nobc_rcp26_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut126<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

# 585
filename<-"zoomss_ipsl-cm5a-lr_nobc_rcp85_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut585<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

all<-get_timeSeries(hist, fut126, fut585, output = "yearly")

data_ipsl_CMIP5$ZooMSS<-list(all = all)
rm(hist, fut126, fut585, all)

# extract data GFDL ---- 

h_years <-c(h_yearsB, h_yearsD, h_yearsE, h_yearsM)
f_years <-c(f_yearsB, f_yearsD, f_yearsE, f_yearsM)
f_years[3]<-"2006_2099" 
output <-c(outputB, outputD, outputE, outputM)
oa <-c(oaB, oaD, oaE, oaM)

data_gfdl_CMIP5<-list()

for (i in 1:length(mod_gfdl)){

  filename<-paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[2],"/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_hist_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], ".nc4")
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE)
  
  filename <- paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[3], "/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_rcp2p6_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  filename <- paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[3], "/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_rcp8p5_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  all<-get_timeSeries(hist, fut126, fut585, output = output[i])
  
  data_gfdl_CMIP5[[i]]<-list(all = all)
  names(data_gfdl_CMIP5)[[i]]<-mod_gfdl[[i]]

  rm(hist, fut126, fut585, all)
  
}

names(data_gfdl_CMIP5)

## add ZOOM GFDL ----

# hist
directory_zoom<-paste0(directory, "ZooMSS/_tmp/historical/")
filename<-"zoomss_gfdl-esm2m_nobc_historical_nosoc_co2_tcb_global_annual_1950_2005.nc4"
hist<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

# 126
directory_zoom<-paste0(directory, "ZooMSS/_tmp/future/")
filename<-"zoomss_gfdl-esm2m_nobc_rcp26_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut126<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

# 585
filename<-"zoomss_gfdl-esm2m_nobc_rcp85_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut585<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

all<-get_timeSeries(hist, fut126, fut585, output = "yearly")

data_gfdl_CMIP5$ZooMSS<-list(all = all)
rm(hist, fut126, fut585, all)

```

## Save temporary outputs CMIP5 

```{r}

save(data_ipsl_CMIP5, data_gfdl_CMIP5, file = "../CMIP5vsCMIP6_data/temp_data/data_trends_CMIP5.RData")

```

## Extract data and calcaulte % change in time CMIP6 

```{r}

directory = "../CMIP5vsCMIP6_data/fishmip_outputs/marine-fishery_global_ISIMIP3b/"

mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL", "EcoTroph", "FEISTY", "ZooMSS") 
mod_ipsl <- c("APECOSM","BOATS","DBPM","MACROECOLOGICAL","FEISTY","ZooMSS") 

# APECOSM ----
# to update
h_yearsA <- "1850_2014"
f_yearsA<- "2015_2100"
earthA<-"_ipsl-esm4_nobc_" # will change ....
outputA<-"monthly"
extensionA<-".nc" 

# BOATS ----
h_yearsB <- "1950_2014"
f_yearsB<- "2015_2100"
earthB<-"_ipsl-cm6a-lr_nobc_"
outputB<-"monthly"
extensionB<-".nc"

# DBEM ----
# added below 

# DBPM ----
h_yearsDB <- "1850_2014"
f_yearsDB<- "2015_2100"
earthDB<-"_ipsl-cm6a-lr_nobasd_"
outputDB<-"monthly" 
extensionDB <-".nc"

# EcoOcean ----  
# added below  

# macroecological ----  
h_yearsM <- "1950_2014"
f_yearsM<- "2015-2100"
earthM<-"_ipsl-cm6a-lr_nobc_"
outputM<-"annual"
extensionM<-".nc"

# EcoTroph ----  
h_yearsE <- "1950-2014"
f_yearsE<- "2015-2100"
earthE<-"_ipsl-cm6a_nobc_"
outputE<-"annual"
extensionE<-".nc"
# added below

# FEISTY ----  
h_yearsF <- "1950_2014"
f_yearsF<- "2015_2100"
earthF<-"_ipsl-cm6a-lr_nobasd_" 
outputF<-"monthly"
extensionF<-".nc"

# ZooMSS ----  
h_yearsZ <- "1950_2014"
f_yearsZ<- "2015_2100"
earthZ<-"_ipsl-cm6a-lr_nobasd_"
outputZ<-"annual"
extensionZ<-".nc"

# extract data IPSL ---- 
h_years <-c(h_yearsA, h_yearsB, h_yearsDB, h_yearsM,h_yearsF, h_yearsZ) 
f_years <-c(f_yearsA, f_yearsB, f_yearsDB, f_yearsM,f_yearsF, f_yearsZ) 
earth <-c(earthA, earthB, earthDB, earthM, earthF, earthZ) 
output <-c(outputA, outputB, outputDB, outputM, outputF, outputZ) 
extension <-c(extensionA, extensionB, extensionDB,extensionM,extensionF,extensionZ) 

yearmonth1<-rep(NA, length(mod_ipsl))
yearmonth2<-rep(NA, length(mod_ipsl))
yearmonth1_fut<-rep(NA, length(mod_ipsl))
yearmonth2_fut<-rep(NA, length(mod_ipsl))

cmip = 6
data_ipsl_CMIP6<-list()

### if we are preparing data and fig for IPCC report (Laurent Bopp) then reference year must be changed.
# reference year for the time series: 1995-2014 - change in HelperScript get_timeSeries(). Only CMIP6

for (i in 1:length(mod_ipsl)){
  
  filename<-paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[2],"/", tolower(mod_ipsl[i]), earth[i], "historical_nat_default_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], extension[i])
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)
  
  filename <- paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), earth[i], "ssp126_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE, CMIP = 6)
  
  filename <- paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), earth[i], "ssp585_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE,CMIP = 6)
  
  # apply function to extract time series
  all<-get_timeSeries(hist, fut126, fut585, output = output[i])
  data_ipsl_CMIP6[[i]]<-list(all = all)
  names(data_ipsl_CMIP6)[[i]]<-mod_ipsl[[i]]

  rm(hist, fut126, fut585, all126, hist_2, refDecade, fut585_2, all)
 
}

names(data_ipsl_CMIP6)

# add EcoTrpoh IPSL ----

# no need for specific function - the only difference is that the variable to extract is called "Band1"

filename<-"EcoTroph/_tmp/ipsl-cm6a-lr/future/ecotroph_ipsl-cm6a-lr_nobc_ssp126_nat_default_tcb_annual_1950_2100.nc" # REVISION: it was ssp585 now corrected to 126
combined<-extractFishCDF(directory, filename , "Band1", yearmonth1, yearmonth2, average_whole_period = FALSE, CMIP = 6)

# hist
start_point_to_extract = which(1971 == combined$years) # REVISION: changed from 1971
end_point_to_extract = which(2014 == combined$years)
hist<-combined
hist$fishvar <- hist$fishvar[, , start_point_to_extract:end_point_to_extract]
hist$years <- hist$years[start_point_to_extract:end_point_to_extract]

# 126
start_point_to_extract = which(2015 == combined$years)
end_point_to_extract = which(2100 == combined$years)
fut126<-combined
fut126$fishvar <- fut126$fishvar[, , start_point_to_extract:end_point_to_extract]
fut126$years <- fut126$years[start_point_to_extract:end_point_to_extract]

# 585
filename<-"EcoTroph/_tmp/ipsl-cm6a-lr/future/ecotroph_ipsl-cm6a-lr_nobc_ssp585_nat_default_tcb_annual_1950_2100.nc"
fut585<-extractFishCDF(directory, filename , "Band1", yearmonth1, yearmonth2, average_whole_period = FALSE, CMIP = 6)
fut585$fishvar <- fut585$fishvar[, , start_point_to_extract:end_point_to_extract]
fut585$years <- fut585$years[start_point_to_extract:end_point_to_extract]

output[i]<-outputE 
all<-get_timeSeries(hist, fut126, fut585, output = "yearly")
data_ipsl_CMIP6$EcoTroph<-list(all = all)

# add EcoOcean IPSL ----

extractFishCDF_EcoOcean <- function(file, type = "hist"){
  
  # Open the netcdf file
  nc <- file 
  
  # Extract important information
  data_attributes <- "guess" # should be "tcb"
  main_title <- "guess"
  data_units <- "guess"
    
  lon <- lon    
  lat <- lat

  time_months <- seq(1, dim(nc)[3])
  
  if(type == "hist"){
    yearmonth = as.yearmon("1949-12") + time_months[1] / 12
    }else{
      yearmonth = as.yearmon("2006-01") + time_months[1] / 12 
      }

  time_months = as.yearmon(yearmonth + seq(0, (length(time_months) - 1)) / 12)     
  time_vector<-time_months
  print(time_months[1])
  print(time_months[length(time_months)])
  
  # extract all 
  new_var_mat <- nc
  years = time_vector
  
  # this should be done when we know the data units 
  new_var_mat = new_var_mat * 1000
  data_units = "kg km-2" 
  
  return_list <-
    list(
      main_title = main_title,
      data_units = data_units,
      lon = lon,
      lat = lat,
      years = years,
      fishvar = new_var_mat
    )
}

# hist
file<-readRDS(paste0(directory,"EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_historical_nosoc_default_tcb_global_monthly_1950-2005.RDS"))
lon<-hist$lon # lat and lon from EcoTroph above as missing for EcoOcean
lat<-hist$lat
hist<-extractFishCDF_EcoOcean(file, type = "hist")

# 126
file<-readRDS(paste0(directory,"EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_ssp126_nosoc_default_tcb_global_monthly_2006_2100.RDS"))
fut126<-extractFishCDF_EcoOcean(file, type= "fut")

# 585
file<-readRDS(paste0(directory, "EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_ssp585_nosoc_default_tcb_global_monthly_2006_2100.RDS"))
fut585<-extractFishCDF_EcoOcean(file, type= "fut")

output[i]<-"monthly" 
all<-get_timeSeries(hist, fut126, fut585, output = "monthly")
data_ipsl_CMIP6$EcoOcean<-list(all = all) 

# add DBEM IPSL ----

extractFishCDF_DBEM<-function(file, type = "hist"){
  
  # Extract important information
  main_title <- "guess"
  data_units <- "guess"
    
  lon <- unique(coord$lon)
  lat <- unique(coord$lat)

  time_vector <- seq(1951, 2100)

  # Create a new matrix to hold the results
  new_var_mat = array(rep(0, length(lon) * length(lat)), c(length(lon), length(lat)))
      
  # dimension and data format are different than for other models, so need different way of extracting data. 
  # GRID CELL X YEAR
  df<-as.data.frame(file)
  colnames(df)<-time_vector
  df<-cbind(coord, df)
  years <-time_vector
  
  # cut history and future 
  if(type == "hist"){
    df2<-df %>% dplyr::select(lon, lat, "1971":"2014") # REVISION: changed from 1971 to 1970 (or keep 1971?)
    df2<-gather(df2, year, tcb, "1971":"2014") # REVISION: changed from 1971
    start_point_to_extract = which(1971 == years) # REVISION: changed from 1971
    end_point_to_extract = which(2014 == years)
  } else{
    df2<-df %>% dplyr::select(lon, lat, "2015":"2100")
    df2<-gather(df2, year, tcb, "2015":"2100")
    start_point_to_extract = which(2015 == years)
    end_point_to_extract = which(2100 == years)
  }
  
  # to array
  new_var_mat<-acast(df2, lon~lat~year, value.var="tcb")
  years <- years[start_point_to_extract:end_point_to_extract]
  
  # this should be done when we know the data units 
  new_var_mat = new_var_mat * 1000
  data_units = "kg km-2" 
    
  return_list <- list(
        main_title = main_title,
        data_units = data_units,
        lon = lon,
        lat = lat,
        years = years,
        fishvar = new_var_mat
      )
}

coord<-read.delim(paste0(directory,"DBEM_RData/Lat_Lon.txt"),header = FALSE, sep = ",")
colnames(coord)<-c("grid", "lon", "lat")

# hist & 126
file<-load(paste0(directory,"DBEM_RData/C6IPSL26F0_t2_Abd.RData"))
file<-sppfnlmap
hist<-extractFishCDF_DBEM(file, type = "hist")
fut126<-extractFishCDF_DBEM(file, type = "fut")

# 585
file<-load(paste0(directory,"DBEM_RData/C6IPSL85F0_t2_Abd.RData"))
file<-sppfnlmap
fut585<-extractFishCDF_DBEM(file, type = "fut")

output[i]<-"annual" 
all<-get_timeSeries(hist, fut126, fut585, output = "yearly")
data_ipsl_CMIP6$DBEM<-list(all = all) 

# extract data GFDL ---- 

mod_gfdl <- c("BOATS","DBPM", "MACROECOLOGICAL","ZooMSS", "FEISTY") 

h_years <-c(h_yearsB,h_yearsDB, h_yearsM, h_yearsZ,h_yearsF) 
f_years <-c(f_yearsB,f_yearsDB, f_yearsM, f_yearsZ, f_yearsF) 
earth<-c("_gfdl-esm4_nobc_","_gfdl-esm4_nobasd_","_gfdl-esm4_nobc_","_gfdl-esm4_nobasd_","_gfdl-esm4_nobasd_")
output <-c(outputB,outputDB, outputM, outputZ, outputF) 
extension <-c(extensionB, extensionDB,extensionM, extensionZ, extensionF) 

data_gfdl_CMIP6<-list()

for (i in 1:length(mod_gfdl)){

  filename<-paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[2],"/", tolower(mod_gfdl[i]), earth[i], "historical_nat_default_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], extension[i])
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)

  filename <- paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[3], "/", tolower(mod_gfdl[i]), earth[i], "ssp126_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE, CMIP = 6)
  
  filename <- paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[3], "/", tolower(mod_gfdl[i]), earth[i], "ssp585_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE,CMIP = 6)
  
  all<-get_timeSeries(hist, fut126, fut585, output = output[i])

  data_gfdl_CMIP6[[i]]<-list(all = all)
  names(data_gfdl_CMIP6)[[i]]<-mod_gfdl[[i]]

  rm(hist, fut126, fut585, all126, hist_2, refDecade, fut585_2, all)
 
}

# add EcoTrpoh GFDL ----

filename<-"EcoTroph/_tmp/gfdl-esm4/future/ecotroph_gfdl-esm4_nobc_ssp126_nat_default_tcb_annual_1950_2100.nc"
combined<-extractFishCDF(directory, filename , "Band1", yearmonth1, yearmonth2, average_whole_period = FALSE, CMIP = 6)

# hist
start_point_to_extract = which(1971 == combined$years) # REVISION: changed from 1971
end_point_to_extract = which(2014 == combined$years)
hist<-combined
hist$fishvar <- hist$fishvar[, , start_point_to_extract:end_point_to_extract]
hist$years <- hist$years[start_point_to_extract:end_point_to_extract]

# 126
start_point_to_extract = which(2015 == combined$years)
end_point_to_extract = which(2100 == combined$years)
fut126<-combined
fut126$fishvar <- fut126$fishvar[, , start_point_to_extract:end_point_to_extract]
fut126$years <- fut126$years[start_point_to_extract:end_point_to_extract]

# 585
filename<-"EcoTroph/_tmp/gfdl-esm4/future/ecotroph_gfdl-esm4_nobc_ssp585_nat_default_tcb_annual_1950_2100.nc"
fut585<-extractFishCDF(directory, filename , "Band1", yearmonth1, yearmonth2, average_whole_period = FALSE, CMIP = 6)
fut585$fishvar <- fut585$fishvar[, , start_point_to_extract:end_point_to_extract]
fut585$years <- fut585$years[start_point_to_extract:end_point_to_extract]

output[i]<-outputE
all<-get_timeSeries(hist, fut126, fut585, output = "yearly")
data_gfdl_CMIP6$EcoTroph<-list(all = all)

# add EcoOcean GFDL ----

# hist
file<-readRDS(paste0(directory, "EcoOcean CMIP6 RDS files/ecoocean_gfdl_nobc_historical_nosoc_default_tcb_global_monthly_1950-2005.RDS"))
lon<-hist$lon # lat and long from EcoTroph above as missing for EcoOcean
lat<-hist$lat
hist<-extractFishCDF_EcoOcean(file, type = "hist")

# 126
file<-readRDS(paste0(directory, "EcoOcean CMIP6 RDS files/ecoocean_gfdl_nobc_ssp126_nosoc_default_tcb_global_monthly_2006_2100.RDS"))
fut126<-extractFishCDF_EcoOcean(file, type= "fut")

# 585
file<-readRDS(paste0(directory,"EcoOcean CMIP6 RDS files/ecoocean_gfdl_nobc_ssp585_nosoc_default_tcb_global_monthly_2006_2100.RDS"))
fut585<-extractFishCDF_EcoOcean(file, type= "fut")

output[i]<-"monthly" 
all<-get_timeSeries(hist, fut126, fut585, output = "monthly")
data_gfdl_CMIP6$EcoOcean<-list(all = all) 

# add DBEM GFDL ----

# hist & 126
file<-load(paste0(directory, "DBEM_RData/C6GFDL26F0_t2_Abd.RData"))
file<-sppfnlmap
hist<-extractFishCDF_DBEM(file, type = "hist")
fut126<-extractFishCDF_DBEM(file, type = "fut")

# 585
file<-load(paste0(directory, "DBEM_RData/C6GFDL85F0_t2_Abd.RData"))
file<-sppfnlmap
fut585<-extractFishCDF_DBEM(file, type = "fut")

output[i]<-"annual" 
all<-get_timeSeries(hist, fut126, fut585, output = "yearly") 
data_gfdl_CMIP6$DBEM<-list(all = all) 

```

## Save temporary outputs CMIP6 

```{r}

save(data_ipsl_CMIP6, data_gfdl_CMIP6, file = "../CMIP5vsCMIP6_data/temp_data/data_trends_CMIP6.RData")

# # for IPCC - Laurent Bopp
# data_gfdl_CMIP6$DBPM<-NULL
# save(data_ipsl_CMIP6, data_gfdl_CMIP6, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_trends_CMIP6_IPCC_toCut.RData")

```

# STEP 2 averadge and plot data

## Load data

```{r}

rm(list=ls())

# The revision version includes all changes after submission and mostly due to Laurent data preparation (as per 29-Jun-2021)
# load("/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_trends_CMIP5_revision.RData")
# load("/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_trends_CMIP6_revision.RData")

load("../CMIP5vsCMIP6_data/temp_data/data_trends_CMIP5.RData")
load("../CMIP5vsCMIP6_data/temp_data/data_trends_CMIP6.RData")

```

## Load libraries for netcdf and define variables

```{r load CMIP5}

install_load <- function (this_package)  {   

   package <- c(this_package)
   if(package %in% rownames(installed.packages()))
        do.call('library', list(package))

    # if package is not installed locally, download, then load
    else {
        install.packages(package)
         do.call("library", list(package))
    }
}

### load/install libraries ###
install_load("grid")
install_load("zoo")
install_load("viridis")
install_load("tidyr")
install_load("dplyr")
install_load("ncdf4")
install_load("patchwork")
install_load("ggplot2")

### load helper scripts with functions to extract data from netcdfs ###
source("R/HelperScripts.r")

### define variables ###
cmip<-c("CMIP5", "CMIP6")
mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL")
mod_gfdl <- c("BOATS", "DBEM", "DBPM", "EcoOcean", "MACROECOLOGICAL")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")
variable_to_extract <-c("tcb","tpb", "bp30cm", "bp30to90cm", "bp90cm")

### create folders where figures can be saved ###
mainDir = "../CMIP5vsCMIP6_data/"
DirStep2 = "figures"
ifelse(!dir.exists(file.path(mainDir, DirStep2)), dir.create(file.path(mainDir, DirStep2)), FALSE)
save_loc<-"../CMIP5vsCMIP6_data/figures/"

```

## Deal with model set 

```{r}

# if model set == "full", we are considering all models and creating figures for the Main Document, otherwise we are considering the subset of models considered in Lotze et al. 2019 and producing figures for the Supplemntary Information. 

set = "full"

if (set == "full"){
  # exclude DBPM GFDL CMIP6 anyways as this are not final runs   
  data_gfdl_CMIP6$DBPM<-NULL 
  }else {
    data_gfdl_CMIP6$DBPM<-NULL 
    data_ipsl_CMIP5$ZooMSS<-NULL
    data_gfdl_CMIP5$ZooMSS<-NULL
    data_ipsl_CMIP6$ZooMSS<-NULL
    data_gfdl_CMIP6$ZooMSS<-NULL
    data_ipsl_CMIP6$FEISTY<-NULL
    data_gfdl_CMIP6$FEISTY<-NULL
    data_ipsl_CMIP6$EcoTroph<-NULL
    data_gfdl_CMIP6$EcoTroph<-NULL
  }

```

## Mean and sd of the above across models and ssp for both CMIP5 and CMIP6

```{r}

# CMIP5 
data_ipsl_CMIP5_tcb<-do.call(rbind, lapply(data_ipsl_CMIP5, as.data.frame)) 
data_ipsl_CMIP5_tcb<-data_ipsl_CMIP5_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_ipsl_CMIP5_tcb)), 
         cmip = 5, 
         earth = "ipsl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

data_ipsl_CMIP5_tcb<-data_ipsl_CMIP5_tcb %>%  
  mutate(year = as.numeric(year))

data_gfdl_CMIP5_tcb<-do.call(rbind, lapply(data_gfdl_CMIP5, as.data.frame)) 
data_gfdl_CMIP5_tcb<-data_gfdl_CMIP5_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_gfdl_CMIP5_tcb)), 
         cmip = 5, 
         earth = "gfdl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

data_gfdl_CMIP5_tcb<-data_gfdl_CMIP5_tcb %>% 
  mutate(year = as.numeric(year))

# CMIP6
data_ipsl_CMIP6_tcb<-do.call(rbind, lapply(data_ipsl_CMIP6, as.data.frame)) 
data_ipsl_CMIP6_tcb<-data_ipsl_CMIP6_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_ipsl_CMIP6_tcb)), 
         cmip = 6, 
         earth = "ipsl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

data_ipsl_CMIP6_tcb<-data_ipsl_CMIP6_tcb %>% 
  mutate(year = as.numeric(year))

# fix ecoOcean 

data_ipsl_CMIP6_tcb[which(data_ipsl_CMIP6_tcb$model == "EcoOcean" & data_ipsl_CMIP6_tcb$year >= 2005 & data_ipsl_CMIP6_tcb$year<2015 & data_ipsl_CMIP6_tcb$protocol == "ssp585"), ]

data_ipsl_CMIP6_tcb<-data_ipsl_CMIP6_tcb [-which(data_ipsl_CMIP6_tcb$model == "EcoOcean" & data_ipsl_CMIP6_tcb$year >= 2005 & data_ipsl_CMIP6_tcb$year<2015 & data_ipsl_CMIP6_tcb$protocol == "ssp585"), ]

data_gfdl_CMIP6_tcb<-do.call(rbind, lapply(data_gfdl_CMIP6, as.data.frame)) 
data_gfdl_CMIP6_tcb<-data_gfdl_CMIP6_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_gfdl_CMIP6_tcb)), 
         cmip = 6, 
         earth = "gfdl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

data_gfdl_CMIP6_tcb<-data_gfdl_CMIP6_tcb %>% 
  mutate(year = as.numeric(year))

# fix ecoOcean 

data_gfdl_CMIP6_tcb [which(data_gfdl_CMIP6_tcb$model == "EcoOcean" & data_gfdl_CMIP6_tcb$year >= 2005 & data_gfdl_CMIP6_tcb$year<2015 & data_gfdl_CMIP6_tcb$protocol == "ssp585"), ]

data_gfdl_CMIP6_tcb<-data_gfdl_CMIP6_tcb [-which(data_gfdl_CMIP6_tcb$model == "EcoOcean" & data_gfdl_CMIP6_tcb$year >= 2005 & data_gfdl_CMIP6_tcb$year<2015 & data_gfdl_CMIP6_tcb$protocol == "ssp585"), ]

data_gfdl_CMIP6_tcb [which(data_gfdl_CMIP6_tcb$year >= 2005 & data_gfdl_CMIP6_tcb$year<2015 & data_gfdl_CMIP6_tcb$protocol == "ssp585"), ]

# add all together and average
all<-data_ipsl_CMIP5_tcb %>% 
  full_join(data_gfdl_CMIP5_tcb) %>% 
  full_join(data_ipsl_CMIP6_tcb) %>% 
  full_join(data_gfdl_CMIP6_tcb) %>% 
  group_by(protocol, year, cmip) %>% 
  summarise(mean = mean(tcbChange, na.rm = TRUE), 
            sd = sd(tcbChange, na.rm = TRUE)) %>% 
  mutate(sd_min = mean - sd, 
         sd_max = mean + sd) 

# create dots when CMIP6 < CMIP6 
trial<-all %>% 
  dplyr::select(cmip, mean, protocol, year) %>%
  spread(cmip, mean) %>% 
  mutate(A = ifelse(`6`< `5`,`5`, NA)) %>% 
  gather("cmip","mean", -c(protocol, year, A)) %>% 
  mutate(cmip = as.numeric(cmip))

all<-all %>% 
  full_join(trial) %>% 
  mutate(year = as.numeric(year))

```

## FIG 3 or S7 - trends in tcb  

```{r}

a<-ggplot(filter(all, cmip==5), aes(group = protocol, x=year,y = mean, ymin = sd_min, ymax = sd_max))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_ribbon(aes(fill = protocol), alpha=0.2)+
  geom_line(aes(color = protocol)) +
  geom_vline(xintercept = 2005.5, color = "grey60", size = 2)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-30, 6), breaks = pretty(seq(15, -30), n = 10), name = "Change in biomass (%)") +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  scale_color_manual(values = c("black","blue" ,"red"), name = "Scenarios", labels = c("Historical", "RCP2.6", "RCP8.5"))+
  scale_fill_manual(values = c("black","blue" ,"red"), name = "Scenarios", labels = c("Historical", "RCP2.6", "RCP8.5"))+
  theme_bw()+
  theme(text = element_text(size=20),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5),
        panel.grid.minor = element_blank(),
        legend.background= element_rect(colour = 'black', fill = 'white', linetype='solid'),
        panel.border = element_rect(colour = "black"),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.position = c(0.13, 0.3))

b<-ggplot(filter(all, cmip==6), aes(group = protocol, x=year, y = mean))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_ribbon(aes(ymin = sd_min, ymax = sd_max, fill = protocol), alpha=0.2)+
  geom_line(aes(color = protocol)) +
  geom_point(aes(y = A, color = protocol), size = 0.8)+
  geom_vline(xintercept = 2015, color = "grey60", size = 2)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-30, 6), breaks = pretty(seq(15, -30), n = 10), name = NULL) +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  scale_color_manual(values = c("black","blue" ,"red"), name = "Scenarios", labels = c("Historical", "SSP1-2.6", "SSP5-8.5"))+
  scale_fill_manual(values = c("black","blue" ,"red"), name = "Scenarios", labels = c("Historical", "SSP1-2.6", "SSP5-8.5"))+
  theme_bw()+
  theme(text = element_text(size=20),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_rect(colour = "black"),
        strip.text.x = element_text(face = "bold"),
        legend.background= element_rect(colour = 'black', fill = 'white', linetype='solid'),
        legend.position = c(0.13, 0.3))

layout <- "
AB
"

a<-a + ggtitle("a) CMIP5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b<-b + ggtitle("b) CMIP6") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0))

plot<-a + b + 
  plot_layout(design = layout)

if(set == "full"){name = "Fig3.pdf"}else{name = "FigS7.pdf"}

# pdf(paste0(save_loc,name), height=6.5, width=15) 
# plot
# dev.off()

lastDecade<-filter(all, year >= 2090, year <= 2099) %>% 
  group_by(cmip, protocol) %>% 
  summarise(mean2 = mean(mean), 
            sd2 = mean(sd))

# full set
#    cmip protocol  mean2   sd2
#   <dbl> <chr>     <dbl> <dbl>
# 1     5 ssp126    -4.32  3.18
# 2     5 ssp585   -15.4   9.61
# 3     6 ssp126    -5.81  2.97
# 4     6 ssp585   -17.1   5.89

# reduced set - CMIP5 has not the same values becasue of ZoomSS
#   cmip protocol  mean2   sd2
#   <dbl> <chr>     <dbl> <dbl>
# 1     5 ssp126    -4.47  3.30
# 2     5 ssp585   -16.2  10.1 
# 3     6 ssp126    -6.19  2.93
# 4     6 ssp585   -17.5   6.82


lastYear<-filter(all, year == 2099) 

# full set
#   protocol  year  cmip   mean    sd sd_min sd_max      A
#   <chr>    <dbl> <dbl>  <dbl> <dbl>  <dbl>  <dbl>  <dbl>
# 1 ssp126    2099     5  -4.69  2.97  -7.66  -1.72  -4.69
# 2 ssp126    2099     6  -6.66  2.89  -9.55  -3.77  -4.69
# 3 ssp585    2099     5 -16.5  10.1  -26.5   -6.39 -16.5 
# 4 ssp585    2099     6 -18.9   6.54 -25.4  -12.4  -16.5

# reduced set
#   protocol  year  cmip   mean    sd sd_min sd_max      A
#   <chr>    <dbl> <dbl>  <dbl> <dbl>  <dbl>  <dbl>  <dbl>
# 1 ssp126    2099     5  -4.82  3.10  -7.92  -1.73  -4.82
# 2 ssp126    2099     6  -7.20  2.60  -9.80  -4.60  -4.82
# 3 ssp585    2099     5 -17.2  10.6  -27.8   -6.68 -17.2 
# 4 ssp585    2099     6 -19.2   7.54 -26.8  -11.7  -17.2 

```

## FIG 4 or S8, S11 and S17 - trends in tcb by model and esm and stat test 

```{r}

# add all together and average
all_models<-data_ipsl_CMIP5_tcb %>%
  full_join(data_gfdl_CMIP5_tcb) %>%
  full_join(data_ipsl_CMIP6_tcb) %>%
  full_join(data_gfdl_CMIP6_tcb)

# stat test 
test5_85<-all_models %>% 
  filter(cmip == 5, year >= 2090, protocol == "ssp585")
test5_26<-all_models %>% 
  filter(cmip == 5, year >= 2090, protocol == "ssp126")

# between protocols CMIP5
wilcox.test(test5_26$tcbChange, test5_85$tcbChange, alternative = "two.sided")

# full set
# data:  test5_26$tcbChange and test5_85$tcbChange
# W = 12822, p-value < 2.2e-16
# alternative hypothesis: true location shift is not equal to 0

# reduced set 
# data:  test5_26$tcbChange and test5_85$tcbChange
# W = 8966, p-value < 2.2e-16
# alternative hypothesis: true location shift is not equal to 0

test6_85<-all_models %>% 
  filter(cmip == 6, year >= 2090, protocol == "ssp585")
test6_26<-all_models %>% 
  filter(cmip == 6, year >= 2090, protocol == "ssp126")

# between protocols CMIP6
wilcox.test(test6_26$tcbChange, test6_85$tcbChange, alternative = "two.sided")

# full set 
# data:  test6_26$tcbChange and test6_85$tcbChange
# W = 25123, p-value < 2.2e-16
# alternative hypothesis: true location shift is not equal to 0

# reduced set 
# data:  test6_26$tcbChange and test6_85$tcbChange
# W = 9702, p-value < 2.2e-16
# alternative hypothesis: true location shift is not equal to 0

# between CMIPS

# mitigation
wilcox.test(test5_26$tcbChange, test6_26$tcbChange, alternative = "two.sided")

# full set 
# data:  test5_26$tcbChange and test6_26$tcbChange
# W = 12291, p-value = 6.007e-05
# alternative hypothesis: true location shift is not equal to 0

# reduced set
# data:  test5_26$tcbChange and test6_26$tcbChange
# W = 6626, p-value = 7.135e-05
# alternative hypothesis: true location shift is not equal to 0

# high emission - the one less significant across all tests
wilcox.test(test5_85$tcbChange, test6_85$tcbChange, alternative = "two.sided")

# full set 
# data:  test5_85$tcbChange and test6_85$tcbChange
# W = 11246, p-value = 0.01413
# alternative hypothesis: true location shift is not equal to 0

# reduced set
# data:  test5_85$tcbChange and test6_85$tcbChange
# W = 5449, p-value = 0.2731
# alternative hypothesis: true location shift is not equal to 0

mean(test5_26$tcbChange)
mean(test6_26$tcbChange)

mean(test5_85$tcbChange)
mean(test6_85$tcbChange)

# end test

all_models_85<-all_models %>% 
  filter(protocol %in% c("hist", "ssp585")) %>% 
  droplevels()

all_models_26<-all_models %>% 
  filter(protocol %in% c("hist", "ssp126")) %>% 
  droplevels()

# color code 
df<-data.frame(model = c("APECOSM","BOATS","DBEM","DBPM","EcoOcean","FEISTY","EcoTroph","MACROECOLOGICAL","ZooMSS"), color = c("red","blue", "lightblue","black", "pink","purple","brown","green","orange"))
df_cmip5ipsl<-df %>% filter(model %in% unique(filter(all_models, cmip==5, earth =="ipsl")$model))
df_cmip5gfdl<-df %>% filter(model %in% unique(filter(all_models, cmip==5, earth =="gfdl")$model))
df_cmip6ipsl<-df %>% filter(model %in% unique(filter(all_models, cmip==6, earth =="ipsl")$model))
df_cmip6gfdl<-df %>% filter(model %in% unique(filter(all_models, cmip==6, earth =="gfdl")$model))

plot_trends<-function(all_models){
  
a1<-ggplot(filter(all_models, cmip==5, earth =="ipsl"), aes(x=year, y = tcbChange,  color = model))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_line(size=1) +
  geom_vline(xintercept = 2005.5, color = "grey60", size = 2)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-35, 6), breaks = pretty(seq(20, -40), n = 10), name = "Change in biomass (%)") + 
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  scale_color_manual(values = df_cmip5ipsl$color, name = "Ecosystem Models") +
  theme_bw()+
  theme(text = element_text(size=14),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5, size=16),
        axis.text.y = element_text(angle=0, size=16),
        panel.border = element_rect(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.background= element_rect(colour = 'black', fill = 'white', linetype='solid'),
        legend.position = c(0.17, 0.4),
        legend.key.size = unit(0.6, "cm"))


b1<-ggplot(filter(all_models, cmip==6, earth =="ipsl"), aes(x=year, y = tcbChange,  color = model))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_line(size=1) +
  geom_vline(xintercept = 2015, color = "grey60", size = 2)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-35, 6), breaks = pretty(seq(20, -40), n = 10), name = "Change in biomass (%)") +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year-1, n = 10), name = "Year")+
  scale_color_manual(values = df_cmip6ipsl$color, name = "Ecosystem Models") +
  theme_bw()+
  theme(text = element_text(size=14),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5, size=16),
        axis.text.y = element_text(angle=0, size=16),
        panel.border = element_rect(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.background= element_rect(colour = 'black', fill = 'white', linetype='solid'),
        legend.position = c(0.17, 0.4),
        legend.key.size = unit(0.6, "cm"))


a2<-ggplot(filter(all_models, cmip==5, earth =="gfdl"), aes(x=year, y = tcbChange,  color = model))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_line(size=1) +
  geom_vline(xintercept = 2005.5, color = "grey60", size = 2)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-35, 6), breaks = pretty(seq(20, -40), n = 10), name = "Change in biomass (%)") + 
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  scale_color_manual(values = df_cmip5gfdl$color, name = "Ecosystem Models") +
  theme_bw()+
  theme(text = element_text(size=14),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5, size=16),
        axis.text.y = element_text(angle=0, size=16),
        panel.border = element_rect(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.background= element_rect(colour = 'black', fill = 'white', linetype='solid'),
        legend.position = c(0.17, 0.4),
        legend.key.size = unit(0.6, "cm"))


b2<-ggplot(filter(all_models, cmip==6, earth =="gfdl"), aes(x=year, y = tcbChange,  color = model))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_line(size=1) +
  geom_vline(xintercept = 2015, color = "grey60", size = 2)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-35, 6), breaks = pretty(seq(20, -40), n = 10), name = "Change in biomass (%)") +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year-1, n = 10), name = "Year")+
  scale_color_manual(values = df_cmip6gfdl$color, name = "Ecosystem Models") +
  theme_bw()+
  theme(text = element_text(size=14),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5, size=16),
        axis.text.y = element_text(angle=0, size=16),
        panel.border = element_rect(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.background= element_rect(colour = 'black', fill = 'white', linetype='solid'),
        legend.position = c(0.17, 0.4),
        legend.key.size = unit(0.6, "cm"))

return(list(a1 =a1 , b1 =b1, a2 = a2, b2 = b2))
}

res<-plot_trends(all_models_85)
a1 = res$a1
b1 = res$b1
a2 = res$a2
b2 = res$b2

layout <- "
AB
CD
"

a1<-a1 + ggtitle("a) CMIP5 IPSL-CM5A-LR") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0), axis.title.x = element_blank())
b1<-b1 + ggtitle("b) CMIP6 IPSL-CM6A-LR") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0), axis.title.x = element_blank(), axis.title.y = element_blank())
a2<-a2 + ggtitle("c) CMIP5 GFDL-ESM2M") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b2<-b2 + ggtitle("d) CMIP6 GFDL-ESM4") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0), axis.title.y = element_blank()) # legend.position = "none"

plot<-a1 + b1 + a2 + b2 + 
  plot_layout(design = layout)

if(set == "full"){name = "Fig4.pdf"}else{name = "FigS8.pdf"}

pdf(paste0(save_loc,name), height=12, width=15) 
plot
dev.off()

# 2.6 scenario
res<-plot_trends(all_models_26)
a1 = res$a1
b1 = res$b1
a2 = res$a2
b2 = res$b2

layout <- "
AB
CD
"

a1<-a1 + ggtitle("a) CMIP5 IPSL-CM5A-LR") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0), axis.title.x = element_blank())
b1<-b1 + ggtitle("b) CMIP6 IPSL-CM6A-LR") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0), axis.title.x = element_blank(), axis.title.y = element_blank())
a2<-a2 + ggtitle("c) CMIP5 GFDL-ESM2M") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b2<-b2 + ggtitle("d) CMIP6 GFDL-ESM4") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0), axis.title.y = element_blank()) 

plot<-a1 + b1 + a2 + b2 + 
  plot_layout(design = layout)

if(set == "full"){name = "FigS11.pdf"}else{name = "FigS17.pdf"}

pdf(paste0(save_loc,name), height=12, width=15) # CONSIDER ALL MODELS
plot
dev.off()

```
