---
title: "Plotting global models' time series outputs"
author: "Camilla Novaglio"
date: "04/11/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

# TO DO 

# Load libraries for netcdf and define variables

```{r load CMIP5}

rm(list=ls())
library(grid)
library(zoo)
library(viridis)
library(tidyr)
library(dplyr)

source("/Users/camillan/R-projects/CMIP5vsCMIP6/R/HelperScripts.r")

# saving outputs location  
# save_loc <- "/Users/camillan/Dropbox/CMIP5vsCMIP6/figs/"

# variables 
cmip<-c("CMIP5", "CMIP6")
mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL")
mod_gfdl <- c("BOATS", "DBEM", "EcoOcean", "MACROECOLOGICAL")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")
variable_to_extract <-c("tcb","tpb", "bp30cm", "bp30to90cm", "bp90cm")

```

# extract data and calcaulte % change in time CMIP5 

```{r}

# CMIP5 data location
directory = "/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/"

# APECOSM ----
h_yearsA <- "1950_2005"
f_yearsA<- "2006_2100"
outputA<-"monthly"
oaA<-"no-oa"

# BOATS ----
h_yearsB <- "1971_2005"
f_yearsB<- "2006_2099"
outputB<-"monthly"
oaB<-"no-oa"

# DBEM ----
h_yearsD <- "1951_2005"
f_yearsD<- "2006_2099"
outputD<-"annual"
oaD<-"oa"

# DBPM ----
h_yearsDB <- "1950_2005"
f_yearsDB<- "2006_2100"
outputDB<-"monthly"
oaDB<-"no-oa"

# EcoOcean ----  
h_yearsE <- "1971_2005"
f_yearsE<- "2006_2100"
outputE<-"monthly"
oaE<-"no-oa"

# macroecological ----  
h_yearsM <- "1950_2005"
f_yearsM<- "2006_2100"
outputM<-"annual"
oaM<-"no-oa"

# extract data IPSL ---- 
h_years <-c(h_yearsA, h_yearsB, h_yearsD, h_yearsDB, h_yearsE, h_yearsM)
f_years <-c(f_yearsA, f_yearsB, f_yearsD, f_yearsDB, f_yearsE, f_yearsM)
output <-c(outputA, outputB, outputD, outputDB, outputE, outputM)
oa <-c(oaA, oaB, oaD, oaDB, oaE, oaM)

# extract all years 
yearmonth1<-rep(NA, length(mod_ipsl))
yearmonth2<-rep(NA, length(mod_ipsl))
yearmonth1_fut<-rep(NA, length(mod_ipsl))
yearmonth2_fut<-rep(NA, length(mod_ipsl))
cmip = 5

# 2 ways of doing  this: 
# option 1: use averageFishCDF(average_whole_period = FALSE) which extracts data and merges info by month if the  model's output is monthly. Then merge info by grid cell in get_timeSeries() 
# option 2: use extractFishCDF() which extracts everything without manipulation data. Then merge info by month and grid cell all together in get_timeSeries() - i.e. option 2 - you don't mean twice: by months first -> lat long year; and by year next -> year. you only mean once: by year -> year. Results slightly change but the process is much faster. Need to merge this with the codes that produces maps so that you extract data only once and process it both ways. 
# CN note: what's the deal with DBEM? a huge average of everything in terms of grids - should I consider 1 value every 2 grids as per maps?

data_ipsl_CMIP5<-list()

for (i in 1:length(mod_ipsl)){

  # i = 6
  filename<-paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[2],"/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_hist_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], ".nc4")
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE)
  # dim(hist$fishvar)

  filename <- paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_rcp2p6_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  filename <- paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_rcp8p5_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
   
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  # apply function to extract time series
  # modified - weight for cos(lat)
  
  all<-get_timeSeries(hist, fut126, fut585, output = output[i])

  data_ipsl_CMIP5[[i]]<-list(all = all)
  names(data_ipsl_CMIP5)[[i]]<-mod_ipsl[[i]]

  rm(hist, fut126, fut585, all)

}

names(data_ipsl_CMIP5)


# check trends compared with Lotze
df<-data_ipsl_CMIP5$MACROECOLOGICAL$all %>% 
  filter(color %in% c("hist","ssp585"))

ggplot(df, aes(x=year, y = TcbChange))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_line(size=0.8) +
  geom_vline(xintercept = 2005.5, color = "grey60", size = 2)+
  geom_vline(xintercept = 2030, linetype = "dashed", color = "grey60", size = 1)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  # scale_y_continuous(limits = c(-26, 12),name = "Change in biomass (%)") +
  # scale_x_continuous(limits = c(1970, 2100), breaks = pretty(year, n = 10), name = "Year")+
  # scale_color_manual(values = c("black","blue" ,"red"), name = NULL, labels = c("Historical", "RCP2.6", "RCP8.6"))+
  theme_bw()+
  theme(text = element_text(size=12),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5, size=20),
        axis.text.y = element_text(angle=90, hjust=0.5, size=20),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        strip.text.x = element_text(face = "bold"),
        legend.position = c(0.15, 0.25),
        legend.key = element_rect(fill = "transparent", colour = "transparent"),
        legend.key.size = unit(0.4, "cm"))

# add ZOOM GFDL ----

directory_zoom<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/historical/"
filename<-"zoomss_ipsl-cm5a-lr_nobc_historical_nosoc_co2_tcb_global_annual_1950_2005.nc4"
yearmonth1 = NA
yearmonth2 = NA
hist<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

directory_zoom<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/future/"
filename<-"zoomss_ipsl-cm5a-lr_nobc_rcp26_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut126<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

filename<-"zoomss_ipsl-cm5a-lr_nobc_rcp85_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut585<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

all<-get_timeSeries(hist, fut126, fut585, output = "yearly")

data_ipsl_CMIP5$ZooMSS<-list(all = all)
rm(hist, fut126, fut585, all)

# extract data GFDL ---- 

h_years <-c(h_yearsB, h_yearsD, h_yearsE, h_yearsM)
f_years <-c(f_yearsB, f_yearsD, f_yearsE, f_yearsM)
f_years[3]<-"2006_2099" #  # ecoOcean changes 
output <-c(outputB, outputD, outputE, outputM)
oa <-c(oaB, oaD, oaE, oaM)

data_gfdl_CMIP5<-list()

for (i in 1:length(mod_gfdl)){

  # i = 2
  filename<-paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[2],"/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_hist_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], ".nc4")
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE)
  
  filename <- paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[3], "/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_rcp2p6_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  filename <- paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[3], "/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_rcp8p5_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  # apply function to extract time series
  all<-get_timeSeries(hist, fut126, fut585, output = output[i])
  
  data_gfdl_CMIP5[[i]]<-list(all = all)
  names(data_gfdl_CMIP5)[[i]]<-mod_gfdl[[i]]

  rm(hist, fut126, fut585, all)
  
}

names(data_gfdl_CMIP5)

## add ZOOM GFDL ----

directory_zoom<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/historical/"
filename<-"zoomss_gfdl-esm2m_nobc_historical_nosoc_co2_tcb_global_annual_1950_2005.nc4"
hist<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

directory_zoom<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/future/"
filename<-"zoomss_gfdl-esm2m_nobc_rcp26_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut126<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

filename<-"zoomss_gfdl-esm2m_nobc_rcp85_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut585<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

all<-get_timeSeries(hist, fut126, fut585, output = "yearly")

data_gfdl_CMIP5$ZooMSS<-list(all = all)
rm(hist, fut126, fut585, all)

```

# save outputs ISIMIP2b temp 

```{r}

save(data_ipsl_CMIP5, data_gfdl_CMIP5, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_trends_CMIP5.RData")

```

# extract data and calcaulte % change in time CMIP6 

```{r}

directory <- "/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/"

mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL", "EcoTroph", "FEISTY", "ZooMSS") 
mod_ipsl <- c("APECOSM","BOATS","DBPM","MACROECOLOGICAL","FEISTY","ZooMSS") 

# APECOSM ----
# to update 
h_yearsA <- "1850_2014"
f_yearsA<- "2015_2100"
earthA<-"_ipsl-esm4_nobc_" # will change ....
outputA<-"monthly"
extensionA<-".nc" 

# BOATS ----
h_yearsB <- "1950_2014"
f_yearsB<- "2015_2100"
earthB<-"_ipsl-cm6a-lr_nobc_"
outputB<-"monthly"
extensionB<-".nc"

# DBEM ----
# added below 

# DBPM ----
h_yearsDB <- "1850_2014"
f_yearsDB<- "2015_2100"
earthDB<-"_ipsl-cm6a-lr_nobasd_"
outputDB<-"monthly" 
extensionDB <-".nc"

# EcoOcean ----  
# added below  

# macroecological ----  
h_yearsM <- "1950_2014"
f_yearsM<- "2015-2100"
earthM<-"_ipsl-cm6a-lr_nobc_"
outputM<-"annual"
extensionM<-".nc"

# EcoTroph ----  
h_yearsE <- "1950-2014"
f_yearsE<- "2015-2100"
earthE<-"_ipsl-cm6a_nobc_"
outputE<-"annual"
extensionE<-".nc"
# added below

# FEISTY ----  
h_yearsF <- "1950_2014"
f_yearsF<- "2015_2100"
earthF<-"_ipsl-cm6a-lr_nobasd_" 
outputF<-"monthly"
extensionF<-".nc"

# ZooMSS ----  
h_yearsZ <- "1950_2014"
f_yearsZ<- "2015_2100"
earthZ<-"_ipsl-cm6a-lr_nobasd_"
outputZ<-"annual"
extensionZ<-".nc"

# extract data IPSL ---- 
h_years <-c(h_yearsA, h_yearsB, h_yearsDB, h_yearsM,h_yearsF, h_yearsZ) 
f_years <-c(f_yearsA, f_yearsB, f_yearsDB, f_yearsM,f_yearsF, f_yearsZ) 
earth <-c(earthA, earthB, earthDB, earthM, earthF, earthZ) 
output <-c(outputA, outputB, outputDB, outputM, outputF, outputZ) 
extension <-c(extensionA, extensionB, extensionDB,extensionM,extensionF,extensionZ) 

yearmonth1<-rep(NA, length(mod_ipsl))
yearmonth2<-rep(NA, length(mod_ipsl))
yearmonth1_fut<-rep(NA, length(mod_ipsl))
yearmonth2_fut<-rep(NA, length(mod_ipsl))

cmip = 6
data_ipsl_CMIP6<-list()

for (i in 1:length(mod_ipsl)){

  #i = 1
  filename<-paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[2],"/", tolower(mod_ipsl[i]), earth[i], "historical_nat_default_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], extension[i])
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)
  
  filename <- paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), earth[i], "ssp126_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE, CMIP = 6)
  
  filename <- paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), earth[i], "ssp585_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE,CMIP = 6)
  
  # apply function to extract time series
  all<-get_timeSeries(hist, fut126, fut585, output = output[i])

  data_ipsl_CMIP6[[i]]<-list(all = all)
  names(data_ipsl_CMIP6)[[i]]<-mod_ipsl[[i]]

  rm(hist, fut126, fut585, all126, hist_2, refDecade, fut585_2, all)
 
}

names(data_ipsl_CMIP6)

# add EcoTrpoh IPSL ----

# no need for specific function - the only thing is that the variable to extract is called "Band1" - you could adjust this in Batch_run_map.Rmd too 

filename<-"EcoTroph/_tmp/ipsl-cm6a-lr/future/ecotroph_ipsl-cm6a-lr_nobc_ssp585_nat_default_tcb_annual_1950_2100.nc"
combined<-extractFishCDF(directory, filename , "Band1", yearmonth1, yearmonth2, average_whole_period = FALSE, CMIP = 6)
# hist
start_point_to_extract = which(1971 == combined$years)
end_point_to_extract = which(2014 == combined$years)
hist<-combined
hist$fishvar <- hist$fishvar[, , start_point_to_extract:end_point_to_extract]
hist$years <- hist$years[start_point_to_extract:end_point_to_extract]
# 126
start_point_to_extract = which(2015 == combined$years)
end_point_to_extract = which(2100 == combined$years)
fut126<-combined
fut126$fishvar <- fut126$fishvar[, , start_point_to_extract:end_point_to_extract]
fut126$years <- fut126$years[start_point_to_extract:end_point_to_extract]
filename<-"EcoTroph/_tmp/ipsl-cm6a-lr/future/ecotroph_ipsl-cm6a-lr_nobc_ssp585_nat_default_tcb_annual_1950_2100.nc"
fut585<-extractFishCDF(directory, filename , "Band1", yearmonth1, yearmonth2, average_whole_period = FALSE, CMIP = 6)
fut585$fishvar <- fut585$fishvar[, , start_point_to_extract:end_point_to_extract]
fut585$years <- fut585$years[start_point_to_extract:end_point_to_extract]

output[i]<-outputE # different if annual or monthly data
all<-get_timeSeries(hist, fut126, fut585, output = "yearly")
data_ipsl_CMIP6$EcoTroph<-list(all = all)


# add EcoOcean IPSL ----

extractFishCDF_EcoOcean <- function(file, type = "hist"){
  
  # Open the netcdf file
  nc <- file # nc_open(paste(directory, filename, sep = ""))
  
  # Extract important information
  data_attributes <- "guess" # should be "tcb"
  main_title <- "guess"
  data_units <- "guess"
    
  lon <- lon # these are lat and long from EcoTroph above - random as not specified in these files. for the maps you considered lat and long for BOATS just because these data was readily available.   
  lat <- lat

  # time_vector <- convert_model_dates_CMIP6(nc, model_type) 
  time_months <- seq(1, dim(nc)[3])
  
  if(type == "hist"){
    yearmonth = as.yearmon("1949-12") + time_months[1] / 12
    }else{
      yearmonth = as.yearmon("2006-01") + time_months[1] / 12 # this should be 2015 for CMIP6 but these files adopted CMIP5 convention
      }

  time_months = as.yearmon(yearmonth + seq(0, (length(time_months) - 1)) / 12)     
  time_vector<-time_months
  print(time_months[1])
  print(time_months[length(time_months)])
  
  # extract all 
  new_var_mat <- nc
  years = time_vector
  
  # this should be done when we know the data units 
  new_var_mat = new_var_mat * 1000
  data_units = "kg km-2" 
  
  return_list <-
    list(
      main_title = main_title,
      data_units = data_units,
      lon = lon,
      lat = lat,
      years = years,
      fishvar = new_var_mat
    )
}

file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_historical_nosoc_default_tcb_global_monthly_1950-2005.RDS")
lon<-hist$lon # lat and long from EcoTroph above as missing for EcoOcean
lat<-hist$lat
hist<-extractFishCDF_EcoOcean(file, type = "hist")

file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_ssp126_nosoc_default_tcb_global_monthly_2006_2100.RDS")
fut126<-extractFishCDF_EcoOcean(file, type= "fut")

file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_ssp585_nosoc_default_tcb_global_monthly_2006_2100.RDS")
fut585<-extractFishCDF_EcoOcean(file, type= "fut")

output[i]<-"monthly" 
all<-get_timeSeries(hist, fut126, fut585, output = "monthly")
data_ipsl_CMIP6$EcoOcean<-list(all = all) # NOTE! fut585 might begin in 2006 and overlap with historical if they perfectly ovelap, consiedr this time historical, if they don't consider this time projections. 

# add DBEM IPSL ----

library(reshape2)

extractFishCDF_DBEM<-function(file, type = "hist"){
  
  # Extract important information
  main_title <- "guess"
  data_units <- "guess"
    
  lon <- unique(coord$lon)
  lat <- unique(coord$lat)

  time_vector <- seq(1951, 2100)

  print(time_vector[1])
  print(time_vector[length(time_vector)])

  # line 488 in original function
  # Create a new matrix to hold the results
  new_var_mat = array(rep(0, length(lon) * length(lat)), c(length(lon), length(lat)))
      
  # dimension and data format are different than for other models, so need different way of extracting data. 
  # GRID CELL X YEAR
  # transform to df
  df<-as.data.frame(file)
  colnames(df)<-time_vector
  df<-cbind(coord, df)
  years <-time_vector
  
  # cut history and future 
  if(type == "hist"){
    df2<-df %>% dplyr::select(lon, lat, "1971":"2014")
    df2<-gather(df2, year, tcb, "1971":"2014")
    start_point_to_extract = which(1971 == years)
    end_point_to_extract = which(2014 == years)
  } else{
    df2<-df %>% dplyr::select(lon, lat, "2015":"2100")
    df2<-gather(df2, year, tcb, "2015":"2100")
    start_point_to_extract = which(2015 == years)
    end_point_to_extract = which(2100 == years)
  }
  
  # to array
  new_var_mat<-acast(df2, lon~lat~year, value.var="tcb")
  # select only years considered
  years <- years[start_point_to_extract:end_point_to_extract]
  
  # this should be done when we know the data units 
  new_var_mat = new_var_mat * 1000
  data_units = "kg km-2" 
    
  return_list <- list(
        main_title = main_title,
        data_units = data_units,
        lon = lon,
        lat = lat,
        years = years,
        fishvar = new_var_mat
      )
}

coord<-read.delim("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/Lat_Lon.txt", header = FALSE, sep = ",")
colnames(coord)<-c("grid", "lon", "lat")
file<-load("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/C6IPSL26F0_t2_Abd.RData")
file<-sppfnlmap

hist<-extractFishCDF_DBEM(file, type = "hist")
fut126<-extractFishCDF_DBEM(file, type = "fut")

file<-load("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/C6IPSL85F0_t2_Abd.RData")
file<-sppfnlmap
fut585<-extractFishCDF_DBEM(file, type = "fut")

output[i]<-"annual" 
all<-get_timeSeries(hist, fut126, fut585, output = "yearly") # TO CHECK if the outputs are yearly or monthly
data_ipsl_CMIP6$DBEM<-list(all = all) 

# extract data GFDL ---- 

mod_gfdl <- c("BOATS","DBPM", "MACROECOLOGICAL","ZooMSS", "FEISTY") 

h_years <-c(h_yearsB,h_yearsDB, h_yearsM, h_yearsZ,h_yearsF) 
f_years <-c(f_yearsB,f_yearsDB, f_yearsM, f_yearsZ, f_yearsF) 
earth<-c("_gfdl-esm4_nobc_","_gfdl-esm4_nobasd_","_gfdl-esm4_nobc_","_gfdl-esm4_nobasd_","_gfdl-esm4_nobasd_")
output <-c(outputB,outputDB, outputM, outputZ, outputF) 
extension <-c(extensionB, extensionDB,extensionM, extensionZ, extensionF) 

data_gfdl_CMIP6<-list()

for (i in 1:length(mod_gfdl)){

  # i = 1
  filename<-paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[2],"/", tolower(mod_gfdl[i]), earth[i], "historical_nat_default_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], extension[i])
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)

  filename <- paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[3], "/", tolower(mod_gfdl[i]), earth[i], "ssp126_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE, CMIP = 6)
  
  filename <- paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[3], "/", tolower(mod_gfdl[i]), earth[i], "ssp585_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE,CMIP = 6)
  
  # apply function to extract time series
  all<-get_timeSeries(hist, fut126, fut585, output = output[i])

  data_gfdl_CMIP6[[i]]<-list(all = all)
  names(data_gfdl_CMIP6)[[i]]<-mod_gfdl[[i]]

  rm(hist, fut126, fut585, all126, hist_2, refDecade, fut585_2, all)
 
}

names(data_gfdl_CMIP6)

# add EcoTrpoh GFDL ----

filename<-"EcoTroph/_tmp/gfdl-esm4/future/ecotroph_gfdl-esm4_nobc_ssp126_nat_default_tcb_annual_1950_2100.nc"
combined<-extractFishCDF(directory, filename , "Band1", yearmonth1, yearmonth2, average_whole_period = FALSE, CMIP = 6)
# hist
start_point_to_extract = which(1971 == combined$years)
end_point_to_extract = which(2014 == combined$years)
hist<-combined
hist$fishvar <- hist$fishvar[, , start_point_to_extract:end_point_to_extract]
hist$years <- hist$years[start_point_to_extract:end_point_to_extract]
# 126
start_point_to_extract = which(2015 == combined$years)
end_point_to_extract = which(2100 == combined$years)
fut126<-combined
fut126$fishvar <- fut126$fishvar[, , start_point_to_extract:end_point_to_extract]
fut126$years <- fut126$years[start_point_to_extract:end_point_to_extract]
filename<-"EcoTroph/_tmp/gfdl-esm4/future/ecotroph_gfdl-esm4_nobc_ssp585_nat_default_tcb_annual_1950_2100.nc"
fut585<-extractFishCDF(directory, filename , "Band1", yearmonth1, yearmonth2, average_whole_period = FALSE, CMIP = 6)
fut585$fishvar <- fut585$fishvar[, , start_point_to_extract:end_point_to_extract]
fut585$years <- fut585$years[start_point_to_extract:end_point_to_extract]

output[i]<-outputE # different if annual or monthly data
all<-get_timeSeries(hist, fut126, fut585, output = "yearly")
data_gfdl_CMIP6$EcoTroph<-list(all = all)

# add EcoOcean GFDL ----

file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_gfdl_nobc_historical_nosoc_default_tcb_global_monthly_1950-2005.RDS")
lon<-hist$lon # lat and long from EcoTroph above as missing for EcoOcean
lat<-hist$lat
hist<-extractFishCDF_EcoOcean(file, type = "hist")

file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_gfdl_nobc_ssp126_nosoc_default_tcb_global_monthly_2006_2100.RDS")
fut126<-extractFishCDF_EcoOcean(file, type= "fut")

file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_gfdl_nobc_ssp585_nosoc_default_tcb_global_monthly_2006_2100.RDS")
fut585<-extractFishCDF_EcoOcean(file, type= "fut")

output[i]<-"monthly" 
all<-get_timeSeries(hist, fut126, fut585, output = "monthly")
data_gfdl_CMIP6$EcoOcean<-list(all = all) # NOTE! fut585 might begin in 2006 and overlap with historical if they perfectly ovelap, consiedr this time historical, if they don't consider this time projections. 

# add DBEM GFDL ----

file<-load("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/C6GFDL26F0_t2_Abd.RData")
file<-sppfnlmap
hist<-extractFishCDF_DBEM(file, type = "hist")
fut126<-extractFishCDF_DBEM(file, type = "fut")

file<-load("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/C6GFDL85F0_t2_Abd.RData")
file<-sppfnlmap
fut585<-extractFishCDF_DBEM(file, type = "fut")

output[i]<-"annual" 
all<-get_timeSeries(hist, fut126, fut585, output = "yearly") # TO CHECK if outputs = yearly 
data_gfdl_CMIP6$DBEM<-list(all = all) 


```

# save outputs ISIMIP3b temp 

```{r}

save(data_ipsl_CMIP6, data_gfdl_CMIP6, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_trends_CMIP6.RData")

```





# load data

```{r}

rm(list=ls())
load("/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_trends_CMIP5.RData")
load("/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_trends_CMIP6.RData")

```

# Load libraries for netcdf and define variables

```{r load CMIP5}

library(grid)
library(zoo)
library(viridis)
library(tidyr)
library(dplyr)
library(ggplot2)

source("/Users/camillan/R-projects/CMIP5vsCMIP6/R/HelperScripts.r")

# saving outputs location  
save_loc <- "/Users/camillan/Dropbox/CMIP5vsCMIP6/CMIP5vsCMIP6_figs/20210510/"

# variables 
cmip<-c("CMIP5", "CMIP6")
mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL")
mod_gfdl <- c("BOATS", "DBEM", "DBPM", "EcoOcean", "MACROECOLOGICAL")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")
variable_to_extract <-c("tcb","tpb", "bp30cm", "bp30to90cm", "bp90cm")


# fig ifo 
# CMIP5 esm: IPSL-CM5A-LR and GFDL-ESM2M 
# CMIP6 esm: IPSL-CM6A-LR and GFDL-ESM4
# 
# CMIP5 scenario: RCP2.6 AND RCP8.5 
# CMIP6 scenario: SSP1-2.6 and SSP5-8.5

```

# Deal with model set *pick the model set*

```{r}

# exclude DBPM CMIP6 anyways - need to update when white parallel lines problem is solved 
data_gfdl_CMIP6$DBPM<-NULL 

# ## otherwise as per Lotze model set + zoom (FIG 3 + 4)
# ## data_ipsl_CMIP5$ZooMSS<-NULL
# ## data_gfdl_CMIP5$ZooMSS<-NULL
# ## data_ipsl_CMIP6$ZooMSS<-NULL
# ## data_gfdl_CMIP6$ZooMSS<-NULL
# data_ipsl_CMIP6$FEISTY<-NULL
# data_gfdl_CMIP6$FEISTY<-NULL
# data_ipsl_CMIP6$EcoTroph<-NULL
# data_gfdl_CMIP6$EcoTroph<-NULL

```

# mean and sd of the above across models and ssp for both CMIP5 and CMIP6

```{r}

# CMIP5 
data_ipsl_CMIP5_tcb<-do.call(rbind, lapply(data_ipsl_CMIP5, as.data.frame)) 
data_ipsl_CMIP5_tcb<-data_ipsl_CMIP5_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_ipsl_CMIP5_tcb)), 
         cmip = 5, 
         earth = "ipsl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

data_gfdl_CMIP5_tcb<-do.call(rbind, lapply(data_gfdl_CMIP5, as.data.frame)) 
data_gfdl_CMIP5_tcb<-data_gfdl_CMIP5_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_gfdl_CMIP5_tcb)), 
         cmip = 5, 
         earth = "gfdl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))


# CMIP6
data_ipsl_CMIP6_tcb<-do.call(rbind, lapply(data_ipsl_CMIP6, as.data.frame)) 
data_ipsl_CMIP6_tcb<-data_ipsl_CMIP6_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_ipsl_CMIP6_tcb)), 
         cmip = 6, 
         earth = "ipsl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

# fix ecoOcean 
data_ipsl_CMIP6_tcb<-data_ipsl_CMIP6_tcb [-which(data_ipsl_CMIP6_tcb$model == "EcoOcean" & data_ipsl_CMIP6_tcb$year> 2005 & data_ipsl_CMIP6_tcb$year<2015 & data_ipsl_CMIP6_tcb$protocol == "ssp585"), ]

data_gfdl_CMIP6_tcb<-do.call(rbind, lapply(data_gfdl_CMIP6, as.data.frame)) 
data_gfdl_CMIP6_tcb<-data_gfdl_CMIP6_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_gfdl_CMIP6_tcb)), 
         cmip = 6, 
         earth = "gfdl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

# fix ecoOcean 
data_gfdl_CMIP6_tcb<-data_gfdl_CMIP6_tcb [-which(data_gfdl_CMIP6_tcb$model == "EcoOcean" & data_gfdl_CMIP6_tcb$year> 2005 & data_gfdl_CMIP6_tcb$year<2015 & data_gfdl_CMIP6_tcb$protocol == "ssp585"), ]

# add all together and  mean  it
# how is this average? here is all together 
all<-data_ipsl_CMIP5_tcb %>% 
  full_join(data_gfdl_CMIP5_tcb) %>% 
  full_join(data_ipsl_CMIP6_tcb) %>% 
  full_join(data_gfdl_CMIP6_tcb) %>% 
  group_by(protocol, year, cmip) %>% 
  summarise(mean = mean(tcbChange, na.rm = TRUE), 
            sd = sd(tcbChange, na.rm = TRUE)) %>% 
  mutate(sd_min = mean - sd, 
         sd_max = mean + sd) 

# how is this average? here is first by earth model than between the two CMIPs but no SD in this case...
# all_ipsl<-data_ipsl_CMIP5_tcb %>% 
#   full_join(data_ipsl_CMIP6_tcb) %>% 
#   group_by(protocol, year, cmip, earth) %>% 
#   summarise(mean = mean(tcbChange, na.rm = TRUE), 
#             sd = sd(tcbChange, na.rm = TRUE))
# 
# all_gfdl<-data_gfdl_CMIP5_tcb %>% 
#   full_join(data_gfdl_CMIP6_tcb) %>% 
#   group_by(protocol, year, cmip, earth) %>% 
#   summarise(mean = mean(tcbChange, na.rm = TRUE), 
#             sd = sd(tcbChange, na.rm = TRUE)) 
#
# all<-all_ipsl %>% 
#   full_join(all_gfdl) %>% 
#   group_by(protocol, year, cmip) %>% 
#   summarise(mean = mean(mean, na.rm = TRUE), 
#             sd = sd(mean, na.rm = TRUE)) %>% 
#   mutate(sd_min = mean - sd, 
#          sd_max = mean + sd) 

# create dots when CMIP6 < CMIP6 
trial<-all %>% 
  dplyr::select(cmip, mean, protocol, year) %>%
  spread(cmip, mean) %>% 
  mutate(A = ifelse(`6`< `5`,`5`, NA)) %>% 
  gather("cmip","mean", -c(protocol, year, A)) %>% 
  mutate(cmip = as.numeric(cmip))

all<-all %>% 
  full_join(trial)

```

# FIG 3 or S4: trends in tcb  

```{r}

# transform in functions and move to Funcs_plot.r 

# CMIP5 esm: IPSL-CM5A-LR and GFDL-ESM2M 
# CMIP6 esm: IPSL-CM6A-LR and GFDL-ESM4
# 
# CMIP5 scenario: RCP2.6 AND RCP8.5 
# CMIP6 scenario: SSP1-2.6 and SSP5-8.5

a<-ggplot(filter(all, cmip==5), aes(group = protocol, x=year,y = mean, ymin = sd_min, ymax = sd_max))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_ribbon(aes(fill = protocol), alpha=0.2)+
  geom_line(aes(color = protocol)) +
  geom_vline(xintercept = 2005.5, color = "grey60", size = 2)+
  # geom_vline(xintercept = 2030, linetype = "dashed", color = "grey60", size = 1)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-30, 6), breaks = pretty(seq(15, -30), n = 10), name = "Change in biomass (%)") +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  scale_color_manual(values = c("black","blue" ,"red"), name = "Scenarios", labels = c("Historical", "RCP2.6", "RCP8.6"))+
  scale_fill_manual(values = c("black","blue" ,"red"), name = "Scenarios", labels = c("Historical", "RCP2.6", "RCP8.6"))+
  theme_bw()+
  theme(text = element_text(size=20),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5),
        panel.grid.minor = element_blank(),
        # legend.background=element_blank(),
        panel.border = element_rect(colour = "black"),
        # OR: 
        # axis.line = element_line(colour = "black"),
        # panel.border = element_blank(),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        legend.position = c(0.13, 0.3))



b<-ggplot(filter(all, cmip==6), aes(group = protocol, x=year, y = mean))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_ribbon(aes(ymin = sd_min, ymax = sd_max, fill = protocol), alpha=0.2)+
  geom_line(aes(color = protocol)) +
  geom_point(aes(y = A, color = protocol), size = 0.8)+
  geom_vline(xintercept = 2015, color = "grey60", size = 2)+
  # geom_vline(xintercept = 2030, linetype = "dashed", color = "grey60", size = 1)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-30, 6), breaks = pretty(seq(15, -30), n = 10), name = NULL) +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  scale_color_manual(values = c("black","blue" ,"red"), name = "Scenarios", labels = c("Historical", "SSP1-2.6", "SSP5-8.5"))+
  scale_fill_manual(values = c("black","blue" ,"red"), name = "Scenarios", labels = c("Historical", "SSP1-2.6", "SSP5-8.5"))+
  theme_bw()+
  theme(text = element_text(size=20),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_rect(colour = "black"),
        strip.text.x = element_text(face = "bold"),
        legend.position = c(0.13, 0.3))
# b

library(patchwork)

layout <- "
AB
"

a<-a + ggtitle("a) CMIP5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b<-b + ggtitle("b) CMIP6") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0))

plot<-a + b + 
  plot_layout(design = layout)

# pdf(paste0(save_loc,"Fig3_noApecosm.pdf"), height=6.5, width=15) # older name
pdf(paste0(save_loc,"FigS4.pdf"), height=6.5, width=15) # CONSIDER ALL MODELS
plot
dev.off()

# pdf(paste0(save_loc,"Fig3.pdf"), height=6.5, width=15) # CONSIDER LOTZE model set
# plot
# dev.off()

# last values caclualted considering LOTZE models SET
lastDecade<-filter(all, year >= 2090, year <= 2099) %>% 
  group_by(cmip, protocol) %>% 
  summarise(mean2 = mean(mean), 
            sd2 = mean(sd))

lastYear<-filter(all, year == 2099) 

```

# FIG 4 or S9: trends in tcb by model and esm 

lots of copy-paste but code is all the same... need to clean! 

```{r}

# CMIP5 esm: IPSL-CM5A-LR and GFDL-ESM2M 
# CMIP6 esm: IPSL-CM6A-LR and GFDL-ESM4
# 
# CMIP5 scenario: RCP2.6 AND RCP8.5 
# CMIP6 scenario: SSP1-2.6 and SSP5-8.5

# add all together and  mean  it
all_models<-data_ipsl_CMIP5_tcb %>%
  full_join(data_gfdl_CMIP5_tcb) %>%
  full_join(data_ipsl_CMIP6_tcb) %>%
  full_join(data_gfdl_CMIP6_tcb)

all_models_85<-all_models %>% 
  filter(protocol %in% c("hist", "ssp585")) %>% 
  droplevels()

all_models_26<-all_models %>% 
  filter(protocol %in% c("hist", "ssp126")) %>% 
  droplevels()

# color code 
#sort(unique(all_models$model))
df<-data.frame(model = c("APECOSM","BOATS","DBEM","DBPM","EcoOcean","FEISTY","EcoTroph","MACROECOLOGICAL","ZooMSS"), color = c("red","blue", "lightblue","black", "pink","purple","brown","green","orange"))
df_cmip5ipsl<-df %>% filter(model %in% unique(filter(all_models, cmip==5, earth =="ipsl")$model))
df_cmip5gfdl<-df %>% filter(model %in% unique(filter(all_models, cmip==5, earth =="gfdl")$model))
df_cmip6ipsl<-df %>% filter(model %in% unique(filter(all_models, cmip==6, earth =="ipsl")$model))
df_cmip6gfdl<-df %>% filter(model %in% unique(filter(all_models, cmip==6, earth =="gfdl")$model))

plot_trends<-function(all_models){
  
a1<-ggplot(filter(all_models, cmip==5, earth =="ipsl"), aes(x=year, y = tcbChange,  color = model))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_line(size=1) +
  geom_vline(xintercept = 2005.5, color = "grey60", size = 2)+
  # geom_vline(xintercept = 2030, linetype = "dashed", color = "grey60", size = 1)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-35, 6), breaks = pretty(seq(20, -40), n = 10), name = "Change in biomass (%)") + 
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  # scale_color_manual(values = c("red","blue", "lightblue","black", "pink","green", "orange"), name = "Models") +
  scale_color_manual(values = df_cmip5ipsl$color, name = "Ecosystem Models") +
  theme_bw()+
  theme(text = element_text(size=14),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5, size=16),
        axis.text.y = element_text(angle=0, size=16),
        panel.border = element_rect(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        # legend.background=element_blank(),
        legend.position = c(0.17, 0.4),
        legend.key.size = unit(0.6, "cm"))


b1<-ggplot(filter(all_models, cmip==6, earth =="ipsl"), aes(x=year, y = tcbChange,  color = model))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_line(size=1) +
  geom_vline(xintercept = 2015, color = "grey60", size = 2)+
  # geom_vline(xintercept = 2030, linetype = "dashed", color = "grey60", size = 1)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-35, 6), breaks = pretty(seq(20, -40), n = 10), name = "Change in biomass (%)") +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year-1, n = 10), name = "Year")+
  scale_color_manual(values = df_cmip6ipsl$color, name = "Ecosystem Models") +
  theme_bw()+
  theme(text = element_text(size=14),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5, size=16),
        axis.text.y = element_text(angle=0, size=16),
        panel.border = element_rect(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        # legend.background=element_blank(),
        legend.position = c(0.17, 0.4),
        legend.key.size = unit(0.6, "cm"))


a2<-ggplot(filter(all_models, cmip==5, earth =="gfdl"), aes(x=year, y = tcbChange,  color = model))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_line(size=1) +
  geom_vline(xintercept = 2005.5, color = "grey60", size = 2)+
  # geom_vline(xintercept = 2030, linetype = "dashed", color = "grey60", size = 1)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-35, 6), breaks = pretty(seq(20, -40), n = 10), name = "Change in biomass (%)") + 
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  scale_color_manual(values = df_cmip5gfdl$color, name = "Ecosystem Models") +
  theme_bw()+
  theme(text = element_text(size=14),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5, size=16),
        axis.text.y = element_text(angle=0, size=16),
        panel.border = element_rect(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        # legend.background=element_blank(),
        legend.position = c(0.17, 0.4),
        legend.key.size = unit(0.6, "cm"))


b2<-ggplot(filter(all_models, cmip==6, earth =="gfdl"), aes(x=year, y = tcbChange,  color = model))+
  annotate("rect", xmin = 1990, xmax = 2000, ymin = -Inf, ymax = Inf, alpha = .2)+
  geom_line(size=1) +
  geom_vline(xintercept = 2015, color = "grey60", size = 2)+
  # geom_vline(xintercept = 2030, linetype = "dashed", color = "grey60", size = 1)+
  geom_hline(yintercept = 0, color = "grey60", size = 1)+
  scale_y_continuous(limits = c(-35, 6), breaks = pretty(seq(20, -40), n = 10), name = "Change in biomass (%)") +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year-1, n = 10), name = "Year")+
  scale_color_manual(values = df_cmip6gfdl$color, name = "Ecosystem Models") +
  theme_bw()+
  theme(text = element_text(size=14),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5, size=16),
        axis.text.y = element_text(angle=0, size=16),
        panel.border = element_rect(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        strip.text.x = element_text(face = "bold"),
        # legend.background=element_blank(),
        legend.position = c(0.17, 0.4),
        legend.key.size = unit(0.6, "cm"))

return(list(a1 =a1 , b1 =b1, a2 = a2, b2 = b2))
}

res<-plot_trends(all_models_85)
a1 = res$a1
b1 = res$b1
a2 = res$a2
b2 = res$b2

layout <- "
AB
CD
"

a1<-a1 + ggtitle("a) CMIP5 IPSL-CM5A-LR") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0), axis.title.x = element_blank())
b1<-b1 + ggtitle("b) CMIP6 IPSL-CM6A-LR") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0), axis.title.x = element_blank(), axis.title.y = element_blank())
a2<-a2 + ggtitle("c) CMIP5 GFDL-ESM2M") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b2<-b2 + ggtitle("d) CMIP6 GFDL-ESM4") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0), axis.title.y = element_blank()) # legend.position = "none"

plot<-a1 + b1 + a2 + b2 + 
  plot_layout(design = layout)

# # pdf(paste0(save_loc,"Fig3B_noApecosm.pdf"), height=6.5, width=15) # old name
pdf(paste0(save_loc,"FigS9.pdf"), height=12, width=15) # CONSIDER ALL MODELS
plot
dev.off()

# pdf(paste0(save_loc,"Fig4.pdf"), height=12, width=15) # CONSIDER LOTZE MODEL SET
# plot
# dev.off()

# 2.6 scenario
res<-plot_trends(all_models_26)
a1 = res$a1
b1 = res$b1
a2 = res$a2
b2 = res$b2

layout <- "
AB
CD
"

a1<-a1 + ggtitle("a) CMIP5 IPSL-CM5A-LR") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0), axis.title.x = element_blank())
b1<-b1 + ggtitle("b) CMIP6 IPSL-CM6A-LR") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0), axis.title.x = element_blank(), axis.title.y = element_blank())
a2<-a2 + ggtitle("c) CMIP5 GFDL-ESM2M") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b2<-b2 + ggtitle("d) CMIP6 GFDL-ESM4") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0), axis.title.y = element_blank()) # legend.position = "none"

plot<-a1 + b1 + a2 + b2 + 
  plot_layout(design = layout)

# # pdf(paste0(save_loc,"Fig3B_noApecosm.pdf"), height=6.5, width=15) # old name
pdf(paste0(save_loc,"FigS9_126.pdf"), height=12, width=15) # CONSIDER ALL MODELS
plot
dev.off()

# pdf(paste0(save_loc,"Fig4_126.pdf"), height=12, width=15) # CONSIDER LOTZE MODEL SET
# plot
# dev.off()

```



