---
title: "Plotting global models outputs"
author: "Camilla Novaglio"
date: "04/11/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

# TO DO 

DBEM before Xmas

EcoOcean netcdf in progress - Ryan

work on DBPM -> check senescence + fix netcdf (OK but see discussion on re-run)

# TO CHECK 
time series for CMIP6 where ssp585 does not start where historical ends 

# Load libraries for netcdf and define variables

```{r load CMIP5}

rm(list=ls())
library(grid)
library(zoo)
library(viridis)
library(tidyr)
library(dplyr)

source("/Users/nov017/R-projects/CMIP5vsCMIP6/R/HelperScripts.r")

# saving outputs location  
save_loc <- "/Users/nov017/Dropbox/CMIP5vsCMIP6/figs/"

# variables 
cmip<-c("CMIP5", "CMIP6")
mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL")
mod_gfdl <- c("BOATS", "DBEM", "EcoOcean", "MACROECOLOGICAL")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")
variable_to_extract <-c("tcb","tpb", "bp30cm", "bp30to90cm", "bp90cm")

```

# extract data and calcaulte % change in time CMIP5 

```{r}

# CMIP5 data location
directory = "/Users/nov017/fishmip_outputs/marine-fishery_global_ISIMIP2b/"

# APECOSM ----
h_yearsA <- "1950_2005"
f_yearsA<- "2006_2100"
outputA<-"monthly"
oaA<-"no-oa"

# BOATS ----
h_yearsB <- "1971_2005"
f_yearsB<- "2006_2099"
outputB<-"monthly"
oaB<-"no-oa"

# DBEM ----
h_yearsD <- "1951_2005"
f_yearsD<- "2006_2099"
outputD<-"annual"
oaD<-"oa"

# DBPM ----
h_yearsDB <- "1950_2005"
f_yearsDB<- "2006_2100"
outputDB<-"monthly"
oaDB<-"no-oa"

# EcoOcean ----  
h_yearsE <- "1971_2005"
f_yearsE<- "2006_2100"
outputE<-"monthly"
oaE<-"no-oa"

# macroecological ----  
h_yearsM <- "1950_2005"
f_yearsM<- "2006_2100"
outputM<-"annual"
oaM<-"no-oa"

# extract data IPSL ---- 
h_years <-c(h_yearsA, h_yearsB, h_yearsD, h_yearsDB, h_yearsE, h_yearsM)
f_years <-c(f_yearsA, f_yearsB, f_yearsD, f_yearsDB, f_yearsE, f_yearsM)
output <-c(outputA, outputB, outputD, outputDB, outputE, outputM)
oa <-c(oaA, oaB, oaD, oaDB, oaE, oaM)

# extract all years 
yearmonth1<-rep(NA, length(mod_ipsl))
yearmonth2<-rep(NA, length(mod_ipsl))
yearmonth1_fut<-rep(NA, length(mod_ipsl))
yearmonth2_fut<-rep(NA, length(mod_ipsl))
cmip = 5

# 2 ways of doing  this: 
# option 1: use averageFishCDF(average_whole_period = FALSE) which extracts data and merges info by month if the  model's output is monthly. Then merge info by grid cell in get_timeSgeteries() 
# option 2: use extractFishCDF() which extracts everything without manipulation data. Then merge info by month and grid cell all together in get_timeSgeteries() - i.e. option 2 - you don't mean twice: by months first -> lat long year; and by year next -> year. you only mean once: by year -> year. Results slightly change but the process is much faster. Need to merge this with the codes that produces maps so that you extract data only once and process it both ways. 
# CN note: what's the deal with DBEM? a huge average of everything in terms of grids - should I consider 1 value every 2 grids as per maps?

data_ipsl_CMIP5<-list()

for (i in 1:length(mod_ipsl)){

  # i = 3
  filename<-paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[2],"/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_hist_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], ".nc4")
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE)
  # dim(hist$fishvar)

  filename <- paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_rcp2p6_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  filename <- paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_rcp8p5_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
   
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  # apply function to extract time series
  all<-get_timeSgeteries(hist, fut126, fut585)

  data_ipsl_CMIP5[[i]]<-list(all = all)
  names(data_ipsl_CMIP5)[[i]]<-mod_ipsl[[i]]

  rm(hist, fut126, fut585, all126, hist_2, refDecade, fut585_2, all)

}

names(data_ipsl_CMIP5)

# add ZOOM GFDL ----

directory_zoom<-"/Users/nov017/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/historical/"
filename<-"zoomss_ipsl-cm5a-lr_nobc_historical_nosoc_co2_tcb_global_annual_1950_2005.nc4"
yearmonth1 = NA
yearmonth2 = NA
hist<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

directory_zoom<-"/Users/nov017/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/future/"
filename<-"zoomss_ipsl-cm5a-lr_nobc_rcp26_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut126<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

filename<-"zoomss_ipsl-cm5a-lr_nobc_rcp85_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut585<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

all<-get_timeSgeteries(hist, fut126, fut585)

data_ipsl_CMIP5$ZooMSS<-list(all = all)
rm(hist, fut126, fut585, all)

# extract data GFDL ---- 

h_years <-c(h_yearsB, h_yearsD, h_yearsE, h_yearsM)
f_years <-c(f_yearsB, f_yearsD, f_yearsE, f_yearsM)
f_years[3]<-"2006_2099" #  # ecoOcean changes 
output <-c(outputB, outputD, outputE, outputM)
oa <-c(oaB, oaD, oaE, oaM)

data_gfdl_CMIP5<-list()

for (i in 1:length(mod_gfdl)){

  # i = 2
  filename<-paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[2],"/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_hist_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], ".nc4")
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE)
  
  filename <- paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[3], "/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_rcp2p6_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  filename <- paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[3], "/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_rcp8p5_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE)
  
  # apply function to extract time series
  all<-get_timeSgeteries(hist, fut126, fut585)
  
  data_gfdl_CMIP5[[i]]<-list(all = all)
  names(data_gfdl_CMIP5)[[i]]<-mod_gfdl[[i]]

  rm(hist, fut126, fut585, all)
  
}

names(data_gfdl_CMIP5)

## add ZOOM GFDL ----

directory_zoom<-"/Users/nov017/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/historical/"
filename<-"zoomss_gfdl-esm2m_nobc_historical_nosoc_co2_tcb_global_annual_1950_2005.nc4"
hist<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

directory_zoom<-"/Users/nov017/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/future/"
filename<-"zoomss_gfdl-esm2m_nobc_rcp26_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut126<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

filename<-"zoomss_gfdl-esm2m_nobc_rcp85_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut585<-extractFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = FALSE)

all<-get_timeSgeteries(hist, fut126, fut585)

data_gfdl_CMIP5$ZooMSS<-list(all = all)
rm(hist, fut126, fut585, all)

```

# Deal with DBEM

```{r}

# remove

data_ipsl_CMIP5$DBEM<-NULL
data_gfdl_CMIP5$DBEM<-NULL

```

# extract data and calcaulte % change in time CMIP6 

```{r}

directory <- "/Users/nov017/fishmip_outputs/marine-fishery_global_ISIMIP3b/"

mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL", "EcoTroph", "FEISTY", "ZooMSS") 
mod_ipsl <- c("APECOSM","BOATS","DBPM","MACROECOLOGICAL","FEISTY","ZooMSS") 

# APECOSM ----
# to update 
h_yearsA <- "1950_2014"
f_yearsA<- "2015_2100"
earthA<-"_ipsl-cm6a-lr_nobasd_"
outputA<-"monthly"
extensionA<-".nc" 

# BOATS ----
h_yearsB <- "1950_2014"
f_yearsB<- "2015_2100"
earthB<-"_ipsl-cm6a-lr_nobc_"
outputB<-"monthly"
extensionB<-".nc"

# DBEM ----
# coming mid Nov 

# DBPM ----
h_yearsDB <- "1850_2014"
f_yearsDB<- "2015_2100"
earthDB<-"_ipsl_cm6a_lr_nobc_"
outputDB<-"monthly" # Spelling error fixed in new netcdf and now manually fixed in files
extensionDB <-".nc4"

# EcoOcean ----  
# still in csv 

# macroecological ----  
h_yearsM <- "1950_2014"
f_yearsM<- "2015-2100"
earthM<-"_ipsl-cm6a-lr_nobc_"
outputM<-"annual"
extensionM<-".nc"

# EcoTroph ----  
h_yearsE <- "1950-2014"
f_yearsE<- "2015-2100"
earthE<-"_ipsl-cm6a_nobc_"
outputE<-"annual"
extensionE<-".nc"

# FEISTY ----  
h_yearsF <- "1950_2014"
f_yearsF<- "2015_2100"
earthF<-"_ipsl-cm6a-lr_nobasd_" 
outputF<-"monthly"
extensionF<-".nc"

# ZooMSS ----  
h_yearsZ <- "1950_2014"
f_yearsZ<- "2015_2100"
earthZ<-"_ipsl-cm6a-lr_nobasd_"
outputZ<-"annual"
extensionZ<-".nc"

# extract data IPSL ---- 
h_years <-c(h_yearsA, h_yearsB, h_yearsDB, h_yearsM,h_yearsF, h_yearsZ) 
f_years <-c(f_yearsA, f_yearsB, f_yearsDB, f_yearsM,f_yearsF, f_yearsZ) 
earth <-c(earthA, earthB, earthDB, earthM, earthF, earthZ) 
output <-c(outputA, outputB, outputDB, outputM, outputF, outputZ) 
extension <-c(extensionA, extensionB, extensionDB,extensionM,extensionF,extensionZ) 

cmip = 6
data_ipsl_CMIP6<-list()

for (i in 1:length(mod_ipsl)){

  # i = 2
  filename<-paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[2],"/", tolower(mod_ipsl[i]), earth[i], "historical_nat_default_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], extension[i])
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)
  
  filename <- paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), earth[i], "ssp126_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE, CMIP = 6)
  
  filename <- paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), earth[i], "ssp585_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE,CMIP = 6)
  
  # apply function to extract time series
  all<-get_timeSgeteries(hist, fut126, fut585)

  data_ipsl_CMIP6[[i]]<-list(all = all)
  names(data_ipsl_CMIP6)[[i]]<-mod_ipsl[[i]]

  rm(hist, fut126, fut585, all126, hist_2, refDecade, fut585_2, all)
 
}

names(data_ipsl_CMIP6)

# add EcoTrpoh IPSL ----

# hist is the beginning of the future files and  I am assuming is the same for both futures 
filename_E<-"EcoTroph/_tmp/ipsl-cm6a-lr/future/ecotroph_ipsl-cm6a-lr_nobc_ssp126_nat_default_tcb_annual_1950_2100.nc"
fut126<-extractFishCDF(directory, filename_E , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)
# cut into hist and  fut

filename_E<-"EcoTroph/_tmp/ipsl-cm6a-lr/future/ecotroph_ipsl-cm6a-lr_nobc_ssp585_nat_default_tcb_annual_1950_2100.nc"
fut585<-extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)
# delete hist from this file 

# apply function to extract time series
all<-get_timeSgeteries(hist, fut126, fut585)

data_ipsl_CMIP6$EcoTroph<-list(all = all)

rm(hist, fut126, fut585, all126, hist_2, refDecade, fut585_2, all)

# extract data GFDL ---- 

mod_gfdl <- c("BOATS", "MACROECOLOGICAL","ZooMSS", "FEISTY") 

h_years <-c(h_yearsB, h_yearsM, h_yearsZ,h_yearsF) 
f_years <-c(f_yearsB, f_yearsM, f_yearsZ, f_yearsF) 
earth<-c("_gfdl-esm4_nobc_","_gfdl-esm4_nobc_","_gfdl-esm4_nobasd_","_gfdl-esm4_nobasd_")
output <-c(outputB, outputM, outputZ, outputF) 
extension <-c(extensionB, extensionM, extensionZ, extensionF) 

data_gfdl_CMIP6<-list()

for (i in 1:length(mod_gfdl)){

  # i = 1
  filename<-paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[2],"/", tolower(mod_gfdl[i]), earth[i], "historical_nat_default_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], extension[i])
  
  hist<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)

  filename <- paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[3], "/", tolower(mod_gfdl[i]), earth[i], "ssp126_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut126<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE, CMIP = 6)
  
  filename <- paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[3], "/", tolower(mod_gfdl[i]), earth[i], "ssp585_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut585<- extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = FALSE,CMIP = 6)
  
  # apply function to extract time series
  all<-get_timeSgeteries(hist, fut126, fut585)

  data_gfdl_CMIP6[[i]]<-list(all = all)
  names(data_gfdl_CMIP6)[[i]]<-mod_gfdl[[i]]

  rm(hist, fut126, fut585, all126, hist_2, refDecade, fut585_2, all)
 
}

names(data_gfdl_CMIP6)

# add EcoTrpoh IPSL ----

# hist is the beginning of the future files and  I am assuming is the same for both futures 
filename_E<-"EcoTroph/_tmp/gfdl-esm4/future/ecotroph_gfdl-esm4_nobc_ssp126_nat_default_tcb_annual_1950_2100.nc"
fut126<-extractFishCDF(directory, filename_E , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)
# cut into hist and  fut

filename_E<-"EcoTroph/_tmp/gfdl-esm4/future/ecotroph_gfdl-esm4_nobc_ssp585_nat_default_tcb_annual_1950_2100.nc"
fut585<-extractFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = FALSE, CMIP =  6)
# delete hist from this file 

# apply function to extract time series
all<-get_timeSgeteries(hist, fut126, fut585)

data_gfdl_CMIP6$EcoTroph<-list(all = all)

rm(hist, fut126, fut585, all126, hist_2, refDecade, fut585_2, all)

```

# mean and sd of the above across models and ssp for both CMIP5 and CMIP6

```{r}

# CMIP5 
data_ipsl_CMIP5_tcb<-do.call(rbind, lapply(data_ipsl_CMIP5, as.data.frame)) 
data_ipsl_CMIP5_tcb<-data_ipsl_CMIP5_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_ipsl_CMIP5_tcb)), 
         cmip = 5, 
         earth = "ipsl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

data_gfdl_CMIP5_tcb<-do.call(rbind, lapply(data_gfdl_CMIP5, as.data.frame)) 
data_gfdl_CMIP5_tcb<-data_gfdl_CMIP5_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_gfdl_CMIP5_tcb)), 
         cmip = 5, 
         earth = "gfdl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

# CMIP6
data_ipsl_CMIP6_tcb<-do.call(rbind, lapply(data_ipsl_CMIP6, as.data.frame)) 
data_ipsl_CMIP6_tcb<-data_ipsl_CMIP6_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_ipsl_CMIP6_tcb)), 
         cmip = 6, 
         earth = "ipsl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

data_gfdl_CMIP6_tcb<-do.call(rbind, lapply(data_gfdl_CMIP6, as.data.frame)) 
data_gfdl_CMIP6_tcb<-data_gfdl_CMIP6_tcb %>% 
  mutate(model = gsub("[^a-zA-Z]", "", rownames(data_gfdl_CMIP6_tcb)), 
         cmip = 6, 
         earth = "gfdl") %>% 
  `colnames<-`(c("year", "tcb", "tcbChange", "protocol", "model", "cmip", "earth"))

# why empty  values in plot below? ssp585 missing for both 
filter(data_ipsl_CMIP6_tcb, year >2005 & year<2015)
filter(data_gfdl_CMIP6_tcb, year >2005 & year<2015)
filter(data_ipsl_CMIP6$MACROECOLOGICAL$all, color == "hist") #  it starts from 2016.... because it's where projections should  start!!!!!! 

View(data_ipsl_CMIP6$MACROECOLOGICAL$all)

# add all together and  mean  it
# how is this average? is it first by earth model and then between earth models? 
all<-data_ipsl_CMIP5_tcb %>% 
  full_join(data_gfdl_CMIP5_tcb) %>% 
  full_join(data_ipsl_CMIP6_tcb) %>% 
  full_join(data_gfdl_CMIP6_tcb) %>% 
  group_by(protocol, year, cmip) %>% 
  summarise(mean = mean(tcbChange, na.rm = TRUE), 
            sd = sd(tcbChange, na.rm = TRUE)) %>% 
  mutate(sd_min = mean - sd, 
         sd_max = mean + sd)

```

# plot trends in tcb  

```{r}

# try  plotting ... kind of, but steeper declines in ssp585 in Lotze (-18% instead of -14%). Can be due to the averaging here or to the averaging in functions above. Same for spp126, which ends at -5% in Lotze and -4% here.  
ggplot(all, aes(x=year, y = mean,  color = protocol))+
  geom_line()+
  facet_wrap(~cmip)

# transform in functions and move to Funcs_plot.r 

a<-ggplot(filter(all, cmip==5), aes(group = protocol, x=year,y = mean, ymin = sd_min, ymax = sd_max))+
  geom_ribbon(aes(fill = protocol), alpha=0.2)+
  geom_line(aes(color = protocol)) +
  geom_vline(xintercept = 2005.5, color = "grey80", size = 2)+
  geom_vline(xintercept = 2030, linetype = "dashed", color = "grey80", size = 1)+
  geom_hline(yintercept = 0, color = "grey80", size = 1)+
  scale_y_continuous(limits = c(-26, 5),name = "Change in biomass (%)") +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  scale_color_manual(values = c("black","blue" ,"red"), name = NULL, labels = c("Historical", "RCP2.6", "RCP8.6"))+
  scale_fill_manual(values = c("black","blue" ,"red"), name = NULL, labels = c("Historical", "RCP2.6", "RCP8.6"))+
  theme_bw()+
  theme(text = element_text(size=20),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        strip.text.x = element_text(face = "bold"),
        legend.position = c(0.15, 0.2),
        legend.key = element_rect(fill = "transparent", colour = "transparent"))
  
b<-ggplot(filter(all, cmip==6), aes(group = protocol, x=year,y = mean, ymin = sd_min, ymax = sd_max))+
  geom_ribbon(aes(fill = protocol), alpha=0.2)+
  geom_line(aes(color = protocol)) +
  geom_vline(xintercept = 2015, color = "grey80", size = 2)+
  geom_vline(xintercept = 2030, linetype = "dashed", color = "grey80", size = 1)+
  geom_hline(yintercept = 0, color = "grey80", size = 1)+
  scale_y_continuous(limits = c(-26, 5),name = "") +
  scale_x_continuous(limits = c(1970, 2100), breaks = pretty(all$year, n = 10), name = "Year")+
  scale_color_manual(values = c("black","blue" ,"red"), name = "", labels = c("Historical", "RCP2.6", "RCP8.6"))+
  scale_fill_manual(values = c("black","blue" ,"red"), name = "", labels = c("Historical", "RCP2.6", "RCP8.6"))+
  theme_bw()+
  theme(text = element_text(size=20),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        strip.text.x = element_text(face = "bold"),
        legend.position = "none")
  


library(patchwork)

# FIG 2 trends in tcb CMIP5 vs CMIP6
layout <- "
AB
"

a<-a + ggtitle("A) CMIP5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b<-b + ggtitle("B) CMIP6") + theme(plot.title = element_text(size = 16, face = "bold",hjust = 0))

plot<-a + b + 
  plot_layout(design = layout)

pdf(paste0(save_loc,"Fig3.pdf"), height=7, width=15)
plot 
dev.off()

```



