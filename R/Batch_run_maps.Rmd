---
title: "Plotting global models outputs"
author: "Camilla Novaglio"
date: "04/11/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load libraries for netcdf and define variables

```{r load CMIP5}

rm(list=ls())
library(grid)
library(zoo)
library(viridis)
library(tidyr)
library(dplyr)

source("/Users/camillan/R-projects/CMIP5vsCMIP6/R/HelperScripts.r")
source("/Users/camillan/R-projects/CMIP5vsCMIP6/R/Funcs_maps.r")

# saving outputs location  
save_loc <- "/Users/camillan/Dropbox/CMIP5vsCMIP6/CMIP5vsCMIP6_figs/"

# variables 
cmip<-c("CMIP5", "CMIP6")
mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL")
mod_gfdl <- c("BOATS", "DBEM", "EcoOcean", "MACROECOLOGICAL")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")
variable_to_extract <-c("tcb","tpb", "bp30cm", "bp30to90cm", "bp90cm")

```

# load libraries for plotting and define criteria 

```{r}

# Define color/legend limits 
main_plot_colour_values = c(0,10000) # these need to change for each model? 
delta_plot_colour_values = c(-50,50)
model_agreement_plot_colour_values = c(50,100)
# Define a layout function
mean_plot_colour_values = c(-50,50)
sd_plot_colour_values = c(0,50)
model_agreement_plot_colour_values = c(50,100)

# define a color scheme 
colour_scheme1 <- c(low = 'white', mid = "skyblue1",  high = 'royalblue1') # for statistics - e.g model mean, SD and agreement
colour_scheme2 <- c(low = 'red', mid = "white",  high = 'royalBlue1') # for % changes - either increasing or decreasing 
colour_scheme3 <- c("#fdb863", "#f7f7f7","#b2abd2") # for delta plots (between cmips change) # purple to green shades
colour_scheme4 <- c(low = '#e0ecf4', mid = "#9ebcda",  high = '#8856a7') # for inputs values # shades of blue to purple?? 

# Download and process world outline
library(sf)
library(rnaturalearth)
library("rgeos")
world <- ne_countries(scale = "medium", returnclass = "sf")
robCRS <- CRS("+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
world_sf <- st_transform(world, crs = st_crs(robCRS)) # Convert to different CRS

```

# Load global ISIMIP2b model data 

```{r}

# CMIP5 data location
directory = "/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/"

# APECOSM ----
h_yearsA <- "1950_2005"
f_yearsA<- "2006_2100"
outputA<-"monthly"
oaA<-"no-oa"

# BOATS ----
h_yearsB <- "1971_2005"
f_yearsB<- "2006_2099"
outputB<-"monthly"
oaB<-"no-oa"

# DBEM ----
h_yearsD <- "1951_2005"
f_yearsD<- "2006_2099"
outputD<-"annual"
oaD<-"oa"

# DBPM ----
h_yearsDB <- "1950_2005"
f_yearsDB<- "2006_2100"
outputDB<-"monthly"
oaDB<-"no-oa"

# EcoOcean ----  
h_yearsE <- "1971_2005"
f_yearsE<- "2006_2100"
outputE<-"monthly"
oaE<-"no-oa"

# macroecological ----  
h_yearsM <- "1950_2005"
f_yearsM<- "2006_2100"
outputM<-"annual"
oaM<-"no-oa"

# extract data IPSL ---- 
h_years <-c(h_yearsA, h_yearsB, h_yearsD, h_yearsDB, h_yearsE, h_yearsM)
f_years <-c(f_yearsA, f_yearsB, f_yearsD, f_yearsDB, f_yearsE, f_yearsM)
output <-c(outputA, outputB, outputD, outputDB, outputE, outputM)
oa <-c(oaA, oaB, oaD, oaDB, oaE, oaM)

yearmonth1<- rep(as.yearmon("1990-01"), length(mod_ipsl))
yearmonth2<- ifelse(output!="annual", as.yearmon("1999-12"), as.yearmon("1999-01"))

yearmonth1_fut<- rep(as.yearmon("2090-01"), length(mod_ipsl))
yearmonth2_fut<- ifelse(output!="annual", as.yearmon("2099-12"), as.yearmon("2099-01"))

data_ipsl_CMIP5<-list()

for (i in 1:length(mod_ipsl)){

  filename<-paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[2],"/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_hist_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], ".nc4")
  
  hist<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = TRUE)
  
  filename <- paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_rcp2p6_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut126<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = TRUE)
  
  filename <- paste0(mod_ipsl[i], "/ipsl-cm5a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), "_ipsl-cm5a-lr_nobc_rcp8p5_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut585<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = TRUE)
  
  diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
  diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100
  
  data_ipsl_CMIP5[[i]]<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)
  names(data_ipsl_CMIP5)[[i]]<-mod_ipsl[[i]]
  
  rm(hist, fut126, fut585, diff_2p6, diff_8p5)
 
}

# add Zoom IPSL ----

directory_zoom<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/historical/"
filename<-"zoomss_ipsl-cm5a-lr_nobc_historical_nosoc_co2_tcb_global_annual_1950_2005.nc4"
yearmonth1 = as.yearmon("1990-01")
yearmonth2 = as.yearmon("1999-01")
hist<-averageFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = TRUE)

directory_zoom<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/future/"
filename<-"zoomss_ipsl-cm5a-lr_nobc_rcp26_nosoc_co2_tcb_global_annual_2006_2100.nc4"
yearmonth1 = as.yearmon("2090-01")
yearmonth2 = as.yearmon("2099-01")
fut126<-averageFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = TRUE)

filename<-"zoomss_ipsl-cm5a-lr_nobc_rcp85_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut585<-averageFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = TRUE)

diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100

data_ipsl_CMIP5$ZooMSS<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)

# extract data GFDL ---- 

h_years <-c(h_yearsB, h_yearsD, h_yearsE, h_yearsM)
f_years <-c(f_yearsB, f_yearsD, f_yearsE, f_yearsM)
f_years[3]<-"2006_2099" # ecoOcean changes 
output <-c(outputB, outputD, outputE, outputM)
oa <-c(oaB, oaD, oaE, oaM)

yearmonth1<- ifelse(output=="annual", as.yearmon("1990-01"), as.yearmon("1990-01"))
yearmonth2<- ifelse(output!="annual", as.yearmon("1999-12"), as.yearmon("1999-01"))

yearmonth1_fut<- ifelse(output=="annual", as.yearmon("2090-01"), as.yearmon("2090-01"))
yearmonth2_fut<- ifelse(output!="annual", as.yearmon("2099-12"), as.yearmon("2099-01"))

data_gfdl_CMIP5<-list()

for (i in 1:length(mod_gfdl)){

  # i = 1
  filename<-paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[2],"/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_hist_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], ".nc4")
  
  hist<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = TRUE)
  
  filename <- paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[3], "/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_rcp2p6_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut126<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = TRUE)
  
  filename <- paste0(mod_gfdl[i], "/gfdl-esm2m/", protocol[3], "/", tolower(mod_gfdl[i]), "_gfdl-esm2m_nobc_rcp8p5_wo-diaz_no-fishing_",oa[i],"_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],".nc4")
  
  fut585<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = TRUE)
  
  diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
  diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100
  
  data_gfdl_CMIP5[[i]]<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)
  names(data_gfdl_CMIP5)[[i]]<-mod_gfdl[[i]]
  
  rm(hist, fut126, fut585, diff_2p6, diff_8p5)
 
}

# add zoom GFDL ----

directory_zoom<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/historical/"
filename<-"zoomss_gfdl-esm2m_nobc_historical_nosoc_co2_tcb_global_annual_1950_2005.nc4"
yearmonth1 = as.yearmon("1990-01")
yearmonth2 = as.yearmon("1999-01")
hist<-averageFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = TRUE)

directory_zoom<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP2b/ZooMSS/_tmp/future/"
filename<-"zoomss_gfdl-esm2m_nobc_rcp26_nosoc_co2_tcb_global_annual_2006_2100.nc4"
yearmonth1 = as.yearmon("2090-01")
yearmonth2 = as.yearmon("2099-01")
fut126<-averageFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = TRUE)

filename<-"zoomss_gfdl-esm2m_nobc_rcp85_nosoc_co2_tcb_global_annual_2006_2100.nc4"
fut585<-averageFishCDF(directory_zoom, filename , variable_to_extract[1], yearmonth1, yearmonth2, average_whole_period = TRUE)

diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100

data_gfdl_CMIP5$ZooMSS<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)

```

NOTES   
average_whole_period: if TRUE you are averaging data between 1990 and 1999, if FALSE you are extrapolating data for each one of the years between 1990 and 1999  
the  printed info on year is the file year extent   
here you are considering only ipsl, no fishing - but can apply the same code to the other scenarios   
DBEM dimension 0.5 deg - here taken care of   

# Plot global ISIMIP2b model outputs 

```{r map CMIP5}

## plot IPSL ----

map_ipsl585_CMIP5<-list()

mod_ipsl<-c(mod_ipsl, "ZooMSS")
model_type_ipsl<-ifelse(mod_ipsl == "DBEM","DBEM", NA) # this is because DBEM need to be plotted in 0.5 deg

for (i in 1:length(data_ipsl_CMIP5)){ 
  
  tit <- paste(mod_ipsl[i], "IPSL RCP8.5 no-fishing percentage change", variable_to_extract[1], data_ipsl_CMIP5[[i]]$hist$data_units, cmip[1], sep =" ")
  map_ipsl585_CMIP5[[i]]<-plot_FISH_MIP(data_ipsl_CMIP5[[i]]$diff_8p5, tit, delta_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n Change \n (%)", model_type = model_type_ipsl[i])
  names(map_ipsl585_CMIP5)[[i]]<-mod_ipsl[[i]]
  
  rm(tit)
  
}

### plot GFDL ----

mod_gfdl<-c(mod_gfdl, "ZooMSS")
model_type_gfdl<-ifelse(mod_gfdl == "DBEM","DBEM", NA) 
map_gfdl585_CMIP5<-list()

for (i in 1:length(data_gfdl_CMIP5)){ 
  
  tit <- paste(mod_gfdl[i], "GFDL RCP8.5 no-fishing percentage change", variable_to_extract[1], data_gfdl_CMIP5[[i]]$hist$data_units, cmip[1], sep =" ")
  map_gfdl585_CMIP5[[i]]<-plot_FISH_MIP(data_gfdl_CMIP5[[i]]$diff_8p5, tit, delta_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n Change \n (%)", model_type = model_type_gfdl[i])
  names(map_gfdl585_CMIP5)[[i]]<-mod_gfdl[[i]]
  
  rm(tit)
  
}


# RCP 2.6

## plot IPSL ----

map_ipsl126_CMIP5<-list()

for (i in 1:length(data_ipsl_CMIP5)){ 
  
  tit <- paste(mod_ipsl[i], "IPSL RCP2.6 no-fishing percentage change", variable_to_extract[1], data_ipsl_CMIP5[[i]]$hist$data_units, cmip[1], sep =" ")
  map_ipsl126_CMIP5[[i]]<-plot_FISH_MIP(data_ipsl_CMIP5[[i]]$diff_2p6, tit, delta_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n Change \n (%)", model_type = model_type_ipsl[i])
  names(map_ipsl126_CMIP5)[[i]]<-mod_ipsl[[i]]
  
  rm(tit)
  
}

names(map_ipsl126_CMIP5)

### plot GFDL ----

map_gfdl126_CMIP5<-list()

for (i in 1:length(data_gfdl_CMIP5)){ 
  
  tit <- paste(mod_gfdl[i], "GFDL RCP2.6 no-fishing percentage change", variable_to_extract[1], data_gfdl_CMIP5[[i]]$hist$data_units, cmip[1], sep =" ")
  map_gfdl126_CMIP5[[i]]<-plot_FISH_MIP(data_gfdl_CMIP5[[i]]$diff_2p6, tit, delta_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n Change \n (%)", model_type = model_type_gfdl[i])
  names(map_gfdl126_CMIP5)[[i]]<-mod_gfdl[[i]]
  
  rm(tit)
  
}

```

# Deal with model set  *2 set of models for main and SI for CMIP5*

```{r}

set == "full"

if(set != "full"){
  data_ipsl_CMIP5$ZooMSS<-NULL
  data_gfdl_CMIP5$ZooMSS<-NULL 
}

```

# Model average for CMIP5 

```{r}

# RCP 8.5
# MAKE SURE THAT ALL MATRICES ARE ON ONE DEGREE SCALE
### TEMPORARY - JUST TAKE THE VALUE FROM CLOSE POINT
lons_to_use = seq(1,719,2)
lats_to_use = seq(1,359,2)

data_ipsl_CMIP5$DBEM$diff_8p5 = data_ipsl_CMIP5$DBEM$diff_8p5[lons_to_use, lats_to_use] 
data_gfdl_CMIP5$DBEM$diff_8p5 = data_gfdl_CMIP5$DBEM$diff_8p5[lons_to_use, lats_to_use] 

# model average - see model_stat() in HelperScripts.R

res_ipsl<-model_stat(data_ipsl_CMIP5, esm = 'diff_8p5')
model_average_ipsl_CMIP5<-res_ipsl$model_average
model_sd_ipsl_CMIP5<-res_ipsl$model_sd
model_agreement_ipsl_CMIP5<- res_ipsl$model_agreement

res_gfdl<-model_stat(data_gfdl_CMIP5, esm = 'diff_8p5')
model_average_gfdl_CMIP5<-res_gfdl$model_average
model_sd_gfdl_CMIP5<-res_gfdl$model_sd
model_agreement_gfdl_CMIP5<- res_gfdl$model_agreement

res_all<-model_stat(c(data_ipsl_CMIP5, data_gfdl_CMIP5), esm = 'diff_8p5')
model_average_all_CMIP5<-res_all$model_average
model_sd_all_CMIP5<-res_all$model_sd
model_agreement_all_CMIP5<- res_all$model_agreement 

# define title All
maptitle_average = paste("Mean % change RCP 8.5, 1990s to 2090s CMIP5", sep=" ")
maptitle_sd = paste("Standard Deviation RCP 8.5, 1990s to 2090s CMIP5", sep=" ")
maptitle_agreement = paste("Agreement RCP 8.5, 1990s to 2090s CMIP5", sep=" ")

# Plot the model average and standard deviation

# NEED CONTOURS X 3 plots below - added argument to plotting function (contours = TRUE) but not used yet 

avarage_CMIP5_all<-plot_FISH_MIP(model_average_all_CMIP5, maptitle_average, mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")
sd_CMIP5_all<-plot_FISH_MIP(model_sd_all_CMIP5, maptitle_sd, sd_plot_colour_values,colour_scheme = colour_scheme1, coltitle = "Variability  \n (SD)")
agreement_CMIP5_all<-plot_FISH_MIP(model_agreement_all_CMIP5, maptitle_agreement, model_agreement_plot_colour_values ,colour_scheme = colour_scheme1, coltitle = "Model \n agreement \n (%)")

# plot averadge by esm 
avarage_CMIP5_ipsl<-plot_FISH_MIP(model_average_ipsl_CMIP5, "Mean % change RCP 8.5, 1990s to 2090s CMIP5 IPSL", mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")
avarage_CMIP5_gfdl<-plot_FISH_MIP(model_average_gfdl_CMIP5, "Mean % change RCP 8.5, 1990s to 2090s CMIP5 GFDL", mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")

# RCP 2.6

data_ipsl_CMIP5$DBEM$diff_2p6 = data_ipsl_CMIP5$DBEM$diff_2p6[lons_to_use, lats_to_use] 
data_gfdl_CMIP5$DBEM$diff_2p6 = data_gfdl_CMIP5$DBEM$diff_2p6[lons_to_use, lats_to_use] 

# model average - see model_stat() in HelperScripts.R

res_ipsl_126<-model_stat(data_ipsl_CMIP5, esm = 'diff_2p6')
model_average_ipsl_CMIP5_126<-res_ipsl_126$model_average
model_sd_ipsl_CMIP5_126<-res_ipsl_126$model_sd
model_agreement_ipsl_CMIP5_126<- res_ipsl_126$model_agreement

res_gfdl_126<-model_stat(data_gfdl_CMIP5, esm = 'diff_2p6')
model_average_gfdl_CMIP5_126<-res_gfdl_126$model_average
model_sd_gfdl_CMIP5_126<-res_gfdl_126$model_sd
model_agreement_gfdl_CMIP5_126<- res_gfdl_126$model_agreement

res_all_126<-model_stat(c(data_ipsl_CMIP5, data_gfdl_CMIP5), esm = 'diff_2p6')
model_average_all_CMIP5_126<-res_all_126$model_average
model_sd_all_CMIP5_126<-res_all_126$model_sd
model_agreement_all_CMIP5_126<- res_all_126$model_agreement 

# define title All
maptitle_average = paste("Mean % change RCP 2.6, 1990s to 2090s CMIP5", sep=" ")
maptitle_sd = paste("Standard Deviation RCP 2.6, 1990s to 2090s CMIP5", sep=" ")
maptitle_agreement = paste("Agreement RCP 2.6, 1990s to 2090s CMIP5", sep=" ")

# Plot the model average and standard deviation

# NEED CONTOURS X 3 plots below

avarage_CMIP5_all_126<-plot_FISH_MIP(model_average_all_CMIP5, maptitle_average, mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")
sd_CMIP5_all_126<-plot_FISH_MIP(model_sd_all_CMIP5, maptitle_sd, sd_plot_colour_values,colour_scheme = colour_scheme1, coltitle = "Variability  \n (SD)")
agreement_CMIP5_all_126<-plot_FISH_MIP(model_agreement_all_CMIP5, maptitle_agreement, model_agreement_plot_colour_values ,colour_scheme = colour_scheme1, coltitle = "Model \n agreement \n (%)")

# plot averadge by esm 
avarage_CMIP5_ipsl_126<-plot_FISH_MIP(model_average_ipsl_CMIP5, "Mean % change RCP 2.6, 1990s to 2090s CMIP5 IPSL", mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")
avarage_CMIP5_gfdl_126<-plot_FISH_MIP(model_average_gfdl_CMIP5, "Mean % change RCP 2.6, 1990s to 2090s CMIP5 GFDL", mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")

```

# save outputs ISIMIP2b temp 

```{r}

data_summaries_CMIP5<-list(res_all= res_all, res_ipsl = res_ipsl, res_gfdl = res_gfdl, res_all_126= res_all_126, res_ipsl_126 = res_ipsl_126, res_gfdl_126 = res_gfdl_126)

map_summaries_CMIP5<-list(avarage_CMIP5_all = avarage_CMIP5_all, sd_CMIP5_all = sd_CMIP5_all, agreement_CMIP5_all = agreement_CMIP5_all, avarage_CMIP5_ipsl = avarage_CMIP5_ipsl, avarage_CMIP5_gfdl = avarage_CMIP5_gfdl, avarage_CMIP5_all_126 = avarage_CMIP5_all_126, sd_CMIP5_all_126 = sd_CMIP5_all_126, agreement_CMIP5_all_126 = agreement_CMIP5_all_126, avarage_CMIP5_ipsl_126 = avarage_CMIP5_ipsl_126, avarage_CMIP5_gfdl_126 = avarage_CMIP5_gfdl_126)

if(set == "full"){
  save(data_ipsl_CMIP5, data_gfdl_CMIP5, map_ipsl585_CMIP5, map_gfdl585_CMIP5, map_ipsl126_CMIP5, map_gfdl126_CMIP5, data_summaries_CMIP5, map_summaries_CMIP5, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIP5.RData")
}else{
  save(data_ipsl_CMIP5, data_gfdl_CMIP5, map_ipsl585_CMIP5, map_gfdl585_CMIP5, map_ipsl126_CMIP5, map_gfdl126_CMIP5, data_summaries_CMIP5, map_summaries_CMIP5, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIP5_reducedModelSet.RData")

}

```

# Load libraries for netcdf and define variables

```{r load CMIP5}

rm(list=ls())
library(grid)
library(zoo)
library(viridis)
library(tidyr)
library(dplyr)

source("/Users/camillan/R-projects/CMIP5vsCMIP6/R/HelperScripts.r")
source("/Users/camillan/R-projects/CMIP5vsCMIP6/R/Funcs_maps.r")

# saving outputs location  
save_loc <- "/Users/camillan/Dropbox/CMIP5vsCMIP6/CMIP5vsCMIP6_figs/"

# variables 
cmip<-c("CMIP5", "CMIP6")
mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL")
mod_gfdl <- c("BOATS", "DBEM", "EcoOcean", "MACROECOLOGICAL")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")
variable_to_extract <-c("tcb","tpb", "bp30cm", "bp30to90cm", "bp90cm")

```

# load libraries for plotting and define criteria 

```{r}

# Define color/legend limits 
main_plot_colour_values = c(0,10000) # these need to change for each model? 
delta_plot_colour_values = c(-50,50)
model_agreement_plot_colour_values = c(50,100)
# Define a layout function
mean_plot_colour_values = c(-50,50)
sd_plot_colour_values = c(0,50)
model_agreement_plot_colour_values = c(50,100)

# define a color scheme 
colour_scheme1 <- c(low = 'white', mid = "skyblue1",  high = 'royalblue1') # for statistics - e.g model mean, SD and agreement
colour_scheme2 <- c(low = 'red', mid = "white",  high = 'royalBlue1') # for % changes - either increasing or decreasing 
colour_scheme3 <- c("#fdb863", "#f7f7f7","#b2abd2") # for delta plots (between cmips change) # purple to green shades
colour_scheme4 <- c(low = '#e0ecf4', mid = "#9ebcda",  high = '#8856a7') # for inputs values # shades of blue to purple?? 

# Download and process world outline
library(sf)
library(rnaturalearth)
library("rgeos")
world <- ne_countries(scale = "medium", returnclass = "sf")
robCRS <- CRS("+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
world_sf <- st_transform(world, crs = st_crs(robCRS)) # Convert to different CRS

```

# Load global ISIMIP3b model data

```{r load CMIP6}

# run first 2 sections if you are not running the CMIP5 sections

directory <- "/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/"

mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL", "EcoTroph", "FEISTY", "ZooMSS") 
mod_ipsl <- c("APECOSM","BOATS","DBPM","MACROECOLOGICAL","FEISTY","ZooMSS") 

# APECOSM ----
h_yearsA <- "1850_2014"
f_yearsA<- "2015_2100"
earthA<-"_ipsl-esm4_nobc_" # will change ....
outputA<-"monthly"
extensionA<-".nc" 

# BOATS ----
h_yearsB <- "1950_2014"
f_yearsB<- "2015_2100"
earthB<-"_ipsl-cm6a-lr_nobc_"
outputB<-"monthly"
extensionB<-".nc"

# DBEM ----
# added below

# DBPM ----
h_yearsDB <- "1850_2014"
f_yearsDB<- "2015_2100"
earthDB<-"_ipsl-cm6a-lr_nobasd_"
outputDB<-"monthly" 
extensionDB <-".nc"

# EcoOcean ----  
# added below  

# macroecological ----  
h_yearsM <- "1950_2014"
f_yearsM<- "2015-2100"
earthM<-"_ipsl-cm6a-lr_nobc_"
outputM<-"annual"
extensionM<-".nc"

# EcoTroph ----  
h_yearsE <- "1950-2014"
f_yearsE<- "2015-2100"
earthE<-"_ipsl-cm6a_nobc_"
outputE<-"annual"
extensionE<-".nc"

# FEISTY ----  
h_yearsF <- "1950_2014"
f_yearsF<- "2015_2100"
earthF<-"_ipsl-cm6a-lr_nobasd_" 
outputF<-"monthly"
extensionF<-".nc"

# ZooMSS ----  
h_yearsZ <- "1950_2014"
f_yearsZ<- "2015_2100"
earthZ<-"_ipsl-cm6a-lr_nobasd_"
outputZ<-"annual"
extensionZ<-".nc"

# extract data IPSL ---- 
h_years <-c(h_yearsA,h_yearsB, h_yearsDB, h_yearsM,h_yearsF, h_yearsZ) 
f_years <-c(f_yearsA, f_yearsB, f_yearsDB, f_yearsM,f_yearsF, f_yearsZ) 
earth <-c(earthA, earthB, earthDB, earthM, earthF, earthZ) 
output <-c(outputA, outputB, outputDB, outputM, outputF, outputZ) 
extension <-c(extensionA, extensionB, extensionDB,extensionM,extensionF,extensionZ) 

# same as above but need to re-do as here outputs are from a different set of models
yearmonth1<- ifelse(output=="annual", as.yearmon("1990-01"), as.yearmon("1990-01"))
yearmonth2<- ifelse(output!="annual", as.yearmon("1999-12"), as.yearmon("1999-01"))

yearmonth1_fut<- ifelse(output=="annual", as.yearmon("2090-01"), as.yearmon("2090-01"))
yearmonth2_fut<- ifelse(output!="annual", as.yearmon("2099-12"), as.yearmon("2099-01"))

data_ipsl_CMIP6<-list()

# NOTE: warning for Feisty are OK - see above 

for (i in 1:length(mod_ipsl)){

  filename<-paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[2],"/", tolower(mod_ipsl[i]), earth[i], "historical_nat_default_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], extension[i])
  
  hist<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = TRUE, CMIP =  6)
  
  filename <- paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), earth[i], "ssp126_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut126<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = TRUE, CMIP = 6)
  
  filename <- paste0(mod_ipsl[i], "/_tmp/ipsl-cm6a-lr/", protocol[3], "/", tolower(mod_ipsl[i]), earth[i], "ssp585_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut585<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = TRUE,CMIP = 6)
  
  diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
  diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100
  
  data_ipsl_CMIP6[[i]]<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)
  names(data_ipsl_CMIP6)[[i]]<-mod_ipsl[[i]]
  
  rm(hist, fut126, fut585, diff_2p6, diff_8p5)
 
}

names(data_ipsl_CMIP6)

# add EcoTrpoh IPSL ----
# naming mistakes that complicate uploading - Matthias check will fix them 
# write function for ecothroph 

time1_h = 1990 
time2_h = 1999
time1_f = 2090 # here the file is one so need to read-in the same file and use it to calculate these averages
time2_f = 2099

averageFishCDF_EcoTroph<-function(file, time1, time2, average_whole_period = TRUE, convert_to_kg_km = TRUE){
  
  # Open the netcdf file
  nc <- nc_open(file)
  var <-names(nc$var)
  
  # Extract important information
  data_attributes <- ncatt_get(nc, var) # variable is called "Band1" instead of "tcb"
  main_title <- data_attributes$long_field_name
  data_units <- data_attributes$units
    
  lon <- ncvar_get(nc, "lon")
  lat <- ncvar_get(nc, "lat")

  # new convert_model_dates_CMIP6 for this model 
  time_months <- ncvar_get(nc, "time")
  print(nc$dim$time$units) # annual since 1950.....
  yearmonth = as.yearmon("1950-01")
  time_months = floor(as.numeric(as.yearmon(yearmonth + seq(0, (length(time_months) - 1)))))
  time_vector<-time_months
  print(time_months[1])
  print(time_months[length(time_months)])

  #  opposite of averaging the whole period ... line 488 in original function
  # Create a new matrix to hold the results
  new_var_mat = array(rep(0, length(lon) * length(lat)), c(length(lon), length(lat)))
      
  # Get the correct time period to extract
  tpte = time_period_to_extract(time1, time2, time_vector)

  # Now get the variable of interest
  temp_array1 <-ncvar_get(nc, var)[, , tpte$start_point_to_extract:tpte$end_point_to_extract]
  # Extract averages
  for (ii in 1:length(lon)){
    for (jj in 1:length(lat))
      {
      # Fill in 2D matrix of whole time-period averages 
      new_var_mat[ii, jj] = mean(temp_array1[ii, jj, ])
    }
    }
  years = paste(as.character(time1_h), "to", as.character(time2_h), sep=" ")

if(can_model_units_be_standardized(data_units, convert_to_kg_km))
    {
      new_var_mat = new_var_mat * 1000
      data_units = "kg km-2" 
      }
    
  return_list <- list(
        main_title = main_title,
        data_units = data_units,
        lon = lon,
        lat = lat,
        years = years,
        fishvar = new_var_mat
      )
}

# hist is the beginning of the future files 
file<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoTroph/_tmp/ipsl-cm6a-lr/future/ecotroph_ipsl-cm6a-lr_nobc_ssp126_nat_default_tcb_annual_1950_2100.nc"
hist<-averageFishCDF_EcoTroph(file, time1_h, time2_h)
fut126<-averageFishCDF_EcoTroph(file, time1_f, time2_f)
file<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoTroph/_tmp/ipsl-cm6a-lr/future/ecotroph_ipsl-cm6a-lr_nobc_ssp585_nat_default_tcb_annual_1950_2100.nc"
fut585<-averageFishCDF_EcoTroph(file, time1_f, time2_f)

diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100 
diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100

data_ipsl_CMIP6$EcoTroph<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)

# add EcoOcean IPSL ----
# this is different as inputs are RDS files

averageFishCDF_EcoOcean<-function(file, time1, time2, average_whole_period = TRUE, convert_to_kg_km = TRUE, type = "hist"){
  
  # Open the netcdf file
  nc <- file
  
  # Extract important information
  data_attributes <- "guess" # should be "tcb"
  main_title <- "guess"
  data_units <- "guess"
    
  lon <- data_ipsl_CMIP6$BOATS$hist$lon
  lat <- data_ipsl_CMIP6$BOATS$hist$lat

  time_months <- seq(1, dim(nc)[3])
  
  if(type == "hist"){
    yearmonth = as.yearmon("1949-12") + time_months[1] / 12
    }else{
      yearmonth = as.yearmon("2006-01") + time_months[1] / 12 # this should be 2015 for CMIP6 but these files adopted CMIP5 convention
      }

  time_months = as.yearmon(yearmonth + seq(0, (length(time_months) - 1)) / 12)     
  tail(time_months)
  time_vector<-time_months
  print(time_months[1])
  print(time_months[length(time_months)])

  # line 488 in original function
  # Create a new matrix to hold the results
  new_var_mat = array(rep(0, length(lon) * length(lat)), c(length(lon), length(lat)))
      
  # Get the correct time period to extract
  tpte = time_period_to_extract(time1, time2, time_vector)

  # Now get the variable of interest
  temp_array1 <-nc[, , tpte$start_point_to_extract:tpte$end_point_to_extract]
  dim(temp_array1)
  
  # Extract averages
  for (ii in 1:length(lon)){
    for (jj in 1:length(lat))
      {
      # Fill in 2D matrix of whole time-period averages 
      new_var_mat[ii, jj] = mean(temp_array1[ii, jj, ])
    }
    }
  years = paste(as.character(time1_h), "to", as.character(time2_h), sep=" ")

  # this should be done when we know the data units 
  new_var_mat = new_var_mat * 1000
  data_units = "kg km-2" 
    
  return_list <- list(
        main_title = main_title,
        data_units = data_units,
        lon = lon,
        lat = lat,
        years = years,
        fishvar = new_var_mat
      )
}

file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_historical_nosoc_default_tcb_global_monthly_1950-2005.RDS")
hist<-averageFishCDF_EcoOcean(file, time1_h, time2_h, type = "hist")
file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_ssp126_nosoc_default_tcb_global_monthly_2006_2100.RDS")
fut126<-averageFishCDF_EcoOcean(file, time1_f, time2_f, type = "fut")
file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_ssp585_nosoc_default_tcb_global_monthly_2006_2100.RDS")
fut585<-averageFishCDF_EcoOcean(file, time1_f, time2_f, type = "fut")

diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100  
diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100

data_ipsl_CMIP6$EcoOcean<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)

# add DBEM IPSL ----
# these are RData files similar to EcoOcean but the data layout is different

averageFishCDF_DBEM<-function(file, time1, time2, average_whole_period = TRUE, convert_to_kg_km = TRUE){
  
  # Open the netcdf file
  nc <- file
  # Extract important information
  data_attributes <- "tcb"
  main_title <- "guess"
  data_units <- "guess"
    
  lon <- unique(coord$lon)
  lat <- unique(coord$lat)

  time_months <- seq(1951, 2100)
  yearmonth = as.yearmon("1951-01")

  time_months = as.yearmon(yearmonth + seq(0, (length(time_months) - 1)))     
  time_vector<-time_months
  print(time_months[1])
  print(time_months[length(time_months)])

  # line 488 in original function
  # Create a new matrix to hold the results
  new_var_mat = array(rep(0, length(lon) * length(lat)), c(length(lon), length(lat)))
      
  # Get the correct time period to extract
  tpte = time_period_to_extract(time1, time2, time_vector)

  # Now get the variable of interest
  # dimension and data format are different than for other models, so need different way of extracting data. GRID CELL X YEAR
  temp_array1 <-nc[,tpte$start_point_to_extract:tpte$end_point_to_extract]
  # Extract averages
  new_var_vec<-rowMeans(temp_array1)
  new_var_df<-cbind(coord, new_var_vec)
  new_var_df<-new_var_df[,-1]
  library(reshape2)
  new_var_mat<-acast(new_var_df, lon~lat, value.var="new_var_vec")
  
  years = paste(as.character(time1_h), "to", as.character(time2_h), sep=" ")

  # this should be done when we know the data units 
  new_var_mat = new_var_mat * 1000
  data_units = "kg km-2" 
    
  return_list <- list(
        main_title = main_title,
        data_units = data_units,
        lon = lon,
        lat = lat,
        years = years,
        fishvar = new_var_mat
      )
}

coord<-read.delim("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/Lat_Lon.txt", header = FALSE, sep = ",")
colnames(coord)<-c("grid", "lon", "lat")
file<-load("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/C6IPSL26F0_t2_Abd.RData")
file<-sppfnlmap
hist<-averageFishCDF_DBEM(file, time1_h, time2_h)
fut126<-averageFishCDF_DBEM(file, time1_f, time2_f)
file<-load("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/C6IPSL85F0_t2_Abd.RData")
file<-sppfnlmap
fut585<-averageFishCDF_DBEM(file, time1_f, time2_f)

diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100  
diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100

data_ipsl_CMIP6$DBEM<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)

# extract data GFDL ---- 

mod_gfdl <- c("BOATS","DBPM" ,"MACROECOLOGICAL","ZooMSS", "FEISTY") 

h_years <-c(h_yearsB,h_yearsDB, h_yearsM, h_yearsZ,h_yearsF) 
f_years <-c(f_yearsB,f_yearsDB, f_yearsM, f_yearsZ, f_yearsF) 
earth<-c("_gfdl-esm4_nobc_","_gfdl-esm4_nobasd_","_gfdl-esm4_nobc_","_gfdl-esm4_nobasd_","_gfdl-esm4_nobasd_")
output <-c(outputB,outputDB, outputM, outputZ, outputF) 
extension <-c(extensionB, extensionDB,extensionM, extensionZ, extensionF) 

yearmonth1<- ifelse(output=="annual", as.yearmon("1990-01"), as.yearmon("1990-01"))
yearmonth2<- ifelse(output!="annual", as.yearmon("1999-12"), as.yearmon("1999-01"))

yearmonth1_fut<- ifelse(output=="annual", as.yearmon("2090-01"), as.yearmon("2090-01"))
yearmonth2_fut<- ifelse(output!="annual", as.yearmon("2099-12"), as.yearmon("2099-01"))

data_gfdl_CMIP6<-list()

for (i in 1:length(mod_gfdl)){

  filename<-paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[2],"/", tolower(mod_gfdl[i]), earth[i], "historical_nat_default_",variable_to_extract[1],"_global_", output[i], "_", h_years[i], extension[i])
  
  hist<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1[i], yearmonth2[i], average_whole_period = TRUE, CMIP =  6)

  filename <- paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[3], "/", tolower(mod_gfdl[i]), earth[i], "ssp126_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut126<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = TRUE, CMIP = 6)
  
  filename <- paste0(mod_gfdl[i], "/_tmp/gfdl-esm4/", protocol[3], "/", tolower(mod_gfdl[i]), earth[i], "ssp585_nat_default_",variable_to_extract[1],"_global_",output[i], "_",f_years[i],extension[i])
  
  fut585<- averageFishCDF(directory, filename , variable_to_extract[1], yearmonth1_fut[i], yearmonth2_fut[i], average_whole_period = TRUE,CMIP = 6)
  
  diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100
  diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100
  
  data_gfdl_CMIP6[[i]]<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)
  names(data_gfdl_CMIP6)[[i]]<-mod_gfdl[[i]]
  
  rm(hist, fut126, fut585, diff_2p6, diff_8p5)
 
}

names(data_gfdl_CMIP6)

# add EcoTroph GFDL ----

file<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoTroph/_tmp/gfdl-esm4/future/ecotroph_gfdl-esm4_nobc_ssp126_nat_default_tcb_annual_1950_2100.nc"
hist<-averageFishCDF_EcoTroph(file, time1_h, time2_h)
fut126<-averageFishCDF_EcoTroph(file, time1_f, time2_f)
file<-"/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoTroph/_tmp/gfdl-esm4/future/ecotroph_gfdl-esm4_nobc_ssp585_nat_default_tcb_annual_1950_2100.nc"
fut585<-averageFishCDF_EcoTroph(file, time1_f, time2_f)

diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100 
diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100
  
data_gfdl_CMIP6$EcoTroph<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)

names(data_gfdl_CMIP6)

# add EcoOcean GFDL ----

file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_gfdl_nobc_historical_nosoc_default_tcb_global_monthly_1950-2005.RDS")
hist<-averageFishCDF_EcoOcean(file, time1_h, time2_h, type = "hist")
file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_ssp126_nosoc_default_tcb_global_monthly_2006_2100.RDS")
fut126<-averageFishCDF_EcoOcean(file, time1_f, time2_f, type = "fut")
file<-readRDS("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/EcoOcean CMIP6 RDS files/ecoocean_ipsl_nobc_ssp585_nosoc_default_tcb_global_monthly_2006_2100.RDS")
fut585<-averageFishCDF_EcoOcean(file, time1_f, time2_f, type = "fut")

diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100 
diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100

data_gfdl_CMIP6$EcoOcean<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)

# add DBEM GFDL ----

file<-load("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/C6GFDL26F0_t2_Abd.RData")
file<-sppfnlmap
hist<-averageFishCDF_DBEM(file, time1_h, time2_h)
fut126<-averageFishCDF_DBEM(file, time1_f, time2_f)
file<-load("/Users/camillan/fishmip_outputs/marine-fishery_global_ISIMIP3b/DBEM_RData/C6GFDL85F0_t2_Abd.RData")
file<-sppfnlmap
fut585<-averageFishCDF_DBEM(file, time1_f, time2_f)

diff_2p6 = fut126$fishvar / hist$fishvar * 100 - 100  
diff_8p5 = fut585$fishvar / hist$fishvar * 100 - 100

data_gfdl_CMIP6$DBEM<-list(hist = hist, fut126 = fut126, fut585 = fut585, diff_2p6 = diff_2p6, diff_8p5 = diff_8p5)

```

# Plot global ISIMIP3b model outputs 

```{r plot CMIP6}

## need to FLIP MATRICES 

fliplr_matrix<- function(data_to_flip){
  temp= data_to_flip
  for (ii in 1:dim(data_to_flip)[2])
    data_to_flip[,ii] = temp[,dim(data_to_flip)[2] - ii + 1]
  
  data_to_flip
}

# plot IPSL ----

data_ipsl_CMIP6$MACROECOLOGICAL$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP6$MACROECOLOGICAL$hist$fishvar)
data_ipsl_CMIP6$MACROECOLOGICAL$fut126$fishvar<- fliplr_matrix(data_ipsl_CMIP6$MACROECOLOGICAL$fut126$fishvar)
data_ipsl_CMIP6$MACROECOLOGICAL$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP6$MACROECOLOGICAL$fut585$fishvar)
data_ipsl_CMIP6$MACROECOLOGICAL$diff_2p6<- fliplr_matrix(data_ipsl_CMIP6$MACROECOLOGICAL$diff_2p6)
data_ipsl_CMIP6$MACROECOLOGICAL$diff_8p5<- fliplr_matrix(data_ipsl_CMIP6$MACROECOLOGICAL$diff_8p5)

data_ipsl_CMIP6$ZooMSS$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP6$ZooMSS$hist$fishvar)
data_ipsl_CMIP6$ZooMSS$fut126$fishvar<- fliplr_matrix(data_ipsl_CMIP6$ZooMSS$fut126$fishvar)
data_ipsl_CMIP6$ZooMSS$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP6$ZooMSS$fut585$fishvar)
data_ipsl_CMIP6$ZooMSS$diff_2p6<- fliplr_matrix(data_ipsl_CMIP6$ZooMSS$diff_2p6)
data_ipsl_CMIP6$ZooMSS$diff_8p5<- fliplr_matrix(data_ipsl_CMIP6$ZooMSS$diff_8p5)

data_ipsl_CMIP6$FEISTY$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP6$FEISTY$hist$fishvar)
data_ipsl_CMIP6$FEISTY$fut126$fishvar<- fliplr_matrix(data_ipsl_CMIP6$FEISTY$fut126$fishvar)
data_ipsl_CMIP6$FEISTY$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP6$FEISTY$fut585$fishvar)
data_ipsl_CMIP6$FEISTY$diff_2p6<- fliplr_matrix(data_ipsl_CMIP6$FEISTY$diff_2p6)
data_ipsl_CMIP6$FEISTY$diff_8p5<- fliplr_matrix(data_ipsl_CMIP6$FEISTY$diff_8p5)

data_ipsl_CMIP6$EcoTroph$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP6$EcoTroph$hist$fishvar)
data_ipsl_CMIP6$EcoTroph$fut126$fishvar<- fliplr_matrix(data_ipsl_CMIP6$EcoTroph$fut126$fishvar)
data_ipsl_CMIP6$EcoTroph$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP6$EcoTroph$fut585$fishvar)
data_ipsl_CMIP6$EcoTroph$diff_2p6<- fliplr_matrix(data_ipsl_CMIP6$EcoTroph$diff_2p6)
data_ipsl_CMIP6$EcoTroph$diff_8p5<- fliplr_matrix(data_ipsl_CMIP6$EcoTroph$diff_8p5)

data_ipsl_CMIP6$EcoOcean$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP6$EcoOcean$hist$fishvar)
data_ipsl_CMIP6$EcoOcean$fut126$fishvar<- fliplr_matrix(data_ipsl_CMIP6$EcoOcean$fut126$fishvar)
data_ipsl_CMIP6$EcoOcean$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP6$EcoOcean$fut585$fishvar)
data_ipsl_CMIP6$EcoOcean$diff_2p6<- fliplr_matrix(data_ipsl_CMIP6$EcoOcean$diff_2p6)
data_ipsl_CMIP6$EcoOcean$diff_8p5<- fliplr_matrix(data_ipsl_CMIP6$EcoOcean$diff_8p5)

data_ipsl_CMIP6$DBEM$hist$fishvar<- fliplr_matrix(data_ipsl_CMIP6$DBEM$hist$fishvar)
data_ipsl_CMIP6$DBEM$fut126$fishvar<- fliplr_matrix(data_ipsl_CMIP6$DBEM$fut126$fishvar)
data_ipsl_CMIP6$DBEM$fut585$fishvar<- fliplr_matrix(data_ipsl_CMIP6$DBEM$fut585$fishvar)
data_ipsl_CMIP6$DBEM$diff_2p6<- fliplr_matrix(data_ipsl_CMIP6$DBEM$diff_2p6)
data_ipsl_CMIP6$DBEM$diff_8p5<- fliplr_matrix(data_ipsl_CMIP6$DBEM$diff_8p5)


move_hemispheres<- function(data_to_flip){
  temp= data_to_flip
  data_to_flip[1:180,] = temp[181:360,]
  data_to_flip[181:360,] = temp[1:180,]
  data_to_flip
}
  
data_ipsl_CMIP6$EcoOcean$hist$fishvar<- move_hemispheres(data_ipsl_CMIP6$EcoOcean$hist$fishvar)
data_ipsl_CMIP6$EcoOcean$fut126$fishvar<- move_hemispheres(data_ipsl_CMIP6$EcoOcean$fut126$fishvar)
data_ipsl_CMIP6$EcoOcean$fut585$fishvar<- move_hemispheres(data_ipsl_CMIP6$EcoOcean$fut585$fishvar)
data_ipsl_CMIP6$EcoOcean$diff_2p6<- move_hemispheres(data_ipsl_CMIP6$EcoOcean$diff_2p6)
data_ipsl_CMIP6$EcoOcean$diff_8p5<- move_hemispheres(data_ipsl_CMIP6$EcoOcean$diff_8p5)

map_ipsl585_CMIP6<-list()
names(data_ipsl_CMIP6)

model_type_ipsl<-ifelse(names(data_ipsl_CMIP6) == "DBEM","DBEM", NA) # this is because DBEM need to be plotted in 0.5 deg

for (i in 1:length(data_ipsl_CMIP6)){ 

  tit <- paste(names(data_ipsl_CMIP6)[i], "IPSL RCP8.5 no-fishing percentage change", variable_to_extract[1], data_ipsl_CMIP6[[i]]$hist$data_units, cmip[2], sep =" ")
  map_ipsl585_CMIP6[[i]]<-plot_FISH_MIP(data_ipsl_CMIP6[[i]]$diff_8p5, tit, delta_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n Change \n (%)", model_type = model_type_ipsl[i])
  names(map_ipsl585_CMIP6)[[i]]<-names(data_ipsl_CMIP6)[[i]]
  
  rm(tit)
  
}

names(map_ipsl585_CMIP6)
map_ipsl585_CMIP6$DBPM

# plot GFDL ----

data_gfdl_CMIP6$MACROECOLOGICAL$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP6$MACROECOLOGICAL$hist$fishvar)
data_gfdl_CMIP6$MACROECOLOGICAL$fut126$fishvar<- fliplr_matrix(data_gfdl_CMIP6$MACROECOLOGICAL$fut126$fishvar)
data_gfdl_CMIP6$MACROECOLOGICAL$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP6$MACROECOLOGICAL$fut585$fishvar)
data_gfdl_CMIP6$MACROECOLOGICAL$diff_2p6<- fliplr_matrix(data_gfdl_CMIP6$MACROECOLOGICAL$diff_2p6)
data_gfdl_CMIP6$MACROECOLOGICAL$diff_8p5<- fliplr_matrix(data_gfdl_CMIP6$MACROECOLOGICAL$diff_8p5)

data_gfdl_CMIP6$ZooMSS$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP6$ZooMSS$hist$fishvar)
data_gfdl_CMIP6$ZooMSS$fut126$fishvar<- fliplr_matrix(data_gfdl_CMIP6$ZooMSS$fut126$fishvar)
data_gfdl_CMIP6$ZooMSS$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP6$ZooMSS$fut585$fishvar)
data_gfdl_CMIP6$ZooMSS$diff_2p6<- fliplr_matrix(data_gfdl_CMIP6$ZooMSS$diff_2p6)
data_gfdl_CMIP6$ZooMSS$diff_8p5<- fliplr_matrix(data_gfdl_CMIP6$ZooMSS$diff_8p5)

data_gfdl_CMIP6$EcoTroph$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP6$EcoTroph$hist$fishvar)
data_gfdl_CMIP6$EcoTroph$fut126$fishvar<- fliplr_matrix(data_gfdl_CMIP6$EcoTroph$fut126$fishvar)
data_gfdl_CMIP6$EcoTroph$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP6$EcoTroph$fut585$fishvar)
data_gfdl_CMIP6$EcoTroph$diff_2p6<- fliplr_matrix(data_gfdl_CMIP6$EcoTroph$diff_2p6)
data_gfdl_CMIP6$EcoTroph$diff_8p5<- fliplr_matrix(data_gfdl_CMIP6$EcoTroph$diff_8p5)

data_gfdl_CMIP6$EcoOcean$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP6$EcoOcean$hist$fishvar)
data_gfdl_CMIP6$EcoOcean$fut126$fishvar<- fliplr_matrix(data_gfdl_CMIP6$EcoOcean$fut126$fishvar)
data_gfdl_CMIP6$EcoOcean$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP6$EcoOcean$fut585$fishvar)
data_gfdl_CMIP6$EcoOcean$diff_2p6<- fliplr_matrix(data_gfdl_CMIP6$EcoOcean$diff_2p6)
data_gfdl_CMIP6$EcoOcean$diff_8p5<- fliplr_matrix(data_gfdl_CMIP6$EcoOcean$diff_8p5)

data_gfdl_CMIP6$DBEM$hist$fishvar<- fliplr_matrix(data_gfdl_CMIP6$DBEM$hist$fishvar)
data_gfdl_CMIP6$DBEM$fut126$fishvar<- fliplr_matrix(data_gfdl_CMIP6$DBEM$fut126$fishvar)
data_gfdl_CMIP6$DBEM$fut585$fishvar<- fliplr_matrix(data_gfdl_CMIP6$DBEM$fut585$fishvar)
data_gfdl_CMIP6$DBEM$diff_2p6<- fliplr_matrix(data_gfdl_CMIP6$DBEM$diff_2p6)
data_gfdl_CMIP6$DBEM$diff_8p5<- fliplr_matrix(data_gfdl_CMIP6$DBEM$diff_8p5)

# move hemisphere  
data_gfdl_CMIP6$EcoOcean$hist$fishvar<- move_hemispheres(data_gfdl_CMIP6$EcoOcean$hist$fishvar)
data_gfdl_CMIP6$EcoOcean$fut126$fishvar<- move_hemispheres(data_gfdl_CMIP6$EcoOcean$fut126$fishvar)
data_gfdl_CMIP6$EcoOcean$fut585$fishvar<- move_hemispheres(data_gfdl_CMIP6$EcoOcean$fut585$fishvar)
data_gfdl_CMIP6$EcoOcean$diff_2p6<- move_hemispheres(data_gfdl_CMIP6$EcoOcean$diff_2p6)
data_gfdl_CMIP6$EcoOcean$diff_8p5<- move_hemispheres(data_gfdl_CMIP6$EcoOcean$diff_8p5)

map_gfdl585_CMIP6<-list()
names(data_gfdl_CMIP6)

model_type_gfdl<-ifelse(names(data_gfdl_CMIP6) == "DBEM","DBEM", NA) # this is because DBEM need to be plotted in 0.5 deg

names(data_gfdl_CMIP6)

for (i in 1:length(data_gfdl_CMIP6)){ 
  
  tit <- paste(names(data_gfdl_CMIP6)[i], "GFDL RCP8.5 no-fishing percentage change", variable_to_extract[1], data_gfdl_CMIP6[[i]]$hist$data_units, cmip[2], sep =" ")
  map_gfdl585_CMIP6[[i]]<-plot_FISH_MIP(data_gfdl_CMIP6[[i]]$diff_8p5, tit, delta_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n Change \n (%)", model_type = model_type_gfdl[i])
  names(map_gfdl585_CMIP6)[[i]]<-names(data_gfdl_CMIP6)[[i]]
  
  rm(tit)
  
}

names(map_gfdl585_CMIP6)

## RCP 2.6

#IPSL

map_ipsl126_CMIP6<-list()

for (i in 1:length(data_ipsl_CMIP6)){ 

  tit <- paste(names(data_ipsl_CMIP6)[i], "IPSL RCP2.6 no-fishing percentage change", variable_to_extract[1], data_ipsl_CMIP6[[i]]$hist$data_units, cmip[2], sep =" ")
  map_ipsl126_CMIP6[[i]]<-plot_FISH_MIP(data_ipsl_CMIP6[[i]]$diff_2p6, tit, delta_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n Change \n (%)", model_type = model_type_ipsl[i])
  names(map_ipsl126_CMIP6)[[i]]<-names(data_ipsl_CMIP6)[[i]]
  
  rm(tit)
  
}

# GFDL

map_gfdl126_CMIP6<-list()

for (i in 1:length(data_gfdl_CMIP6)){ 

  tit <- paste(names(data_gfdl_CMIP6)[i], "GFDL RCP2.6 no-fishing percentage change", variable_to_extract[1], data_gfdl_CMIP6[[i]]$hist$data_units, cmip[2], sep =" ")
  map_gfdl126_CMIP6[[i]]<-plot_FISH_MIP(data_gfdl_CMIP6[[i]]$diff_2p6, tit, delta_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n Change \n (%)", model_type = model_type_gfdl[i])
  names(map_gfdl126_CMIP6)[[i]]<-names(data_gfdl_CMIP6)[[i]]
  
  rm(tit)
  
}

```

# Deal with model set *2 set of models for main and SI for CMIP6*  

```{r}

set = "full"

if(set == "full"){
  data_gfdl_CMIP6$DBPM<-NULL # need to update when white parallel lines problem is solved, but the code doeas allow for DBPM inclusion now 
}else{
  data_gfdl_CMIP6$DBPM<-NULL
  data_ipsl_CMIP6$ZooMSS<-NULL
  data_gfdl_CMIP6$ZooMSS<-NULL
  data_ipsl_CMIP6$FEISTY<-NULL
  data_gfdl_CMIP6$FEISTY<-NULL
  data_ipsl_CMIP6$EcoTroph<-NULL
  data_gfdl_CMIP6$EcoTroph<-NULL
}

```

# Model average for CMIP6 

```{r}

# RCP 8.5

# # MAKE SURE THAT ALL MATRICES ARE ON ONE DEGREE SCALE - if not see CMIP5 above for DBEM 
lons_to_use = seq(1,719,2)
lats_to_use = seq(1,359,2)

data_ipsl_CMIP6$DBEM$diff_8p5 = data_ipsl_CMIP6$DBEM$diff_8p5[lons_to_use, lats_to_use] 
data_gfdl_CMIP6$DBEM$diff_8p5 = data_gfdl_CMIP6$DBEM$diff_8p5[lons_to_use, lats_to_use] 

res_ipsl<-model_stat(data_ipsl_CMIP6, esm = 'diff_8p5')
model_average_ipsl_CMIP6<-res_ipsl$model_average
model_sd_ipsl_CMIP6<-res_ipsl$model_sd
model_agreement_ipsl_CMIP6<- res_ipsl$model_agreement

res_gfdl<-model_stat(data_gfdl_CMIP6, esm = 'diff_8p5')
model_average_gfdl_CMIP6<-res_gfdl$model_average
model_sd_gfdl_CMIP6<-res_gfdl$model_sd
model_agreement_gfdl_CMIP6<- res_gfdl$model_agreement

res_all<-model_stat(c(data_ipsl_CMIP6, data_gfdl_CMIP6), esm = 'diff_8p5')
model_average_all_CMIP6<-res_all$model_average
model_sd_all_CMIP6<-res_all$model_sd
model_agreement_all_CMIP6<- res_all$model_agreement

# define title All
maptitle_average = paste("Mean % change RCP 8.5, 1990s to 2090s CMIP6", sep=" ")
maptitle_sd = paste("Standard Deviation RCP 8.5, 1990s to 2090s CMIP6", sep=" ")
maptitle_agreement = paste("Agreement RCP 8.5, 1990s to 2090s CMIP6", sep=" ")

# Plot the model average and standard deviation

# NEED CONTOURS X 3 plots below bt average only

avarage_CMIP6_all<-plot_FISH_MIP(model_average_all_CMIP6, maptitle_average, mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")
sd_CMIP6_all<-plot_FISH_MIP(model_sd_all_CMIP6, maptitle_sd, sd_plot_colour_values,colour_scheme = colour_scheme1, coltitle = "Variability  \n (SD)")
agreement_CMIP6_all<-plot_FISH_MIP(model_agreement_all_CMIP6, maptitle_agreement, model_agreement_plot_colour_values ,colour_scheme = colour_scheme1, coltitle = "Model \n agreement \n (%)") 

# plot average by esm 
avarage_CMIP6_ipsl<-plot_FISH_MIP(model_average_ipsl_CMIP6, "Mean % change RCP 8.5, 1990s to 2090s CMIP6 IPSL", mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")
avarage_CMIP6_gfdl<-plot_FISH_MIP(model_average_gfdl_CMIP6, "Mean % change RCP 8.5, 1990s to 2090s CMIP6 GFDL", mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")

# RCP 2.6 

data_ipsl_CMIP6$DBEM$diff_2p6 = data_ipsl_CMIP6$DBEM$diff_2p6[lons_to_use, lats_to_use] 
data_gfdl_CMIP6$DBEM$diff_2p6 = data_gfdl_CMIP6$DBEM$diff_2p6[lons_to_use, lats_to_use] 

# model average - see model_stat() in HelperScripts.R

res_ipsl_126<-model_stat(data_ipsl_CMIP6, esm = 'diff_2p6')
model_average_ipsl_CMIP6_126<-res_ipsl_126$model_average
model_sd_ipsl_CMIP6_126<-res_ipsl_126$model_sd
model_agreement_ipsl_CMIP6_126<- res_ipsl_126$model_agreement

res_gfdl_126<-model_stat(data_gfdl_CMIP6, esm = 'diff_2p6')
model_average_gfdl_CMIP6_126<-res_gfdl_126$model_average
model_sd_gfdl_CMIP6_126<-res_gfdl_126$model_sd
model_agreement_gfdl_CMIP6_126<- res_gfdl_126$model_agreement

res_all_126<-model_stat(c(data_ipsl_CMIP6, data_gfdl_CMIP6), esm = 'diff_2p6')
model_average_all_CMIP6_126<-res_all_126$model_average
model_sd_all_CMIP6_126<-res_all_126$model_sd
model_agreement_all_CMIP6_126<- res_all_126$model_agreement 

# define title All
maptitle_average = paste("Mean % change RCP 2.6, 1990s to 2090s CMIP6", sep=" ")
maptitle_sd = paste("Standard Deviation RCP 2.6, 1990s to 2090s CMIP6", sep=" ")
maptitle_agreement = paste("Agreement RCP 2.6, 1990s to 2090s CMIP6", sep=" ")

# Plot the model average and standard deviation

# NEED CONTOURS X 3 plots below 

avarage_CMIP6_all_126<-plot_FISH_MIP(model_average_all_CMIP6, maptitle_average, mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")
sd_CMIP6_all_126<-plot_FISH_MIP(model_sd_all_CMIP6, maptitle_sd, sd_plot_colour_values,colour_scheme = colour_scheme1, coltitle = "Variability  \n (SD)")
agreement_CMIP6_all_126<-plot_FISH_MIP(model_agreement_all_CMIP6, maptitle_agreement, model_agreement_plot_colour_values ,colour_scheme = colour_scheme1, coltitle = "Model \n agreement \n (%)")

# plot average by esm 
avarage_CMIP6_ipsl_126<-plot_FISH_MIP(model_average_ipsl_CMIP6, "Mean % change RCP 2.6, 1990s to 2090s CMIP6 IPSL", mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")
avarage_CMIP6_gfdl_126<-plot_FISH_MIP(model_average_gfdl_CMIP6, "Mean % change RCP 2.6, 1990s to 2090s CMIP6 GFDL", mean_plot_colour_values, colour_scheme = colour_scheme2, coltitle = "Biomass \n change \n (%)")

```

# save outputs ISIMIP3b temp 

```{r}

data_summaries_CMIP6<-list(res_all= res_all, res_ipsl = res_ipsl, res_gfdl = res_gfdl, res_all_126= res_all_126, res_ipsl_126 = res_ipsl_126, res_gfdl_126 = res_gfdl_126)

map_summaries_CMIP6<-list(avarage_CMIP6_all = avarage_CMIP6_all, sd_CMIP6_all = sd_CMIP6_all, agreement_CMIP6_all = agreement_CMIP6_all, avarage_CMIP6_ipsl = avarage_CMIP6_ipsl, avarage_CMIP6_gfdl = avarage_CMIP6_gfdl, avarage_CMIP6_all_126 = avarage_CMIP6_all_126, sd_CMIP6_all_126 = sd_CMIP6_all_126, agreement_CMIP6_all_126 = agreement_CMIP6_all_126, avarage_CMIP6_ipsl_126 = avarage_CMIP6_ipsl_126, avarage_CMIP6_gfdl_126 = avarage_CMIP6_gfdl_126)

# 2 datasets: 1 complete (ALL MODELS), and 1 reduced (Lotze et al. set) 

if(set == "full"){
  save(data_ipsl_CMIP6, data_gfdl_CMIP6, map_ipsl585_CMIP6, map_gfdl585_CMIP6, map_ipsl126_CMIP6, map_gfdl126_CMIP6, data_summaries_CMIP6, map_summaries_CMIP6, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIP6.RData")
}else{
  save(data_ipsl_CMIP6, data_gfdl_CMIP6, map_ipsl585_CMIP6, map_gfdl585_CMIP6, data_summaries_CMIP6, map_summaries_CMIP6, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIP6_reducedModelSet.RData")
}

```


# load data *2 set of models*

```{r}

rm(list=ls())

# 2 datasets: 1 complete (ALL MODELS), and 1 reduced (Lotze et al. set)

set = "full"

if(set == "full"){
  load("/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIP5.RData")
  load("/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIP6.RData")
}else{
  load("/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIP5_reducedModelSet.RData")
  load("/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIP6_reducedModelSet.RData")
}

```

# Load libraries for netcdf and define variables

```{r load CMIP5}

library(grid)
library(zoo)
library(viridis)
library(tidyr)
library(dplyr)

source("/Users/camillan/R-projects/CMIP5vsCMIP6/R/HelperScripts.r")
source("/Users/camillan/R-projects/CMIP5vsCMIP6/R/Funcs_maps.r")

# saving outputs location  
save_loc <- "/Users/camillan/Dropbox/CMIP5vsCMIP6/CMIP5vsCMIP6_figs/20210525/"

# variables 
cmip<-c("CMIP5", "CMIP6")
mod_ipsl <- c("APECOSM", "BOATS", "DBEM", "DBPM","EcoOcean", "MACROECOLOGICAL")
mod_gfdl <- c("BOATS", "DBEM", "EcoOcean", "MACROECOLOGICAL")
protocol <- c("picontrol","historical", "future")
future<-c("SSP126", "SSP585")
variable_to_extract <-c("tcb","tpb", "bp30cm", "bp30to90cm", "bp90cm")

```

# load libraries for plotting and define criteria 

```{r}

# Define color/legend limits 
main_plot_colour_values = c(0,10000) # these need to change for each model? 
delta_plot_colour_values = c(-50,50)
model_agreement_plot_colour_values = c(50,100)

# define a color scheme 
colour_scheme1 <- c(low = 'white', mid = "skyblue1",  high = 'royalblue1') # for statistics - e.g model mean, SD and agreement
colour_scheme2 <- c(low = 'red', mid = "white",  high = 'royalBlue1') # for % changes - either increasing or decreasing 
colour_scheme3 <- c(low = "#fdb863", mid = "#f7f7f7", high = "#b2abd2") # for delta plots (between cmips change) # purple to green shades
colour_scheme4 <- c(low = '#e0ecf4', mid = "#9ebcda",  high = '#8856a7') # for inputs values # shades of blue to purple?? 

# Download and process world outline
library(sf)
library(rnaturalearth)
library("rgeos")
world <- ne_countries(scale = "medium", returnclass = "sf")
robCRS <- CRS("+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")
world_sf <- st_transform(world, crs = st_crs(robCRS)) # Convert to different CRS

```

# Delta plot 

```{r}

# DELTA MAP 
delta_map_data_all<-data_summaries_CMIP6$res_all$model_average - data_summaries_CMIP5$res_all$model_average
maptitle_detla<-"Delta (CMIP6 change - CMIP5 change)"

# NEED CONTOURS X 3 plots below 

delta_map_all_difference<-plot_FISH_MIP(delta_map_data_all, maptitle_detla, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5) 
# if (+1) - (+5) = -4 # CMIP6 decreased 4 times
# if (+1) - (-5) = 6 # CMIP6 increased 6 times 
# if (-1) - (+5) = -6 # CMIP6 decreased 6 times 
# if (-1) - (-5) = 4 # CMIP6 increased 4 times 

delta_map_data_ipsl<-data_summaries_CMIP6$res_ipsl$model_average - data_summaries_CMIP5$res_ipsl$model_average
maptitle_detla<-"Delta IPSL (CMIP6 change - CMIP5 change)"
delta_map_ipsl_difference<-plot_FISH_MIP(delta_map_data_ipsl, maptitle_detla, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5) 

delta_map_data_gfdl<-data_summaries_CMIP6$res_gfdl$model_average - data_summaries_CMIP5$res_gfdl$model_average
maptitle_detla<-"Delta GFDL (CMIP6 change - CMIP5 change)"
delta_map_gfdl_difference<-plot_FISH_MIP(delta_map_data_gfdl, maptitle_detla, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5) 

## RCP 2.6

# DELTA MAPS 
delta_map_data_all_126<-data_summaries_CMIP6$res_all_126$model_average - data_summaries_CMIP5$res_all_126$model_average
maptitle_detla_126<-"Delta (CMIP6 change - CMIP5 change) RCP 2.6"

# NEED CONTOURS X 3 plots below 

delta_map_all_difference_126<-plot_FISH_MIP(delta_map_data_all_126, maptitle_detla_126, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5) 

delta_map_data_ipsl_126<-data_summaries_CMIP6$res_ipsl_126$model_average - data_summaries_CMIP5$res_ipsl_126$model_average
maptitle_detla<-"Delta IPSL (CMIP6 change - CMIP5 change) RCP 2.6"
delta_map_ipsl_difference_126<-plot_FISH_MIP(delta_map_data_ipsl_126, maptitle_detla_126, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5) 

delta_map_data_gfdl_126<-data_summaries_CMIP6$res_gfdl_126$model_average - data_summaries_CMIP5$res_gfdl_126$model_average
maptitle_detla<-"Delta GFDL (CMIP6 change - CMIP5 change) RCP 2.6"
delta_map_gfdl_difference_126<-plot_FISH_MIP(delta_map_data_gfdl_126, maptitle_detla_126, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5) 

```

# flip sign plot 

```{r}

# highlights cells that have switched sign from CMIP5 to CMIP6

flip_sign<-function(temp, temp1){

  # find celles where the sign is the same 
  temp2B<-temp*temp1
  temp2B<-ifelse(temp2B<0, NA, 1) # if positive, sign is the same
  
  # consider only same sign in CMIP5 and CMIP6 matrices
  tempB<-temp*temp2B
  temp1B<-temp1*temp2B
  
  # cells that have changed but the sign did not flipp
  data_neutral<-temp1B - tempB 

  # find cells where the sign is opposite
  temp2<-temp*temp1 
  temp2<-ifelse(temp2<0, 1, NA) # if negative, sign flipped 

  # consider only flipped sign in CMIP5 and CMIP6 matrices
  temp<-temp*temp2
  temp1<-temp1*temp2

  # from + to -
  # consider only cells that flipped from + (in cmip5) to - (in cmip6)
  temp_neg<-temp
  temp1_neg<-temp1
  temp_neg<-ifelse(temp_neg<0, NA, temp_neg) 
  temp1_neg<-ifelse(temp1_neg>0, NA, temp1_neg)

  # by how much? # calcualte delta as above 
  data_negative<-temp1_neg - temp_neg # CMIP6 -CMIP5
  
  # from - to +
  # consider only cells that flipped from + (in cmip5) to - (in cmip6)
  temp_pos<-temp
  temp1_pos<-temp1
  temp_pos<-ifelse(temp_pos>0, NA, temp_pos)
  temp1_pos<-ifelse(temp1_pos<0, NA, temp1_pos)

  # by how much? # calcualte delta as above 
  data_positive<-temp1_pos - temp_pos # CMIP6 -CMIP5


  return(list(data_negative = data_negative, data_positive = data_positive, data_neutral = data_neutral))
}

flip_sign_data<-flip_sign(data_summaries_CMIP5$res_all$model_average, data_summaries_CMIP6$res_all$model_average)

# % of cell that change
a<-sum(!is.na(data_summaries_CMIP5$res_all$model_average))
b<-sum(!is.na(flip_sign_data$data_negative))
c<-sum(!is.na(flip_sign_data$data_positive))
d<-sum(!is.na(flip_sign_data$data_neutral))
(b/a)*100 # turned negative 
(c/a)*100 # turned positive
(d/a)*100 # did not change sign  

(b/a)*100 + (c/a)*100 + (d/a)*100 
# not perfect match to 100% .... EXPLORE WHY..... 

# plot
colour_scheme4 <- c(low = "#fc9617", mid = "#fecf95",  high = "#fef4e7")
maptitle_sign_negative<-"Delta for cells that changed from an increase in CMIP5 to a decrease in CMIP6"
map_sign_negative<-plot_FISH_MIP(flip_sign_data$data_negative, maptitle_sign_negative, c(-50, 0), colour_scheme = colour_scheme4, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3) 

colour_scheme5 <- c(low = "#f4f3f9", mid = "#bab4d7",  high = "#8479b7") 
maptitle_sign_positive<-"Delta for cells that changed from a decrease in CMIP5 to an increase in CMIP6"
map_sign_positive<-plot_FISH_MIP(flip_sign_data$data_positive, maptitle_sign_positive, c(0, 50), colour_scheme = colour_scheme5, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3)

# colour_scheme6 <- c(low = "#f4f3f9", mid = "#bab4d7",  high = "#8479b7") 
maptitle_sign_neutral<-"Delta for cells that did not change direction between CMIPs"
map_sign_neutral<-plot_FISH_MIP(flip_sign_data$data_neutral, maptitle_sign_neutral, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5)

# by esm now 
flip_sign_data_ipsl<-flip_sign(data_summaries_CMIP5$res_ipsl$model_average, data_summaries_CMIP6$res_ipsl$model_average)

# % of cell that change
a<-sum(!is.na(data_summaries_CMIP5$res_all$model_average))
b<-sum(!is.na(flip_sign_data_ipsl$data_negative))
c<-sum(!is.na(flip_sign_data_ipsl$data_positive))
d<-sum(!is.na(flip_sign_data_ipsl$data_neutral))
(b/a)*100 # turned negative 
(c/a)*100 # turned positive
(d/a)*100 # did not change sign 

maptitle_sign_negative<-"Delta for cells that changed from an increase in CMIP5 to a decrease in IPSL CMIP6"
map_sign_negative_ipsl<-plot_FISH_MIP(flip_sign_data_ipsl$data_negative, maptitle_sign_negative, c(-50, 0), colour_scheme = colour_scheme4, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3) 

maptitle_sign_positive<-"Delta for cells that changed from a decrease in CMIP5 to an increase in IPSL CMIP6"
map_sign_positive_ipsl<-plot_FISH_MIP(flip_sign_data_ipsl$data_positive, maptitle_sign_positive, c(0, 50), colour_scheme = colour_scheme5, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3)

maptitle_sign_neutral<-"Delta for cells that did not change direction between CMIPs in IPSL"
map_sign_neutral_ipsl<-plot_FISH_MIP(flip_sign_data_ipsl$data_neutral, maptitle_sign_neutral, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5)

flip_sign_data_gfdl<-flip_sign(data_summaries_CMIP5$res_gfdl$model_average, data_summaries_CMIP6$res_gfdl$model_average)

# % of cell that change
a<-sum(!is.na(data_summaries_CMIP5$res_all$model_average))
b<-sum(!is.na(flip_sign_data_gfdl$data_negative))
c<-sum(!is.na(flip_sign_data_gfdl$data_positive))
d<-sum(!is.na(flip_sign_data_gfdl$data_neutral))
(b/a)*100 # turned negative 
(c/a)*100 # turned positive
(d/a)*100 # did not change sign 

maptitle_sign_negative<-"Delta for cells that changed from an increase in CMIP5 to a decrease in GFDL CMIP6"
map_sign_negative_gfdl<-plot_FISH_MIP(flip_sign_data_gfdl$data_negative, maptitle_sign_negative, c(-50, 0), colour_scheme = colour_scheme4, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3) 

maptitle_sign_positive<-"Delta for cells that changed from a decrease in CMIP5 to an increase in GFDL CMIP6"
map_sign_positive_gfdl<-plot_FISH_MIP(flip_sign_data_gfdl$data_positive, maptitle_sign_positive, c(0, 50), colour_scheme = colour_scheme5, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3)

maptitle_sign_neutral<-"Delta for cells that did not change direction between CMIPs in GFDL"
map_sign_neutral_gfdl<-plot_FISH_MIP(flip_sign_data_gfdl$data_neutral, maptitle_sign_neutral, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5)

## RCP 2.6

flip_sign_data_126<-flip_sign(data_summaries_CMIP5$res_all_126$model_average, data_summaries_CMIP6$res_all_126$model_average)

# plot
colour_scheme4 <- c(low = "#fc9617", mid = "#fecf95",  high = "#fef4e7")
map_sign_negative_126<-plot_FISH_MIP(flip_sign_data_126$data_negative, NA, c(-50, 0), colour_scheme = colour_scheme4, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3) 

colour_scheme5 <- c(low = "#f4f3f9", mid = "#bab4d7",  high = "#8479b7") 
map_sign_positive_126<-plot_FISH_MIP(flip_sign_data_126$data_positive, NA, c(0, 50), colour_scheme = colour_scheme5, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3)

map_sign_neutral_126<-plot_FISH_MIP(flip_sign_data_126$data_neutral, NA, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5)

# by esm now 
flip_sign_data_ipsl_126<-flip_sign(data_summaries_CMIP5$res_ipsl_126$model_average, data_summaries_CMIP6$res_ipsl_126$model_average)

map_sign_negative_ipsl_126<-plot_FISH_MIP(flip_sign_data_ipsl_126$data_negative, NA, c(-50, 0), colour_scheme = colour_scheme4, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3) 

map_sign_positive_ipsl_126<-plot_FISH_MIP(flip_sign_data_ipsl_126$data_positive, NA, c(0, 50), colour_scheme = colour_scheme5, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3)

map_sign_neutral_ipsl_126<-plot_FISH_MIP(flip_sign_data_ipsl_126$data_neutral, NA, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5)

flip_sign_data_gfdl_126<-flip_sign(data_summaries_CMIP5$res_gfdl_126$model_average, data_summaries_CMIP6$res_gfdl_126$model_average)

map_sign_negative_gfdl_126<-plot_FISH_MIP(flip_sign_data_gfdl_126$data_negative, NA, c(-50, 0), colour_scheme = colour_scheme4, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3) 

map_sign_positive_gfdl_126<-plot_FISH_MIP(flip_sign_data_gfdl_126$data_positive, NA, c(0, 50), colour_scheme = colour_scheme5, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 3)

map_sign_neutral_gfdl_126<-plot_FISH_MIP(flip_sign_data_gfdl_126$data_neutral, NA, c(-50, 50), colour_scheme = colour_scheme3, coltitle = "Difference \nin (%) \nchange \n", legend_ticks = 5)

```

# save plot data that you have not saved yet 

```{r}

# delta plots and flipped signed figures data 

if(set == "full"){
  save(flip_sign_data,flip_sign_data_ipsl,flip_sign_data_gfdl, flip_sign_data_126,flip_sign_data_ipsl_126,flip_sign_data_gfdl_126, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIPs_deltaFigures.RData")
}else{
  save(flip_sign_data,flip_sign_data_ipsl,flip_sign_data_gfdl,flip_sign_data_126,flip_sign_data_ipsl_126,flip_sign_data_gfdl_126, file = "/Users/camillan/fishmip_outputs/CMIP6vsCMIP5_fig_temp/data_CMIPs_deltaFigures_reducedModelSet.RData")
}

```

# Put all maps together

```{r multipanel plot}

library(patchwork)

# model average CMIP5, model average CMIP6, delta CMIP5 vs CMIP6

layout <- "
AB
CD
EF
"

a <- map_summaries_CMIP5$avarage_CMIP5_all + ggtitle("a) CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b <- map_summaries_CMIP6$avarage_CMIP6_all + ggtitle("b) CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
c <- delta_map_all_difference + ggtitle("c) Change between CMIPs") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d<- map_sign_neutral + ggtitle("d) Same direction of change between CMIPs") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e <- map_sign_positive + ggtitle("e) Shift to positive change") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f <- map_sign_negative + ggtitle("f) Shift to negative change") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-a + b + c + d + e + f + plot_layout(design = layout)

if(set == "full"){
  pdf(paste0(save_loc,"Fig5.pdf"), height=10, width=15) # CONSIDER ALL MODELS
  pt
  dev.off()
}else{
  pdf(paste0(save_loc,"SI/FigS9.pdf"), height=10, width=15) # CONSIDER LOTZE SET
  pt
  dev.off()
}

#### 2.6 scenario

a126 <- map_summaries_CMIP5$avarage_CMIP5_all_126 + ggtitle("a) CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b126 <- map_summaries_CMIP6$avarage_CMIP6_all_126 + ggtitle("b) CMIP6 SSP1-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
c126 <- delta_map_all_difference_126 + ggtitle("c) Change between CMIPs") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d126 <- map_sign_neutral_126 + ggtitle("d) Same direction of change between CMIPs") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e126 <- map_sign_positive_126 + ggtitle("e) Shift to positive change") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f126 <- map_sign_negative_126 + ggtitle("f) Shift to negative change") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-a126 + b126 + c126 + d126 + e126 + f126+ plot_layout(design = layout)

if(set == "full"){
  pdf(paste0(save_loc,"SI/FigS12.pdf"), height=10, width=15) # CONSIDER ALL MODELS
  pt
  dev.off()
}else{
  pdf(paste0(save_loc,"SI/FigS18.pdf"), height=10, width=15) # CONSIDER LOTZE SET
  pt
  dev.off()
}

# model average CMIP5, model average CMIP6, delta CMIP5 vs CMIP6 by ESM 

layout <- "
AB
CD
EF
GH
IJ
KL
"

a2 <- map_summaries_CMIP5$avarage_CMIP5_ipsl + ggtitle("a) CMIP5 IPSL-CM5A-LR RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b2 <- map_summaries_CMIP6$avarage_CMIP6_ipsl + ggtitle("b) CMIP6 IPSL-CM6A-LR SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
c <- map_summaries_CMIP5$avarage_CMIP5_gfdl + ggtitle("c) CMIP5 GFDL-ESM2M RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d <- map_summaries_CMIP6$avarage_CMIP6_gfdl + ggtitle("d) CMIP6 GFDL-ESM4 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e <- delta_map_ipsl_difference + ggtitle("e) Change between CMIPs IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f <- delta_map_gfdl_difference + ggtitle("f) Change between CMIPs GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
g <- map_sign_neutral_ipsl + ggtitle("g) Same direction of change between CMIPs IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
h <- map_sign_neutral_gfdl + ggtitle("h) Same direction of change between CMIPs GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
i <- map_sign_positive_ipsl + ggtitle("i) Shift to positive change IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
j <- map_sign_positive_gfdl + ggtitle("j) Shift to positive change GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
k <- map_sign_negative_ipsl + ggtitle("k) Shift to negative change IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
l <- map_sign_negative_gfdl + ggtitle("l) Shift to negative change GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-a2 + b2 + 
  c + d +
  e + f +
  g + h + 
  i + j + 
  k + l +
  plot_layout(design = layout)


if(set == "full"){
  pdf(paste0(save_loc,"SI/FigS5.pdf"), height=20, width=15) # ALL MODELS
  pt
  dev.off()
}else{
  pdf(paste0(save_loc,"SI/FigS?.pdf"), height=20, width=15) # CONSIDER LOTZE SET
  pt
  dev.off()
}

#### 2.6 scenario

a2126 <- map_summaries_CMIP5$avarage_CMIP5_ipsl_126 + ggtitle("a) CMIP5 IPSL-CM5A-LR RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b2126 <- map_summaries_CMIP6$avarage_CMIP6_ipsl_126 + ggtitle("b) CMIP6 IPSL-CM6A-LR SSP1-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
c126 <- map_summaries_CMIP5$avarage_CMIP5_gfdl_126 + ggtitle("c) CMIP5 GFDL-ESM2M RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d126 <- map_summaries_CMIP6$avarage_CMIP6_gfdl_126 + ggtitle("d) CMIP6 GFDL-ESM4 SSP1-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e126 <- delta_map_ipsl_difference_126 + ggtitle("e) Change between CMIPs IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f126 <- delta_map_gfdl_difference_126 + ggtitle("f) Change between CMIPs GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
g126 <- map_sign_neutral_ipsl_126 + ggtitle("g) Same direction of change between CMIPs IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
h126 <- map_sign_neutral_gfdl_126 + ggtitle("h) Same direction of change between CMIPs GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
i126 <- map_sign_positive_ipsl_126 + ggtitle("i) Shift to positive change IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
j126 <- map_sign_positive_gfdl_126 + ggtitle("j) Shift to positive change GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
k126 <- map_sign_negative_ipsl_126 + ggtitle("k) Shift to negative change IPSL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
l126 <- map_sign_negative_gfdl_126 + ggtitle("l) Shift to negative change GFDL") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-a2126 + b2126 + 
  c126 + d126 +
  e126 + f126 +
  g126 + h126 + 
  i126 + j126 +
  k126 + l126 +
  plot_layout(design = layout)

if(set == "full"){
  pdf(paste0(save_loc,"SI/Fig13.pdf"), height=20, width=15) # ALL MODELS
  pt
  dev.off()
}else{
  pdf(paste0(save_loc,"SI/FigS19.pdf"), height=20, width=15) # SUBSET
  pt
  dev.off()
}

# All protocols models summaries (average, sd and agreement) 

layout <- "
AB
CD
EF
"

c<-map_summaries_CMIP5$sd_CMIP5_all +  ggtitle("c) CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d<-map_summaries_CMIP6$sd_CMIP6_all +  ggtitle("d) CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e<-map_summaries_CMIP5$agreement_CMIP5_all + ggtitle("e) CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f<-map_summaries_CMIP6$agreement_CMIP6_all + ggtitle("f) CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-a + b + # this is same as Fig2 first raw
    c + d +  
    e + f +  
    plot_layout(design = layout)


if(set == "full"){
  pdf(paste0(save_loc,"SI/FigS6.pdf"), height=10, width=15) # ALL MODESL
  pt
  dev.off()
}else{
  pdf(paste0(save_loc,"SI/FigS10.pdf"), height=10, width=15) # SUBSET
  pt
  dev.off()  
}

#### 2.6 scenario

c126<-map_summaries_CMIP5$sd_CMIP5_all_126 +  ggtitle("c) CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d126<-map_summaries_CMIP6$sd_CMIP6_all_126 +  ggtitle("d) CMIP6 SSP1-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e126<-map_summaries_CMIP5$agreement_CMIP5_all_126 + ggtitle("e) CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f126<-map_summaries_CMIP6$agreement_CMIP6_all_126 + ggtitle("f) CMIP6 SSP1-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-a126 + b126 + 
    c126 + d126 +  
    e126 + f126 +  
    plot_layout(design = layout)

if(set == "full"){
  pdf(paste0(save_loc,"SI/FigS16.pdf"), height=10, width=15) # ALL MODELS
  pt
  dev.off()
}else{
  pdf(paste0(save_loc,"SI/FigS20.pdf"), height=10, width=15) # SUBSET
  pt
  dev.off()
}

```

# all models outputs *when ALL MODELS*

```{r}

# all models map of change IPSL spp585 CMIP5 vs CMIP6

if(set == "full"){

layout <- "
AB 
CD
EF
GH
IJ
#K
LM
#N
OP
"

a<-map_ipsl585_CMIP5$APECOSM +  ggtitle("a) APECOSM CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b<-map_ipsl585_CMIP6$APECOSM +  ggtitle("b) APECOSM CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
c<-map_ipsl585_CMIP5$BOATS +  ggtitle("c) BOATS CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d<-map_ipsl585_CMIP6$BOATS +  ggtitle("d) BOATS CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e<-map_ipsl585_CMIP5$DBEM + ggtitle("e) DBEM CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f<-map_ipsl585_CMIP6$DBEM + ggtitle("f) DBEM CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
g <- map_ipsl585_CMIP5$DBPM + ggtitle("g) DBPM CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
h <- map_ipsl585_CMIP6$DBPM + ggtitle("h) DBPM CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
i <- map_ipsl585_CMIP5$EcoOcean + ggtitle("i) EcoOcean CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
j <- map_ipsl585_CMIP6$EcoOcean + ggtitle("j) EcoOcean CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
k <- map_ipsl585_CMIP6$EcoTroph + ggtitle("k) EcoTroph CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
l <- map_ipsl585_CMIP5$MACROECOLOGICAL + ggtitle("l) MACROECOLOGICAL CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
m <- map_ipsl585_CMIP6$MACROECOLOGICAL + ggtitle("m) MACROECOLOGICAL CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
n <- map_ipsl585_CMIP6$FEISTY  + ggtitle("n) FEISTY CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
o<- map_ipsl585_CMIP5$ZooMSS +ggtitle("o) ZooMSS CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
p <- map_ipsl585_CMIP6$ZooMSS  +ggtitle("p) ZooMSS CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-
  a + b + 
  c + d + 
  e + f + 
  g + h + 
  i + j + 
  k + 
  l + m + 
  n + 
  o + p + 
  plot_layout(design = layout)
    
jpeg(paste0(save_loc,"SI/FigS4.jpeg"), height=40, width=30, units ='in', res=300)
pt 
dev.off()

#### 2.6 scenario 

a<-map_ipsl126_CMIP5$APECOSM +  ggtitle("a) APECOSM CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b<-map_ipsl126_CMIP6$APECOSM +  ggtitle("b) APECOSM CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
c<-map_ipsl126_CMIP5$BOATS +  ggtitle("c) BOATS CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d<-map_ipsl126_CMIP6$BOATS +  ggtitle("d) BOATS CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e<-map_ipsl126_CMIP5$DBEM + ggtitle("e) DBEM CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f<-map_ipsl126_CMIP6$DBEM + ggtitle("f) DBEM CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
g <- map_ipsl126_CMIP5$DBPM + ggtitle("g) DBPM CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
h <- map_ipsl126_CMIP6$DBPM + ggtitle("h) DBPM CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
i <- map_ipsl126_CMIP5$EcoOcean + ggtitle("i) EcoOcean CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
j <- map_ipsl126_CMIP6$EcoOcean + ggtitle("j) EcoOcean CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
k <- map_ipsl126_CMIP6$EcoTroph + ggtitle("k) EcoTroph CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
l <- map_ipsl126_CMIP5$MACROECOLOGICAL + ggtitle("l) MACROECOLOGICAL CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
m <- map_ipsl126_CMIP6$MACROECOLOGICAL + ggtitle("m) MACROECOLOGICAL CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
n <- map_ipsl126_CMIP6$FEISTY  + ggtitle("n) FEISTY CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
o<- map_ipsl126_CMIP5$ZooMSS +ggtitle("o) ZooMSS CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
p <- map_ipsl126_CMIP6$ZooMSS  +ggtitle("p) ZooMSS CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-
  a + b + 
  c + d + 
  e + f + 
  g + h + 
  i + j + 
  k + 
  l + m + 
  n + 
  o + p + 
  plot_layout(design = layout)
    
jpeg(paste0(save_loc,"SI/FigS15.jpeg"), height=40, width=30, units ='in', res=300)
pt 
dev.off()

# all models map of change GFDL spp585 CMIP5 vs CMIP6
layout <- "
AB 
CD
EF
#G
HI
#J
KL
"

a<-map_gfdl585_CMIP5$BOATS +  ggtitle("a) BOATS CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b<-map_gfdl585_CMIP6$BOATS +  ggtitle("b) BOATS CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
c<-map_gfdl585_CMIP5$DBEM + ggtitle("c) DBEM CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d<-map_gfdl585_CMIP6$DBEM + ggtitle("d) DBEM CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# g <- map_gfdl585_CMIP5$DBPM + ggtitle("E) DBPM CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# h <- map_gfdl585_CMIP6$DBPM + ggtitle("F) DBPM CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e <- map_gfdl585_CMIP5$EcoOcean + ggtitle("e) EcoOcean CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f <- map_gfdl585_CMIP6$EcoOcean + ggtitle("f) EcoOcean CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
g <- map_gfdl585_CMIP6$EcoTroph + ggtitle("g) EcoTroph CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
h <- map_gfdl585_CMIP5$MACROECOLOGICAL + ggtitle("h) MACROECOLOGICAL CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
i <- map_gfdl585_CMIP6$MACROECOLOGICAL + ggtitle("i) MACROECOLOGICAL CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
j <- map_gfdl585_CMIP6$FEISTY  + ggtitle("j) FEISTY CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
k<- map_gfdl585_CMIP5$ZooMSS +ggtitle("k) ZooMSS CMIP5 RCP8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
l <- map_gfdl585_CMIP6$ZooMSS  +ggtitle("l) ZooMSS CMIP6 SSP5-8.5") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-
  a+ b + 
  c + d + 
  # g + h + 
  e + f + 
  g + 
  h + i +
  j+ 
  k+ l + 
  plot_layout(design = layout)

jpeg(paste0(save_loc,"SI/FigS3.jpeg"), height=35, width=30, units ='in', res=300)
pt
dev.off()

####  2.6 scenario

a<-map_gfdl126_CMIP5$BOATS +  ggtitle("a) BOATS CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
b<-map_gfdl126_CMIP6$BOATS +  ggtitle("b) BOATS CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
c<-map_gfdl126_CMIP5$DBEM + ggtitle("c) DBEM CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
d<-map_gfdl126_CMIP6$DBEM + ggtitle("d) DBEM CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# g <- map_gfdl126_CMIP5$DBPM + ggtitle("E) DBPM CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
# h <- map_gfdl126_CMIP6$DBPM + ggtitle("F) DBPM CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
e <- map_gfdl126_CMIP5$EcoOcean + ggtitle("e) EcoOcean CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
f <- map_gfdl126_CMIP6$EcoOcean + ggtitle("f) EcoOcean CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
g <- map_gfdl126_CMIP6$EcoTroph + ggtitle("g) EcoTroph CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
h <- map_gfdl126_CMIP5$MACROECOLOGICAL + ggtitle("h) MACROECOLOGICAL CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
i <- map_gfdl126_CMIP6$MACROECOLOGICAL + ggtitle("i) MACROECOLOGICAL CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
j <- map_gfdl126_CMIP6$FEISTY  + ggtitle("j) FEISTY CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
k<- map_gfdl126_CMIP5$ZooMSS +ggtitle("k) ZooMSS CMIP5 RCP2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))
l <- map_gfdl126_CMIP6$ZooMSS  +ggtitle("l) ZooMSS CMIP6 SSP5-2.6") + theme(plot.title = element_text(size = 16, face = "bold", hjust = 0))

pt<-
  a+ b +
  c + d + 
  # g + h +
  e + f + 
  g + 
  h + i +
  j+ 
  k+ l + 
  plot_layout(design = layout)

jpeg(paste0(save_loc,"SI/FigS14.jpeg"), height=35, width=30, units ='in', res=300)
pt
dev.off()

}

```

# scatter plot *when ALL MODELS*

```{r}

if(set == "full"){

# pick lat and log
latitude<-data_ipsl_CMIP5$APECOSM$hist$lat 
longitude<-data_ipsl_CMIP5$APECOSM$hist$lon

data<-list(data_ipsl_CMIP5= data_ipsl_CMIP5, data_ipsl_CMIP6 = data_ipsl_CMIP6, data_gfdl_CMIP5 = data_gfdl_CMIP5, data_gfdl_CMIP6 = data_gfdl_CMIP6)

new_data<-list()

for(i in 1:length(data)){
  
  # i =1
  x<- lapply(data[[i]], `[[`, "diff_8p5")
  x<- lapply(x, "colnames<-", latitude)
  x<- lapply(x, "rownames<-", longitude)
  
  # from trends code
  x<-do.call(rbind, lapply(x, as.data.frame)) 
  
  x<-x %>% 
    mutate(model = gsub("[^a-zA-Z]", "", rownames(x)), 
           long = rep(longitude, length(data[[i]])), 
           cmip = 5, 
           earth = "ipsl") %>% 
    gather("lat", "tcb", -c(model, long, cmip, earth))
  
  if(names(data)[i] == "data_ipsl_CMIP5"){
    x$cmip = 5
    x$earth = "ipsl"
  }else if(names(data)[i] == "data_ipsl_CMIP6"){
    x$cmip = 6
    x$earth = "ipsl"
  }else if(names(data)[i] == "data_gfdl_CMIP5"){
    x$cmip = 5
    x$earth = "gfdl"
  }else{
    x$cmip = 6
    x$earth = "gfdl"
  }
  
  new_data[[i]]<-x
  names(new_data)[i]<-names(data)[i]
  
}

# add all together 
all_ipsl<-new_data$data_ipsl_CMIP5 %>% 
  full_join(new_data$data_ipsl_CMIP6) %>% 
  spread(cmip, tcb) %>% 
  `colnames<-`(c("model", "long", "earth","lat", "cmip5", "cmip6")) 

# max and min values of change for each cmip 

# DBEM
# 1. inf values (from where?)
trial<-filter(all_ipsl, model == "DBEM")
trial<-trial %>% mutate(cmip5 = ifelse(is.infinite(cmip5), NA, cmip5),
                        cmip6 = ifelse(is.infinite(cmip6), NA, cmip6))

nrow(trial) # 61616

# 2. even without inf values, huge range of changes 
max(trial$cmip5, na.rm = TRUE)
min(trial$cmip5, na.rm = TRUE)
max(trial$cmip6, na.rm = TRUE)
min(trial$cmip6, na.rm = TRUE)

# 3. some cells did not run in cmip5 but they did in cmip6 and vice versa, this is true for other models too 
trial<-trial %>% 
  mutate(id = ifelse(is.na(cmip5) & !is.na(cmip6), "remove", 
                    ifelse(is.na(cmip6) & !is.na(cmip5), "remove", "keep")),
         lat = as.numeric(lat)) %>% 
  filter(id == "keep")

nrow(trial) #60421
# plots remove 23462 s0 on plots are 36959 grid cells 

# 4. cut at -100% of change 
ggplot(trial, aes(color = lat, x=cmip5, y = cmip6))+
  geom_point(alpha = 0.2)+
  geom_abline(intercept = 0, slope = 1, color = "red", size = 1) +
  scale_y_continuous(name = "Change in biomass (%) CMIP6", limits = c(-200, 200))+
  scale_x_continuous(name = "Change in biomass (%) CMIP5", limits = c(-200, 200))

# other models .... 

mod = "ZooMSS"

trial<-filter(all_ipsl, model == mod)
max(trial$cmip5, na.rm = TRUE)
min(trial$cmip5, na.rm = TRUE)
max(trial$cmip6, na.rm = TRUE)
min(trial$cmip6, na.rm = TRUE)

# some cells have NA values for CMIP5 and not for CMIP6 and vice versa... 
# trial[which(trial$cmip6 > 100),] 

a<-filter(trial, is.na(cmip6), !is.na(cmip5))
nrow(a)
a<-filter(trial, is.na(cmip5), !is.na(cmip6))
nrow(a)

all_ipsl<-all_ipsl %>% 
  mutate(id = ifelse(is.na(cmip5) & !is.na(cmip6), "remove", 
                    ifelse(is.na(cmip6) & !is.na(cmip5), "remove", "keep")),
         lat = as.numeric(lat)) %>% 
  filter(id == "keep")

all_ipsl2<-all_ipsl%>% 
  filter(!model %in% c("FEISTY", "EcoTroph")) 

# scatter plot
a<-ggplot(all_ipsl2, aes(color = lat, x=cmip5, y = cmip6))+
  geom_point(alpha = 0.2)+
  geom_abline(intercept = 0, slope = 1, color = "red", size = 1) +
  scale_y_continuous(name = "Change in biomass (%) CMIP6", limits = c(-200, 1200)) +  
  scale_x_continuous(name = "Change in biomass (%) CMIP5", limits = c(-200, 200))+ 
  theme_bw()+
  theme(text = element_text(size=20),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5),
        panel.grid.minor = element_blank(),

        panel.grid.major = element_blank(),
        panel.border = element_rect(colour = "black"),
        strip.text.x = element_text(face = "bold"))+
  facet_wrap(~model, scale = "free")

# CMIP6 vs latitude 
b<-ggplot(all_ipsl, aes(x=lat, y = cmip6))+
  geom_point(alpha = 0.2)+
  scale_y_continuous(name = "Latitude") + 
  scale_x_continuous(name = "Change in biomass (%) CMIP5")+ 
  theme_bw()+
  theme(text = element_text(size=20),
        axis.title.y = element_text(vjust=0.4, size = 22),
        axis.title.x = element_text(vjust=0.3, size = 22),
        axis.text.x = element_text(angle=90, hjust=0.5),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_rect(colour = "black"),
        strip.text.x = element_text(face = "bold"))+
  facet_wrap(~model, scale = "free")

pdf(paste0(save_loc,"SI/Scatterplot_ipsl.pdf"), height=12, width=15) 
a
dev.off()

pdf(paste0(save_loc,"SI/Scatterplot_ipsl_latitude.pdf"), height=12, width=15)
b
dev.off()

}

```


